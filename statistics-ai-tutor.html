<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±è¨ˆå­¸ AI æ•™å­¸åŠ©ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        /* æš—è‰²ä¸»é¡Œé…è‰²æ–¹æ¡ˆ */
        .glass {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(71, 85, 105, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        .glass-dark {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(51, 65, 85, 0.4);
        }
        
        /* æš—è‰²æ»¾å‹•æ¢ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 3px;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        @keyframes simpleBounce {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }
        
        .animate-bounce-dot {
            animation: simpleBounce 1s ease-in-out infinite;
        }
        
        .animate-bounce-dot:nth-child(1) { animation-delay: 0s; }
        .animate-bounce-dot:nth-child(2) { animation-delay: 0.2s; }
        .animate-bounce-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* é é¢è¼‰å…¥å‹•ç•« */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        /* å‹•ç•«é¡åˆ¥ */
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .animate-fadeInDown {
            animation: fadeInDown 0.6s ease-out;
        }
        
        .animate-slideInLeft {
            animation: slideInLeft 0.6s ease-out;
        }
        
        .animate-slideInRight {
            animation: slideInRight 0.6s ease-out;
        }
        
        .animate-scaleIn {
            animation: scaleIn 0.6s ease-out;
        }
        
        .animate-pulse-slow {
            animation: pulse 3s ease-in-out infinite;
        }
        
        /* å»¶é²å‹•ç•« */
        .animate-delay-100 { animation-delay: 0.1s; }
        .animate-delay-200 { animation-delay: 0.2s; }
        .animate-delay-300 { animation-delay: 0.3s; }
        .animate-delay-400 { animation-delay: 0.4s; }
        .animate-delay-500 { animation-delay: 0.5s; }
        
        /* äº’å‹•å‹•ç•«æ•ˆæœ */
        .btn-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-hover:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-hover:active {
            transform: translateY(0);
        }
        
        /* è¼¸å…¥æ¡†å‹•ç•« */
        .input-focus {
            transition: all 0.3s ease;
        }
        
        .input-focus:focus {
            transform: scale(1.02);
        }
        
        /* ç‚«é…·ç™¼é€æŒ‰éˆ•æ¨£å¼ */
        .send-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 58px;
            position: relative;
            padding: 0 20px;
            font-size: 16px;
            text-transform: uppercase;
            border: 0;
            box-shadow: hsl(210deg 87% 36%) 0px 7px 0px 0px;
            background-color: hsl(210deg 100% 44%);
            border-radius: 12px;
            overflow: hidden;
            transition: 31ms cubic-bezier(.5, .7, .4, 1);
            min-width: 80px;
        }

        .send-btn:before {
            content: attr(alt);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            inset: 0;
            font-size: 15px;
            font-weight: bold;
            color: white;
            letter-spacing: 2px;
            opacity: 1;
        }

        .send-btn:active {
            box-shadow: none;
            transform: translateY(7px);
            transition: 35ms cubic-bezier(.5, .7, .4, 1);
        }

        .send-btn:hover:before {
            transition: all .0s;
            transform: translateY(100%);
            opacity: 0;
        }

        .send-btn i {
            color: white;
            font-size: 15px;
            font-weight: bold;
            letter-spacing: 2px;
            font-style: normal;
            transition: all 2s ease;
            transform: translateY(-20px);
            opacity: 0;
        }

        .send-btn:hover i {
            transition: all .2s ease;
            transform: translateY(0px);
            opacity: 1;
        }

        .send-btn:hover i:nth-child(1) {
            transition-delay: 0.045s;
        }

        .send-btn:hover i:nth-child(2) {
            transition-delay: calc(0.045s * 2);
        }
        
        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: hsl(210deg 87% 36%) 0px 7px 0px 0px;
        }
        
        .send-btn:disabled:hover:before {
            transform: none;
            opacity: 1;
        }
        
        .send-btn:disabled:hover i {
            transform: translateY(-20px);
            opacity: 0;
        }
        
        /* è¨Šæ¯æ°£æ³¡å‹•ç•« */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .message-bubble {
            animation: messageSlideIn 0.4s ease-out;
        }
        
        /* ç°¡åŒ–é™°å½± */
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Markdown æ¨£å¼ */
        .markdown-content {
            line-height: 1.7;
        }
        
        .markdown-content h1, .markdown-content h2, .markdown-content h3, 
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            margin: 1rem 0 0.5rem 0;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.3rem; }
        .markdown-content h3 { font-size: 1.1rem; }
        
        .markdown-content p {
            margin: 0.5rem 0;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .markdown-content ul {
            list-style-type: disc;
        }
        
        .markdown-content ol {
            list-style-type: decimal;
        }
        
        .markdown-content li {
            margin: 0.25rem 0;
            display: list-item;
        }
        
        .markdown-content ul li::marker {
            color: #94a3b8;
            font-size: 1.2em;
        }
        
        .markdown-content ol li::marker {
            color: #94a3b8;
            font-weight: 600;
        }
        
        .markdown-content strong {
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .markdown-content em {
            font-style: italic;
            color: #cbd5e1;
        }
        
        .markdown-content code {
            background: rgba(71, 85, 105, 0.6);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: #fbbf24;
        }
        
        .markdown-content pre {
            background: rgba(30, 41, 59, 0.8);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            overflow-x: auto;
            border: 1px solid rgba(71, 85, 105, 0.4);
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }
        
        .markdown-content blockquote {
            border-left: 3px solid #3b82f6;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #cbd5e1;
            font-style: italic;
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .markdown-content th, .markdown-content td {
            padding: 0.5rem;
            border: 1px solid rgba(71, 85, 105, 0.4);
            text-align: left;
        }
        
        .markdown-content th {
            background: rgba(51, 65, 85, 0.6);
            font-weight: 600;
        }
        
        /* MathJax æ•¸å­¸å…¬å¼æ¨£å¼ */
        .MathJax {
            color: #e2e8f0 !important;
        }
        
        .markdown-content .MathJax_Display {
            margin: 1rem 0 !important;
        }
        
        /* ç¢ºä¿åˆ—è¡¨æ¨£å¼ä¸è¢«è¦†è“‹ */
        .markdown-content ul li {
            list-style: disc outside;
            margin-left: 0;
            padding-left: 0;
        }
        
        .markdown-content ol li {
            list-style: decimal outside;
            margin-left: 0;
            padding-left: 0;
        }
        
        /* ç¢ºä¿åœ¨æš—è‰²ä¸»é¡Œä¸‹é …ç›®ç¬¦è™Ÿå¯è¦‹ */
        .markdown-content ul li::before {
            content: none;
        }
    </style>
    
    <script>
        // MathJax é…ç½® - éœ€è¦åœ¨ MathJax åŠ è¼‰å‰è¨­ç½®
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                processRefs: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                processHtmlClass: 'tex2jax_process',
                ignoreHtmlClass: 'tex2jax_ignore'
            },
            chtml: {
                scale: 1.0,
                minScale: 0.5,
                matchFontHeight: false
            },
            startup: {
                ready: function () {
                    console.log('MathJax is loaded and ready');
                    MathJax.startup.defaultReady();
                }
            }
        };
    </script>
</head>
<body class="min-h-screen bg-cover bg-center bg-no-repeat" 
      style="background-image: url('https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg');">
    
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="fixed inset-0 bg-black/20"></div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-4xl mx-auto">
            
            <!-- æ¨™é¡Œå€åŸŸ -->
            <div class="text-center mb-8 animate-fadeInDown">
                <div class="glass rounded-3xl p-8 mb-6 card-shadow animate-scaleIn animate-delay-200">
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-100 mb-4 animate-pulse-slow">
                        ğŸ“Š AI æ•™å­¸åŠ©ç†
                    </h1>
                    <p class="text-lg text-slate-300 font-light animate-fadeInUp animate-delay-400">
                        æ‚¨çš„å°ˆæ¥­çµ±è¨ˆå­¸ç¿’å¤¥ä¼´ï¼Œéš¨æ™‚ç‚ºæ‚¨è§£ç­”çµ±è¨ˆå­¸ç›¸é—œå•é¡Œ
                    </p>
                    <!-- å°èˆªæŒ‰éˆ• -->
                    <div class="mt-6 flex gap-4 justify-center animate-fadeInUp animate-delay-500">
                        <a href="/practice.html" class="glass-dark px-6 py-3 rounded-xl text-slate-200 hover:bg-blue-600 transition-all transform hover:scale-105 font-medium shadow-lg">
                            ğŸ“š ç·´ç¿’ç³»çµ±
                        </a>
                        <a href="/" class="glass-dark px-6 py-3 rounded-xl text-slate-200 hover:bg-purple-600 transition-all transform hover:scale-105 font-medium shadow-lg">
                            ğŸ’¬ AI å°è©±
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- ä¸»èŠå¤©ç•Œé¢ -->
            <div class="glass rounded-3xl card-shadow overflow-hidden animate-fadeInUp animate-delay-300">
                
                <!-- èŠå¤©å€åŸŸ -->
                <div class="h-96 md:h-[500px] flex flex-col">
                    
                    <!-- è¨Šæ¯å®¹å™¨ -->
                    <div id="messages" class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                        
                        <!-- æ­¡è¿è¨Šæ¯ -->
                        <div class="text-center py-8" id="welcomeSection">
                            <div class="glass-dark rounded-2xl p-6 mb-6 mx-auto max-w-md animate-scaleIn animate-delay-500">
                                <div class="text-2xl mb-3 animate-pulse-slow">ğŸ‘‹</div>
                                <p class="text-slate-200 leading-relaxed animate-fadeInUp animate-delay-600">
                                    æ­¡è¿ä½¿ç”¨çµ±è¨ˆå­¸ AI æ•™å­¸åŠ©ç†ï¼<br>
                                    æˆ‘å¯ä»¥å¹«åŠ©æ‚¨è§£ç­”çµ±è¨ˆå­¸ç›¸é—œçš„å•é¡Œï¼ŒåŒ…æ‹¬æè¿°çµ±è¨ˆã€æ¨è«–çµ±è¨ˆã€å‡è¨­æª¢å®šç­‰ä¸»é¡Œã€‚
                                </p>
                            </div>
                            
                            <!-- ç”¨æˆ¶ç™»å…¥å€åŸŸ -->
                            <div class="mb-6 animate-fadeInUp animate-delay-600" id="loginSection">
                                <div class="glass-dark rounded-2xl p-6 max-w-md mx-auto">
                                    <h3 class="text-slate-200 text-lg font-medium mb-4 text-center">
                                        ğŸ” ç™»å…¥ä»¥è¿½è¹¤å­¸ç¿’é€²åº¦
                                    </h3>
                                    <div class="space-y-3">
                                        <input type="text" id="usernameInput" placeholder="è¼¸å…¥ç”¨æˆ¶å" 
                                               class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm">
                                        <div class="flex gap-2">
                                            <button onclick="loginUser()" 
                                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors">
                                                ç™»å…¥
                                            </button>
                                            <button onclick="registerUser()" 
                                                    class="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors">
                                                è¨»å†Š
                                            </button>
                                        </div>
                                        <button onclick="continueAsGuest()" 
                                                class="w-full text-slate-400 hover:text-slate-300 text-sm py-2 transition-colors">
                                            ä»¥è¨ªå®¢èº«ä»½ç¹¼çºŒ
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- ç¯„ä¾‹å•é¡Œ -->
                            <div class="grid gap-3 max-w-2xl mx-auto animate-fadeInUp animate-delay-700" id="exampleQuestions" style="display: none;">
                                <h3 class="text-slate-300 text-sm font-medium mb-2 flex items-center justify-center gap-2">
                                    <span class="animate-pulse-slow">ğŸ’¡</span> é»æ“Šä¸‹æ–¹ç¯„ä¾‹é–‹å§‹å°è©±
                                </h3>
                                
                                <div class="grid gap-2 md:grid-cols-2">
                                    <button onclick="askExample('ä»€éº¼æ˜¯æ¨™æº–å·®ï¼Ÿå¦‚ä½•è¨ˆç®—ï¼Ÿ')" 
                                            class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInLeft animate-delay-100">
                                        ä»€éº¼æ˜¯æ¨™æº–å·®ï¼Ÿå¦‚ä½•è¨ˆç®—ï¼Ÿ
                                    </button>
                                    <button onclick="askExample('è«‹è§£é‡‹ä¸­å¤®æ¥µé™å®šç†')" 
                                            class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInRight animate-delay-200">
                                        è«‹è§£é‡‹ä¸­å¤®æ¥µé™å®šç†
                                    </button>
                                    <button onclick="askExample('å¦‚ä½•é€²è¡Œtæª¢å®šï¼Ÿ')" 
                                            class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInLeft animate-delay-300">
                                        å¦‚ä½•é€²è¡Œtæª¢å®šï¼Ÿ
                                    </button>
                                    <button onclick="askExample('ä»€éº¼æ™‚å€™ä½¿ç”¨å¡æ–¹æª¢å®šï¼Ÿ')" 
                                            class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInRight animate-delay-400">
                                        ä»€éº¼æ™‚å€™ä½¿ç”¨å¡æ–¹æª¢å®šï¼Ÿ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¼‰å…¥å‹•ç•« -->
                        <div id="loading" class="hidden flex items-center gap-3 mb-4">
                            <div class="glass-dark rounded-2xl px-6 py-4 flex items-center gap-3">
                                <span class="text-slate-200 text-sm">AI æ­£åœ¨æ€è€ƒä¸­</span>
                                <div class="flex gap-1">
                                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce-dot"></div>
                                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce-dot"></div>
                                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce-dot"></div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- è¼¸å…¥å€åŸŸ -->
                    <div class="p-6 border-t border-slate-600/50">
                        <!-- ç”¨æˆ¶ä¿¡æ¯æ¬„ï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰ -->
                        <div id="userInfoBar" class="hidden mb-4 flex items-center justify-between bg-slate-700/30 rounded-xl p-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                    <span class="text-white text-sm font-bold" id="userAvatar">U</span>
                                </div>
                                <div>
                                    <div class="text-slate-200 text-sm font-medium" id="userDisplayName">ç”¨æˆ¶</div>
                                    <div class="text-slate-400 text-xs" id="userStatus">å·²ç™»å…¥</div>
                                </div>
                            </div>
                            <button onclick="logoutUser()" 
                                    class="px-3 py-1.5 bg-slate-600 hover:bg-slate-500 text-slate-200 text-xs rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-slate-400">
                                ç™»å‡º
                            </button>
                        </div>
                        
                        <div class="flex gap-3 items-center">
                            <div class="flex-1">
                                <input type="text" 
                                       id="messageInput"
                                       placeholder="è«‹è¼¸å…¥æ‚¨çš„çµ±è¨ˆå­¸å•é¡Œ..."
                                       class="w-full px-6 py-4 bg-slate-700/50 border border-slate-600/60 rounded-2xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent input-focus"
                                       onkeypress="handleKeyPress(event)">
                            </div>
                            <button id="sendButton" 
                                    onclick="sendMessage()"
                                    alt="ç™¼é€"
                                    class="send-btn focus:outline-none">
                                <i>ç™¼</i>
                                <i>é€</i>
                            </button>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- åº•éƒ¨ä¿¡æ¯ -->
            <div class="text-center mt-6 animate-fadeInUp animate-delay-500">
                <p class="text-slate-400 text-sm animate-pulse-slow">
                    ç”± AI æŠ€è¡“é©…å‹• â€¢ å°ˆæ¥­çµ±è¨ˆå­¸æ•™å­¸åŠ©ç†
                </p>
            </div>
            
        </div>
    </div>

    <script>
        // API é…ç½®
        const API_BASE_URL = window.location.origin + '/api';
        
        // DOM å…ƒç´ 
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const loadingElement = document.getElementById('loading');
        const welcomeSection = document.getElementById('welcomeSection');
        
        // æ‡‰ç”¨ç‹€æ…‹
        let currentUser = null;
        let currentSessionId = null;
        let isLoggedIn = false;

        // ç”¨æˆ¶ç®¡ç†å‡½æ•¸
        async function loginUser() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('è«‹è¼¸å…¥ç”¨æˆ¶å');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    isLoggedIn = true;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showChatInterface();
                    addMessage(`æ­¡è¿å›ä¾†ï¼Œ${currentUser.username}ï¼æ‚¨çš„å­¸ç¿’é€²åº¦å°‡è¢«è¨˜éŒ„ã€‚`);
                } else {
                    console.error('ç™»å…¥å¤±æ•—:', data.error);
                    alert(data.error || 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                alert('ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function registerUser() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('è«‹è¼¸å…¥ç”¨æˆ¶å');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    isLoggedIn = true;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showChatInterface();
                    addMessage(`æ­¡è¿ï¼Œ${currentUser.username}ï¼æ‚¨çš„å¸³æˆ¶å·²å‰µå»ºï¼Œå­¸ç¿’é€²åº¦å°‡è¢«è¿½è¹¤ã€‚`);
                } else {
                    console.error('è¨»å†Šå¤±æ•—:', data.error);
                    alert(data.error || 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                alert('è¨»å†Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        function continueAsGuest() {
            isLoggedIn = false;
            currentUser = null;
            
            // é¡¯ç¤ºèŠå¤©ç•Œé¢ä½†ä¸é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯æ¬„
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('exampleQuestions').style.display = 'block';
            hideUserInfo();
            
            // å‰µå»ºæœƒè©±
            createChatSession();
            
            addMessage('æ‚¨æ­£ä»¥è¨ªå®¢èº«ä»½ä½¿ç”¨ï¼Œå­¸ç¿’é€²åº¦å°‡ä¸æœƒè¢«ä¿å­˜ã€‚');
        }

        function showChatInterface() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('exampleQuestions').style.display = 'block';
            
            // é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯æ¬„
            showUserInfo();
            
            // å‰µå»ºæœƒè©±
            createChatSession();
        }

        function showUserInfo() {
            if (currentUser && isLoggedIn) {
                const userInfoBar = document.getElementById('userInfoBar');
                const userDisplayName = document.getElementById('userDisplayName');
                const userAvatar = document.getElementById('userAvatar');
                const userStatus = document.getElementById('userStatus');
                
                userDisplayName.textContent = currentUser.username;
                userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
                userStatus.textContent = 'å·²ç™»å…¥ â€¢ å­¸ç¿’é€²åº¦å·²è¿½è¹¤';
                
                userInfoBar.classList.remove('hidden');
            }
        }

        function hideUserInfo() {
            const userInfoBar = document.getElementById('userInfoBar');
            userInfoBar.classList.add('hidden');
        }

        function logoutUser() {
            // ç¢ºèªç™»å‡º
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿæ‚¨çš„å­¸ç¿’é€²åº¦å·²ä¿å­˜ã€‚')) {
                // æ¸…é™¤ç”¨æˆ¶è³‡æ–™
                currentUser = null;
                isLoggedIn = false;
                currentSessionId = null;
                
                // æ¸…é™¤æœ¬åœ°å­˜å„²
                localStorage.removeItem('currentUser');
                
                // éš±è—ç”¨æˆ¶ä¿¡æ¯æ¬„
                hideUserInfo();
                
                // é‡ç½®åˆ°åˆå§‹ç‹€æ…‹
                resetToInitialState();
                
                // é¡¯ç¤ºç™»å‡ºè¨Šæ¯
                setTimeout(() => {
                    addMessage('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚æ„Ÿè¬ä½¿ç”¨çµ±è¨ˆå­¸ AI æ•™å­¸åŠ©ç†ï¼');
                }, 100);
            }
        }

        function resetToInitialState() {
            // æ¸…é™¤èŠå¤©å€åŸŸ
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            // é‡æ–°å‰µå»ºåˆå§‹çš„æ­¡è¿ç•Œé¢ï¼ˆä½¿ç”¨åŸå§‹çš„ HTML çµæ§‹ï¼‰
            const welcomeHTML = `
                <!-- æ­¡è¿è¨Šæ¯ -->
                <div class="text-center py-8" id="welcomeSection">
                    <div class="glass-dark rounded-2xl p-6 mb-6 mx-auto max-w-md animate-scaleIn animate-delay-500">
                        <div class="text-2xl mb-3 animate-pulse-slow">ğŸ‘‹</div>
                        <p class="text-slate-200 leading-relaxed animate-fadeInUp animate-delay-600">
                            æ­¡è¿ä½¿ç”¨çµ±è¨ˆå­¸ AI æ•™å­¸åŠ©ç†ï¼<br>
                            æˆ‘å¯ä»¥å¹«åŠ©æ‚¨è§£ç­”çµ±è¨ˆå­¸ç›¸é—œçš„å•é¡Œï¼ŒåŒ…æ‹¬æè¿°çµ±è¨ˆã€æ¨è«–çµ±è¨ˆã€å‡è¨­æª¢å®šç­‰ä¸»é¡Œã€‚
                        </p>
                    </div>
                    
                    <!-- ç”¨æˆ¶ç™»å…¥å€åŸŸ -->
                    <div class="mb-6 animate-fadeInUp animate-delay-600" id="loginSection">
                        <div class="glass-dark rounded-2xl p-6 max-w-md mx-auto">
                            <h3 class="text-slate-200 text-lg font-medium mb-4 text-center">
                                ğŸ” ç™»å…¥ä»¥è¿½è¹¤å­¸ç¿’é€²åº¦
                            </h3>
                            <div class="space-y-3">
                                <input type="text" id="usernameInput" placeholder="è¼¸å…¥ç”¨æˆ¶å" 
                                       class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm">
                                <div class="flex gap-2">
                                    <button onclick="loginUser()" 
                                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors">
                                        ç™»å…¥
                                    </button>
                                    <button onclick="registerUser()" 
                                            class="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors">
                                        è¨»å†Š
                                    </button>
                                </div>
                                <button onclick="continueAsGuest()" 
                                        class="w-full text-slate-400 hover:text-slate-300 text-sm py-2 transition-colors">
                                    ä»¥è¨ªå®¢èº«ä»½ç¹¼çºŒ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ç¯„ä¾‹å•é¡Œ -->
                    <div class="grid gap-3 max-w-2xl mx-auto animate-fadeInUp animate-delay-700" id="exampleQuestions" style="display: none;">
                        <h3 class="text-slate-300 text-sm font-medium mb-2 flex items-center justify-center gap-2">
                            <span class="animate-pulse-slow">ğŸ’¡</span> é»æ“Šä¸‹æ–¹ç¯„ä¾‹é–‹å§‹å°è©±
                        </h3>
                        
                        <div class="grid gap-2 md:grid-cols-2">
                            <button onclick="askExample('ä»€éº¼æ˜¯æ¨™æº–å·®ï¼Ÿå¦‚ä½•è¨ˆç®—ï¼Ÿ')" 
                                    class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInLeft animate-delay-100">
                                ä»€éº¼æ˜¯æ¨™æº–å·®ï¼Ÿå¦‚ä½•è¨ˆç®—ï¼Ÿ
                            </button>
                            <button onclick="askExample('è«‹è§£é‡‹ä¸­å¤®æ¥µé™å®šç†')" 
                                    class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInRight animate-delay-200">
                                è«‹è§£é‡‹ä¸­å¤®æ¥µé™å®šç†
                            </button>
                            <button onclick="askExample('å¦‚ä½•é€²è¡Œtæª¢å®šï¼Ÿ')" 
                                    class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInLeft animate-delay-300">
                                å¦‚ä½•é€²è¡Œtæª¢å®šï¼Ÿ
                            </button>
                            <button onclick="askExample('ä»€éº¼æ™‚å€™ä½¿ç”¨å¡æ–¹æª¢å®šï¼Ÿ')" 
                                    class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInRight animate-delay-400">
                                ä»€éº¼æ™‚å€™ä½¿ç”¨å¡æ–¹æª¢å®šï¼Ÿ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.innerHTML = welcomeHTML;
        }

        function showLoginInterface() {
            // éš±è—ç¯„ä¾‹å•é¡Œ
            const exampleQuestions = document.getElementById('exampleQuestions');
            if (exampleQuestions) {
                exampleQuestions.style.display = 'none';
            }
            
            // ç¢ºä¿ç™»å…¥ç•Œé¢åœ¨èŠå¤©è¨˜éŒ„ä¸­é¡¯ç¤º
            // clearChatHistory() å‡½æ•¸å·²ç¶“è™•ç†äº†é€™å€‹é‚è¼¯
        }

        function clearChatHistory() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            // é‡æ–°æ·»åŠ æ­¡è¿å€åŸŸå’Œç™»å…¥ç•Œé¢
            const welcomeSection = document.createElement('div');
            welcomeSection.className = 'text-center py-8';
            welcomeSection.id = 'welcomeSection';
            welcomeSection.innerHTML = `
                <div class="glass-dark rounded-2xl p-6 mb-6 mx-auto max-w-md animate-scaleIn animate-delay-500">
                    <div class="text-2xl mb-3 animate-pulse-slow">ğŸ‘‹</div>
                    <p class="text-slate-200 leading-relaxed animate-fadeInUp animate-delay-600">
                        æ­¡è¿ä½¿ç”¨çµ±è¨ˆå­¸ AI æ•™å­¸åŠ©ç†ï¼<br>
                        æˆ‘å¯ä»¥å¹«åŠ©æ‚¨è§£ç­”çµ±è¨ˆå­¸ç›¸é—œçš„å•é¡Œï¼ŒåŒ…æ‹¬æè¿°çµ±è¨ˆã€æ¨è«–çµ±è¨ˆã€å‡è¨­æª¢å®šç­‰ä¸»é¡Œã€‚
                    </p>
                </div>
                
                <!-- ç”¨æˆ¶ç™»å…¥å€åŸŸ -->
                <div class="mb-6 animate-fadeInUp animate-delay-600" id="loginSection">
                    <div class="glass-dark rounded-2xl p-6 max-w-md mx-auto">
                        <h3 class="text-slate-200 text-lg font-medium mb-4 text-center">
                            ğŸ” ç™»å…¥ä»¥è¿½è¹¤å­¸ç¿’é€²åº¦
                        </h3>
                        <div class="space-y-3">
                            <input type="text" id="usernameInputNew" placeholder="è¼¸å…¥ç”¨æˆ¶å" 
                                   class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
                                   onkeypress="handleLoginKeyPress(event)">
                            <div class="flex gap-2">
                                <button id="loginBtnNew" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors">
                                    ç™»å…¥
                                </button>
                                <button id="registerBtnNew" 
                                        class="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors">
                                    è¨»å†Š
                                </button>
                            </div>
                            <button id="guestBtnNew" 
                                    class="w-full text-slate-400 hover:text-slate-300 text-sm py-2 transition-colors">
                                ä»¥è¨ªå®¢èº«ä»½ç¹¼çºŒ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(welcomeSection);
            
            // ç¶å®šæ–°å‰µå»ºçš„ç™»å…¥ç•Œé¢äº‹ä»¶
            bindLoginEvents();
        }

        function bindLoginEvents() {
            // ç¶å®šç™»å…¥æŒ‰éˆ•äº‹ä»¶
            const loginBtn = document.getElementById('loginBtnNew');
            const registerBtn = document.getElementById('registerBtnNew');
            const guestBtn = document.getElementById('guestBtnNew');
            
            if (loginBtn) {
                loginBtn.addEventListener('click', loginUserFromNew);
            }
            
            if (registerBtn) {
                registerBtn.addEventListener('click', registerUserFromNew);
            }
            
            if (guestBtn) {
                guestBtn.addEventListener('click', continueAsGuest);
            }
        }

        function handleLoginKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loginUserFromNew();
            }
        }

        async function loginUserFromNew() {
            const username = document.getElementById('usernameInputNew').value.trim();
            if (!username) {
                alert('è«‹è¼¸å…¥ç”¨æˆ¶å');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    isLoggedIn = true;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showChatInterface();
                    addMessage(`æ­¡è¿å›ä¾†ï¼Œ${currentUser.username}ï¼æ‚¨çš„å­¸ç¿’é€²åº¦å°‡è¢«è¨˜éŒ„ã€‚`);
                } else {
                    console.error('ç™»å…¥å¤±æ•—:', data.error);
                    alert(data.error || 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                alert('ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function registerUserFromNew() {
            const username = document.getElementById('usernameInputNew').value.trim();
            if (!username) {
                alert('è«‹è¼¸å…¥ç”¨æˆ¶å');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    isLoggedIn = true;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showChatInterface();
                    addMessage(`æ­¡è¿ï¼Œ${currentUser.username}ï¼æ‚¨çš„å¸³æˆ¶å·²å‰µå»ºï¼Œå­¸ç¿’é€²åº¦å°‡è¢«è¿½è¹¤ã€‚`);
                } else {
                    console.error('è¨»å†Šå¤±æ•—:', data.error);
                    alert(data.error || 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                alert('è¨»å†Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function createChatSession() {
            try {
                // ç”Ÿæˆæ–°çš„æœƒè©± ID
                const newSessionId = generateSessionId();
                
                const response = await fetch(`${API_BASE_URL}/chat/session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': newSessionId
                    },
                    body: JSON.stringify({
                        userId: currentUser?.user_id || null
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentSessionId = data.sessionId;
                    console.log('æœƒè©±å‰µå»ºæˆåŠŸ:', currentSessionId);
                } else {
                    console.error('å‰µå»ºæœƒè©±å¤±æ•—:', data.error);
                    // å¦‚æœæœƒè©±å‰µå»ºå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆçš„ ID
                    currentSessionId = newSessionId;
                }
            } catch (error) {
                console.error('å‰µå»ºæœƒè©±éŒ¯èª¤:', error);
                // å¦‚æœç¶²è·¯éŒ¯èª¤ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆçš„ ID
                currentSessionId = generateSessionId();
            }
        }

        function generateSessionId() {
            // ç”Ÿæˆç¬¦åˆ UUID v4 æ ¼å¼çš„ ID
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function askExample(question) {
            messageInput.value = question;
            sendMessage();
        }

        function addMessage(content, isUser = false) {
            // ç§»é™¤æ­¡è¿å€åŸŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (welcomeSection) {
                welcomeSection.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${isUser ? 'flex justify-end' : 'flex justify-start'} message-bubble`;
            
            const bubbleClass = isUser 
                ? 'bg-blue-600/90 text-white ml-auto' 
                : 'glass-dark text-slate-200 mr-auto';
            
            // è™•ç† Markdown å…§å®¹
            let processedContent;
            if (isUser) {
                // ç”¨æˆ¶æ¶ˆæ¯ä¿æŒç´”æ–‡å­—
                processedContent = `<div class="text-sm md:text-base leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</div>`;
            } else {
                // AI å›æ‡‰ä½¿ç”¨ Markdown æ¸²æŸ“ï¼Œä¸¦é è™•ç†æ•¸å­¸å…¬å¼
                let preprocessedContent = preprocessMath(content);
                const markdownHtml = marked.parse(preprocessedContent);
                processedContent = `<div class="text-sm md:text-base markdown-content tex2jax_process">${markdownHtml}</div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="max-w-xs md:max-w-md lg:max-w-lg xl:max-w-xl rounded-2xl px-6 py-4 ${bubbleClass} shadow-sm">
                    ${processedContent}
                </div>
            `;
            
            // å¦‚æœæ˜¯ AI å›æ‡‰ï¼Œé€²è¡Œä»£ç¢¼é«˜äº®å’Œæ•¸å­¸å…¬å¼æ¸²æŸ“
            if (!isUser) {
                // å…ˆæ·»åŠ åˆ° DOM
                messagesContainer.appendChild(messageDiv);
                
                // ä»£ç¢¼é«˜äº®ï¼ˆæª¢æŸ¥ hljs æ˜¯å¦å¯ç”¨ï¼‰
                if (typeof hljs !== 'undefined') {
                    messageDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
                
                // æ•¸å­¸å…¬å¼æ¸²æŸ“ - ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•
                setTimeout(() => {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        window.MathJax.typesetPromise([messageDiv]).then(() => {
                            console.log('MathJax rendered successfully');
                        }).catch((err) => {
                            console.error('MathJax typeset error:', err);
                            // å¦‚æœ MathJax å¤±æ•—ï¼Œå˜—è©¦æ‰‹å‹•è™•ç†
                            fallbackMathRender(messageDiv);
                        });
                    } else {
                        // MathJax é‚„æœªåŠ è¼‰ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ
                        fallbackMathRender(messageDiv);
                    }
                }, 100);
            } else {
                messagesContainer.appendChild(messageDiv);
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // HTML è½‰ç¾©å‡½æ•¸
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // æ•¸å­¸å…¬å¼é è™•ç†å‡½æ•¸
        function preprocessMath(content) {
            // å°‡æ–¹æ‹¬è™ŸåŒ…åœçš„LaTeXå…¬å¼è½‰æ›ç‚ºMathJaxæ¨™æº–æ ¼å¼
            return content.replace(/\[([^\[\]]*\\[^\[\]]*)\]/g, (match, formula) => {
                // æª¢æŸ¥æ˜¯å¦ç¢ºå¯¦åŒ…å«LaTeXèªæ³•
                if (formula.includes('\\')) {
                    return `$$${formula}$$`;
                }
                return match; // å¦‚æœä¸åŒ…å«LaTeXèªæ³•ï¼Œä¿æŒåŸæ¨£
            });
        }

        // å‚™ç”¨æ•¸å­¸å…¬å¼æ¸²æŸ“å‡½æ•¸
        function fallbackMathRender(element) {
            console.log('Using fallback math rendering');
            
            // ç°¡å–®çš„ LaTeX ç¬¦è™Ÿæ›¿æ›
            const mathReplacements = [
                { pattern: /\\frac\{([^}]+)\}\{([^}]+)\}/g, replacement: '<span style="display: inline-block; text-align: center; vertical-align: middle;"><span style="display: block; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px; font-size: 0.9em;">$1</span><span style="display: block; padding-top: 2px; font-size: 0.9em;">$2</span></span>' },
                { pattern: /\\text\{([^}]+)\}/g, replacement: '$1' },
                { pattern: /\\sum/g, replacement: 'âˆ‘' },
                { pattern: /\\sqrt\{([^}]+)\}/g, replacement: 'âˆš($1)' },
                { pattern: /\^2/g, replacement: 'Â²' },
                { pattern: /\^3/g, replacement: 'Â³' },
                { pattern: /\\mu/g, replacement: 'Î¼' },
                { pattern: /\\sigma/g, replacement: 'Ïƒ' },
                { pattern: /\\alpha/g, replacement: 'Î±' },
                { pattern: /\\beta/g, replacement: 'Î²' },
                { pattern: /\\chi/g, replacement: 'Ï‡' },
                { pattern: /\\bar\{([^}]+)\}/g, replacement: '$1Ì„' },
                { pattern: /\\overline\{([^}]+)\}/g, replacement: '$1Ì„' }
            ];
            
            const textNodes = [];
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            textNodes.forEach(textNode => {
                let content = textNode.textContent;
                let hasLaTeX = false;
                
                // æª¢æŸ¥æ˜¯å¦åŒ…å« LaTeX èªæ³•æˆ–æ–¹æ‹¬è™ŸåŒ…åœçš„å…¬å¼
                if (content.includes('\\') || content.includes('^') || content.includes('_') || 
                    /\[.*\\.*\]/.test(content)) {
                    hasLaTeX = true;
                    
                    // è™•ç†æ–¹æ‹¬è™ŸåŒ…åœçš„å…¬å¼
                    content = content.replace(/\[([^\[\]]*\\[^\[\]]*)\]/g, (match, formula) => {
                        // å°æ–¹æ‹¬è™Ÿå…§çš„å…¬å¼é€²è¡Œè™•ç†
                        let processedFormula = formula;
                        mathReplacements.forEach(replacement => {
                            processedFormula = processedFormula.replace(replacement.pattern, replacement.replacement);
                        });
                        
                        // è™•ç†ä¸‹æ¨™å’Œä¸Šæ¨™
                        processedFormula = processedFormula.replace(/_\{([^}]+)\}/g, '<sub>$1</sub>');
                        processedFormula = processedFormula.replace(/_([a-zA-Z0-9])/g, '<sub>$1</sub>');
                        processedFormula = processedFormula.replace(/\^\{([^}]+)\}/g, '<sup>$1</sup>');
                        
                        return `<span style="display: block; margin: 0.5rem 0; text-align: center; font-size: 1.1em; background: rgba(51, 65, 85, 0.3); padding: 0.5rem; border-radius: 0.5rem;">${processedFormula}</span>`;
                    });
                    
                    // è™•ç†å…¶ä»–LaTeXèªæ³•
                    mathReplacements.forEach(replacement => {
                        content = content.replace(replacement.pattern, replacement.replacement);
                    });
                    
                    // è™•ç†ä¸‹æ¨™
                    content = content.replace(/_\{([^}]+)\}/g, '<sub>$1</sub>');
                    content = content.replace(/_([a-zA-Z0-9])/g, '<sub>$1</sub>');
                    
                    // è™•ç†ä¸Šæ¨™
                    content = content.replace(/\^\{([^}]+)\}/g, '<sup>$1</sup>');
                }
                
                if (hasLaTeX && content !== textNode.textContent) {
                    const span = document.createElement('span');
                    span.innerHTML = content;
                    span.style.fontFamily = 'serif';
                    span.style.color = '#e2e8f0';
                    textNode.parentNode.replaceChild(span, textNode);
                }
            });
        }

        function showLoading() {
            loadingElement.classList.remove('hidden');
            loadingElement.classList.add('flex');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideLoading() {
            loadingElement.classList.add('hidden');
            loadingElement.classList.remove('flex');
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
            addMessage(message, true);
            messageInput.value = '';
            
            // ç¦ç”¨ç™¼é€æŒ‰éˆ•å’Œè¼¸å…¥æ¡†
            sendButton.disabled = true;
            messageInput.disabled = true;
            
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            showLoading();

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // å¦‚æœæœ‰æœƒè©± IDï¼Œæ·»åŠ åˆ° headers
                if (currentSessionId) {
                    headers['X-Session-ID'] = currentSessionId;
                }

                const response = await fetch(`${API_BASE_URL}/chat/message`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        message: message,
                        userId: currentUser?.user_id || null
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    hideLoading();
                    addMessage(data.response);
                    
                    // é¡¯ç¤ºæª¢æ¸¬åˆ°çš„æ¦‚å¿µï¼ˆå¦‚æœæœ‰ï¼‰
                    if (data.concepts && data.concepts.length > 0) {
                        console.log('æª¢æ¸¬åˆ°çš„çµ±è¨ˆæ¦‚å¿µ:', data.concepts);
                        showConceptTags(data.concepts);
                    }
                    
                    // æ›´æ–°æœƒè©± IDï¼ˆå¦‚æœè¿”å›äº†æ–°çš„ï¼‰
                    if (data.sessionId) {
                        currentSessionId = data.sessionId;
                    }
                } else {
                    throw new Error(data.error || 'APIå›æ‡‰éŒ¯èª¤');
                }

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                addMessage('æŠ±æ­‰ï¼Œç™¼ç”Ÿäº†éŒ¯èª¤ã€‚è«‹ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤è©³æƒ…ï¼š' + error.message);
            } finally {
                // é‡æ–°å•Ÿç”¨ç™¼é€æŒ‰éˆ•å’Œè¼¸å…¥æ¡†
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // é¡¯ç¤ºæ¦‚å¿µæ¨™ç±¤
        function showConceptTags(concepts) {
            if (concepts.length === 0) return;
            
            const tagsDiv = document.createElement('div');
            tagsDiv.className = 'flex flex-wrap gap-2 mb-4 justify-center';
            
            concepts.forEach(concept => {
                const tag = document.createElement('span');
                tag.className = 'px-3 py-1 bg-blue-600/30 text-blue-200 rounded-full text-xs border border-blue-500/30';
                tag.textContent = `ğŸ“Š ${concept}`;
                tagsDiv.appendChild(tag);
            });
            
            messagesContainer.appendChild(tagsDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', () => {
            // æª¢æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ¶ä¿¡æ¯
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    showChatInterface();
                    addMessage(`æ­¡è¿å›ä¾†ï¼Œ${currentUser.username}ï¼æ‚¨çš„å­¸ç¿’é€²åº¦å°‡ç¹¼çºŒè¢«è¿½è¹¤ã€‚`);
                } catch (error) {
                    console.error('è§£æä¿å­˜çš„ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:', error);
                    localStorage.removeItem('currentUser');
                }
            }
            
            messageInput.focus();
            
            // é…ç½® marked.js
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
            
            // é…ç½® highlight.jsï¼ˆæª¢æŸ¥æ˜¯å¦è¼‰å…¥æˆåŠŸï¼‰
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['javascript', 'python', 'r', 'sql', 'bash', 'json', 'markdown']
                });
                console.log('Highlight.js é…ç½®æˆåŠŸ');
            } else {
                console.warn('Highlight.js æœªè¼‰å…¥ï¼Œå°‡è·³éä»£ç¢¼é«˜äº®åŠŸèƒ½');
            }
            
            // ç­‰å¾… MathJax è¼‰å…¥å®Œæˆ
            setTimeout(() => {
                if (window.MathJax && window.MathJax.startup) {
                    MathJax.startup.promise.then(() => {
                        console.log('MathJax is ready');
                        window.mathJaxReady = true;
                    }).catch((err) => {
                        console.error('MathJax startup error:', err);
                        window.mathJaxReady = false;
                    });
                } else {
                    console.warn('MathJax not loaded, using fallback rendering');
                    window.mathJaxReady = false;
                }
            }, 2000);
        });

        // æš—è‰²ä¸»é¡Œäº’å‹•æ•ˆæœ
        messageInput.addEventListener('focus', () => {
            messageInput.style.borderColor = 'rgb(96, 165, 250)';
        });

        messageInput.addEventListener('blur', () => {
            messageInput.style.borderColor = 'rgba(71, 85, 105, 0.6)';
        });
    </script>
</body>
</html>