<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±è¨ˆå­¸ AI æ•™å­¸åŠ©ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="/i18n.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        /* æš—è‰²ä¸»é¡Œé…è‰²æ–¹æ¡ˆ */
        .glass {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(71, 85, 105, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        .glass-dark {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(51, 65, 85, 0.4);
        }
        
        /* æš—è‰²æ»¾å‹•æ¢ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 3px;
        }

        /* éš±è—æ»¾å‹•æ¢ï¼ˆä»å¯æ»¾å‹•ï¼‰ */
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        /* è¼‰å…¥å‹•ç•« */
        @keyframes simpleBounce {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }
        
        .animate-bounce-dot {
            animation: simpleBounce 1s ease-in-out infinite;
        }
        
        .animate-bounce-dot:nth-child(1) { animation-delay: 0s; }
        .animate-bounce-dot:nth-child(2) { animation-delay: 0.2s; }
        .animate-bounce-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* é é¢è¼‰å…¥å‹•ç•« */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        /* å‹•ç•«é¡åˆ¥ */
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .animate-fadeInDown {
            animation: fadeInDown 0.6s ease-out;
        }
        
        .animate-slideInLeft {
            animation: slideInLeft 0.6s ease-out;
        }
        
        .animate-slideInRight {
            animation: slideInRight 0.6s ease-out;
        }
        
        .animate-scaleIn {
            animation: scaleIn 0.6s ease-out;
        }
        
        .animate-pulse-slow {
            animation: pulse 3s ease-in-out infinite;
        }
        
        /* å»¶é²å‹•ç•« */
        .animate-delay-100 { animation-delay: 0.1s; }
        .animate-delay-200 { animation-delay: 0.2s; }
        .animate-delay-300 { animation-delay: 0.3s; }
        .animate-delay-400 { animation-delay: 0.4s; }
        .animate-delay-500 { animation-delay: 0.5s; }
        
        /* äº’å‹•å‹•ç•«æ•ˆæœ */
        .btn-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-hover:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-hover:active {
            transform: translateY(0);
        }
        
        /* è¼¸å…¥æ¡†å‹•ç•« */
        .input-focus {
            transition: all 0.3s ease;
        }
        
        .input-focus:focus {
            transform: scale(1.02);
        }
        
        /* ç‚«é…·ç™¼é€æŒ‰éˆ•æ¨£å¼ */
        .send-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 58px;
            position: relative;
            padding: 0 20px;
            font-size: 16px;
            text-transform: uppercase;
            border: 0;
            box-shadow: hsl(210deg 87% 36%) 0px 7px 0px 0px;
            background-color: hsl(210deg 100% 44%);
            border-radius: 12px;
            overflow: hidden;
            transition: 31ms cubic-bezier(.5, .7, .4, 1);
            min-width: 80px;
        }

        .send-btn:before {
            content: attr(alt);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            inset: 0;
            font-size: 15px;
            font-weight: bold;
            color: white;
            letter-spacing: 2px;
            opacity: 1;
        }

        .send-btn:active {
            box-shadow: none;
            transform: translateY(7px);
            transition: 35ms cubic-bezier(.5, .7, .4, 1);
        }

        .send-btn:hover:before {
            transition: all .0s;
            transform: translateY(100%);
            opacity: 0;
        }

        .send-btn i {
            color: white;
            font-size: 15px;
            font-weight: bold;
            letter-spacing: 2px;
            font-style: normal;
            transition: all 2s ease;
            transform: translateY(-20px);
            opacity: 0;
        }

        .send-btn:hover i {
            transition: all .2s ease;
            transform: translateY(0px);
            opacity: 1;
        }

        .send-btn:hover i:nth-child(1) {
            transition-delay: 0.045s;
        }

        .send-btn:hover i:nth-child(2) {
            transition-delay: calc(0.045s * 2);
        }
        
        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: hsl(210deg 87% 36%) 0px 7px 0px 0px;
        }
        
        .send-btn:disabled:hover:before {
            transform: none;
            opacity: 1;
        }
        
        .send-btn:disabled:hover i {
            transform: translateY(-20px);
            opacity: 0;
        }
        
        /* è¨Šæ¯æ°£æ³¡å‹•ç•« */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .message-bubble {
            animation: messageSlideIn 0.4s ease-out;
        }
        
        /* ç°¡åŒ–é™°å½± */
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Markdown æ¨£å¼ */
        .markdown-content {
            line-height: 1.7;
        }
        
        .markdown-content h1, .markdown-content h2, .markdown-content h3, 
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            margin: 1rem 0 0.5rem 0;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.3rem; }
        .markdown-content h3 { font-size: 1.1rem; }
        
        .markdown-content p {
            margin: 0.5rem 0;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .markdown-content ul {
            list-style-type: disc;
        }
        
        .markdown-content ol {
            list-style-type: decimal;
        }
        
        .markdown-content li {
            margin: 0.25rem 0;
            display: list-item;
        }
        
        .markdown-content ul li::marker {
            color: #94a3b8;
            font-size: 1.2em;
        }
        
        .markdown-content ol li::marker {
            color: #94a3b8;
            font-weight: 600;
        }
        
        .markdown-content strong {
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .markdown-content em {
            font-style: italic;
            color: #cbd5e1;
        }
        
        .markdown-content code {
            background: rgba(71, 85, 105, 0.6);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: #fbbf24;
        }
        
        .markdown-content pre {
            background: rgba(30, 41, 59, 0.8);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            overflow-x: auto;
            border: 1px solid rgba(71, 85, 105, 0.4);
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }
        
        .markdown-content blockquote {
            border-left: 3px solid #3b82f6;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #cbd5e1;
            font-style: italic;
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .markdown-content th, .markdown-content td {
            padding: 0.5rem;
            border: 1px solid rgba(71, 85, 105, 0.4);
            text-align: left;
        }
        
        .markdown-content th {
            background: rgba(51, 65, 85, 0.6);
            font-weight: 600;
        }
        
        /* MathJax æ•¸å­¸å…¬å¼æ¨£å¼ */
        .MathJax {
            color: #e2e8f0 !important;
        }
        
        .markdown-content .MathJax_Display {
            margin: 1rem 0 !important;
        }
        
        /* ç¢ºä¿åˆ—è¡¨æ¨£å¼ä¸è¢«è¦†è“‹ */
        .markdown-content ul li {
            list-style: disc outside;
            margin-left: 0;
            padding-left: 0;
        }
        
        .markdown-content ol li {
            list-style: decimal outside;
            margin-left: 0;
            padding-left: 0;
        }
        
        /* ç¢ºä¿åœ¨æš—è‰²ä¸»é¡Œä¸‹é …ç›®ç¬¦è™Ÿå¯è¦‹ */
        .markdown-content ul li::before {
            content: none;
        }
    </style>
    
    <script>
        // MathJax é…ç½® - éœ€è¦åœ¨ MathJax åŠ è¼‰å‰è¨­ç½®
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                processRefs: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                processHtmlClass: 'tex2jax_process',
                ignoreHtmlClass: 'tex2jax_ignore'
            },
            chtml: {
                scale: 1.0,
                minScale: 0.5,
                matchFontHeight: false
            },
            startup: {
                ready: function () {
                    console.log('MathJax is loaded and ready');
                    MathJax.startup.defaultReady();
                }
            }
        };
    </script>
</head>
<body class="min-h-screen bg-cover bg-center bg-no-repeat" 
      style="background-image: url('https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg');">
    
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="fixed inset-0 bg-black/20"></div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-4xl mx-auto">
            
            <!-- æ¨™é¡Œå€åŸŸ -->
            <div class="text-center mb-8 animate-fadeInDown">
                <div class="glass rounded-3xl p-8 mb-6 card-shadow animate-scaleIn animate-delay-200">
                    <!-- èªè¨€åˆ‡æ›æŒ‰éˆ• -->
                    <div class="flex justify-end mb-4 gap-2">
                        <button id="langToggle" class="glass-dark px-4 py-2 rounded-xl text-slate-200 hover:bg-slate-700/50 transition-all text-sm font-medium flex items-center gap-2">
                            <span id="langIcon">ğŸŒ</span>
                            <span id="langText">ä¸­æ–‡</span>
                        </button>
                        <button id="bgBtn" class="glass-dark px-4 py-2 rounded-xl text-slate-200 hover:bg-slate-700/50 transition-all text-sm font-medium flex items-center gap-2" data-i18n="common.setBackground">
                            ğŸ–¼ï¸ æ›´æ›èƒŒæ™¯
                        </button>
                        <input id="bgInput" type="file" accept="image/*" class="hidden" />
                        <a href="https://docs.google.com/forms/d/e/1FAIpQLSckWpuRV8yzMjRImOvODOxMrhA-urgl5alT4R1MIG8nUV-dgw/viewform?usp=header" target="_blank" class="glass-dark px-4 py-2 rounded-xl text-slate-200 hover:bg-blue-500/50 transition-all text-sm font-medium flex items-center gap-2" data-i18n="common.feedback">
                            ğŸ“ å•é¡Œåé¥‹
                        </a>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-100 mb-4 animate-pulse-slow" data-i18n="title">
                        ğŸ“Š AI æ•™å­¸åŠ©ç†
                    </h1>
                    <p class="text-lg text-slate-300 font-light animate-fadeInUp animate-delay-400" data-i18n="subtitle">
                        æ‚¨çš„å°ˆæ¥­çµ±è¨ˆå­¸ç¿’å¤¥ä¼´ï¼Œéš¨æ™‚ç‚ºæ‚¨è§£ç­”çµ±è¨ˆå­¸ç›¸é—œå•é¡Œ
                    </p>
                    <!-- å°èˆªæŒ‰éˆ• -->
                    <div class="mt-6 flex gap-3 justify-center animate-fadeInUp animate-delay-500 flex-wrap">
                        <a href="/" class="glass-dark px-6 py-3 rounded-xl text-slate-200 hover:bg-purple-600 transition-all transform hover:scale-105 font-medium shadow-lg" data-i18n="navAiChat">
                            ğŸ’¬ AI å°è©±
                        </a>
                        <!-- æš«æ™‚éš±è—é¡Œåº«ç·´ç¿’æŒ‰éˆ• -->
                        <a href="/question-bank.html" class="glass-dark px-6 py-3 rounded-xl text-slate-200 hover:bg-green-600 transition-all transform hover:scale-105 font-medium shadow-lg relative hidden">
                            <span data-i18n="navQuestionBank">ğŸ“– é¡Œåº«ç·´ç¿’</span>
                            <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full" data-i18n="newBadge">New</span>
                        </a>
                        <a href="/practice.html" target="_blank" class="glass-dark px-6 py-3 rounded-xl text-slate-200 hover:bg-blue-600 transition-all transform hover:scale-105 font-medium shadow-lg" data-i18n="navAiPractice">
                            ğŸ¯ AI ç”Ÿæˆç·´ç¿’
                        </a>
                        <a href="/admin.html" id="adminNavBtn" class="glass-dark px-6 py-3 rounded-xl text-slate-200 hover:bg-orange-600 transition-all transform hover:scale-105 font-medium shadow-lg border-2 border-orange-500/50 hidden" data-i18n="navAdmin">
                            ğŸ” ç®¡ç†å“¡æ§åˆ¶å°
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- AI Disclaimer -->
            <div class="glass rounded-2xl p-4 mb-6 animate-fadeInUp animate-delay-400 border-l-4 border-yellow-500/50">
                <p class="text-sm text-yellow-200/90" data-i18n="common.disclaimer">
                    âš ï¸ å…è²¬è²æ˜ï¼šæœ¬ç³»çµ±ä½¿ç”¨ AI æŠ€è¡“ç”Ÿæˆå…§å®¹ï¼Œç­”æ¡ˆæœªå¿…å®Œå…¨æ­£ç¢ºï¼Œè«‹è¬¹æ…åˆ¤æ–·ä¸¦ä»¥æ•™æåŠè€å¸«æ•™å­¸å…§å®¹ç‚ºæº–ã€‚
                </p>
            </div>
            
            <!-- ä¸»èŠå¤©ç•Œé¢ -->
            <div class="glass rounded-3xl card-shadow overflow-hidden animate-fadeInUp animate-delay-300">
                
                <!-- èŠå¤©å€åŸŸ -->
                <div class="h-[600px] md:h-[700px] lg:h-[750px] flex flex-col">
                    
                    <!-- è¨Šæ¯å®¹å™¨ -->
                    <div id="messages" class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                        
                        <!-- æ­¡è¿è¨Šæ¯ -->
                        <div class="text-center py-8" id="welcomeSection">
                            <div class="glass-dark rounded-2xl p-6 mb-6 mx-auto max-w-md animate-scaleIn animate-delay-500">
                                <div class="text-2xl mb-3 animate-pulse-slow">ğŸ‘‹</div>
                                <p class="text-slate-200 leading-relaxed animate-fadeInUp animate-delay-600" data-i18n="welcomeMessage">
                                    æ­¡è¿ä½¿ç”¨çµ±è¨ˆå­¸ AI æ•™å­¸åŠ©ç†ï¼<br>
                                    æˆ‘å¯ä»¥å¹«åŠ©æ‚¨è§£ç­”çµ±è¨ˆå­¸ç›¸é—œçš„å•é¡Œï¼ŒåŒ…æ‹¬æè¿°çµ±è¨ˆã€æ¨è«–çµ±è¨ˆã€å‡è¨­æª¢å®šç­‰ä¸»é¡Œã€‚
                                </p>
                            </div>
                            
                            <!-- ç”¨æˆ¶ç™»å…¥å€åŸŸ -->
                            <div class="mb-6 animate-fadeInUp animate-delay-600" id="loginSection">
                                <div class="glass-dark rounded-2xl p-6 max-w-md mx-auto">
                                    <h3 class="text-slate-200 text-lg font-medium mb-4 text-center" data-i18n="loginTitle">
                                        ğŸ” ç™»å…¥ä»¥è¿½è¹¤å­¸ç¿’é€²åº¦
                                    </h3>
                                    <div class="space-y-3">
                                        <input type="text" id="usernameInput" placeholder="è¼¸å…¥ç”¨æˆ¶å" data-i18n-placeholder="usernamePlaceholder" 
                                               class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
                                               onkeyup="checkAdminUsername()">
                                        <input type="password" id="passwordInput" placeholder="è¼¸å…¥å¯†ç¢¼" data-i18n-placeholder="passwordPlaceholder"
                                               class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm hidden"
                                               onkeypress="handleLoginKeyPress(event)">
                                        <div class="flex gap-2">
                                            <button onclick="loginUser()" 
                                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors" data-i18n="loginBtn">
                                                ç™»å…¥
                                            </button>
                                            <button onclick="registerUser()" 
                                                    class="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors" data-i18n="registerBtn">
                                                è¨»å†Š
                                            </button>
                                        </div>
                                        <button onclick="continueAsGuest()" 
                                                class="w-full text-slate-400 hover:text-slate-300 text-sm py-2 transition-colors" data-i18n="guestBtn">
                                            ä»¥è¨ªå®¢èº«ä»½ç¹¼çºŒ
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- ç¯„ä¾‹å•é¡Œ -->
                            <div class="grid gap-3 max-w-2xl mx-auto animate-fadeInUp animate-delay-700" id="exampleQuestions" style="display: none;">
                                <h3 class="text-slate-300 text-sm font-medium mb-2 flex items-center justify-center gap-2">
                                    <span class="animate-pulse-slow">ğŸ’¡</span> <span data-i18n="exampleTitle">é»æ“Šä¸‹æ–¹ç¯„ä¾‹é–‹å§‹å°è©±</span>
                                </h3>
                                
                                <div class="grid gap-2 md:grid-cols-2">
                                    <button onclick="askExample(this.textContent)" 
                                            class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInLeft animate-delay-100" data-i18n="example1">
                                        ä»€éº¼æ˜¯æ¨™æº–å·®ï¼Ÿå¦‚ä½•è¨ˆç®—ï¼Ÿ
                                    </button>
                                    <button onclick="askExample(this.textContent)" 
                                            class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInRight animate-delay-200" data-i18n="example2">
                                        è«‹è§£é‡‹ä¸­å¤®æ¥µé™å®šç†
                                    </button>
                                    <button onclick="askExample(this.textContent)" 
                                            class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInLeft animate-delay-300" data-i18n="example3">
                                        å¦‚ä½•é€²è¡Œtæª¢å®šï¼Ÿ
                                    </button>
                                    <button onclick="askExample(this.textContent)" 
                                            class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInRight animate-delay-400" data-i18n="example4">
                                        ä»€éº¼æ™‚å€™ä½¿ç”¨å¡æ–¹æª¢å®šï¼Ÿ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- è¼¸å…¥å€åŸŸ -->
                    <div class="p-6 border-t border-slate-600/50">
                        <!-- ç”¨æˆ¶ä¿¡æ¯æ¬„ï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰ -->
                        <div id="userInfoBar" class="hidden mb-4 flex items-center justify-between bg-slate-700/30 rounded-xl p-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                    <span class="text-white text-sm font-bold" id="userAvatar">U</span>
                                </div>
                                <div>
                                    <div class="text-slate-200 text-sm font-medium" id="userDisplayName">ç”¨æˆ¶</div>
                                    <div class="text-slate-400 text-xs" id="userStatus" data-i18n="loggedInStatus">å·²ç™»å…¥</div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="startNewChat()" 
                                        class="px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white text-xs rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-green-400" data-i18n="newChatBtn">
                                    ğŸ”„ æ–°å°è©±
                                </button>
                                <button onclick="logoutUser()" 
                                        class="px-3 py-1.5 bg-slate-600 hover:bg-slate-500 text-slate-200 text-xs rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-slate-400" data-i18n="logoutBtn">
                                    ç™»å‡º
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 items-center">
                            <div class="flex-1">
                                    <textarea
                                       id="messageInput"
                                       rows="1"
                                       placeholder="è«‹è¼¸å…¥æ‚¨çš„çµ±è¨ˆå­¸å•é¡Œ..."
                                       data-i18n-placeholder="inputPlaceholder"
                                        class="w-full px-6 py-4 bg-slate-700/50 border border-slate-600/60 rounded-2xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent input-focus resize-none overflow-y-auto max-h-40 hide-scrollbar"
                                       onkeydown="handleKeyPress(event)"
                                       oninput="autoResizeTextarea(this)"></textarea>
                            </div>
                            <button id="sendButton" 
                                    onclick="sendMessage()"
                                    alt="ç™¼é€"
                                    data-i18n-alt="sendBtn"
                                    class="send-btn focus:outline-none">
                                <i>S</i>
                                <i>E</i>
                                <i>N</i>
                                <i>D</i>
                            </button>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- åº•éƒ¨ä¿¡æ¯ -->
            <div class="text-center mt-6 animate-fadeInUp animate-delay-500">
                <div class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-yellow-500/15 border border-yellow-400/40 text-yellow-200 text-sm font-semibold shadow-sm" data-i18n="common.newChatTip">
                    âš ï¸ è‹¥ AI å‡ºç¾å•é¡Œï¼Œè«‹æŒ‰ New Chat é‡æ–°é–‹å§‹å°è©±ã€‚
                </div>
                <p class="text-slate-400 text-sm animate-pulse-slow mt-3" data-i18n="footer">
                    ç”± AI æŠ€è¡“é©…å‹• â€¢ å°ˆæ¥­çµ±è¨ˆå­¸æ•™å­¸åŠ©ç†
                </p>
            </div>
            
        </div>
    </div>

    <script>
        // API é…ç½®
        const API_BASE_URL = window.location.origin + '/api';

        // ============ Custom Background (Local) ============
        const BG_STORAGE_KEY = 'customBackgroundImage';

        function applyCustomBackgroundFromStorage() {
            const stored = localStorage.getItem(BG_STORAGE_KEY);
            if (stored) {
                document.body.style.backgroundImage = `url('${stored}')`;
            }
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = src;
            });
        }

        async function fileToCompressedDataURL(file) {
            const dataUrl = await readFileAsDataURL(file);
            
            // å¦‚æœåŸåœ–æª”æ¡ˆå°æ–¼ 500KBï¼Œç›´æ¥ä½¿ç”¨åŸåœ–ï¼ˆä¿ç•™æœ€é«˜å“è³ªï¼‰
            if (file.size < 500 * 1024) {
                return dataUrl;
            }
            
            const img = await loadImage(dataUrl);
            const originalW = img.naturalWidth;
            const originalH = img.naturalHeight;

            // åªæœ‰ç•¶åœ–ç‰‡è¶…é 1920Ã—1080 æ™‚æ‰ç¸®å°
            const maxW = 1920;
            const maxH = 1080;
            const needsResize = originalW > maxW || originalH > maxH;
            
            if (!needsResize) {
                // åœ–ç‰‡å°ºå¯¸åˆç†ï¼Œåªè½‰ JPEG æ ¼å¼å£“ç¸®ï¼ˆä¿æŒåŸå°ºå¯¸ï¼‰
                const canvas = document.createElement('canvas');
                canvas.width = originalW;
                canvas.height = originalH;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                return canvas.toDataURL('image/jpeg', 0.9);
            }

            // éœ€è¦ç¸®å°ï¼šæŒ‰æ¯”ä¾‹ç¸®è‡³ 1920Ã—1080 å…§
            const scale = Math.min(maxW / originalW, maxH / originalH);
            const targetW = Math.max(1, Math.round(originalW * scale));
            const targetH = Math.max(1, Math.round(originalH * scale));

            const canvas = document.createElement('canvas');
            canvas.width = targetW;
            canvas.height = targetH;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, targetW, targetH);

            return canvas.toDataURL('image/jpeg', 0.85);
        }

        function initBackgroundPicker() {
            applyCustomBackgroundFromStorage();

            const btn = document.getElementById('bgBtn');
            const input = document.getElementById('bgInput');
            if (!btn || !input) return;

            btn.addEventListener('click', () => input.click());
            input.addEventListener('change', async () => {
                const file = input.files && input.files[0];
                input.value = '';
                if (!file) return;

                try {
                    const compressed = await fileToCompressedDataURL(file);
                    
                    // æª¢æŸ¥å£“ç¸®å¾Œå¤§å°ï¼ˆlocalStorage é™åˆ¶ç´„ 5-10MBï¼Œä¿å®ˆé™åˆ¶ 2MBï¼‰
                    const sizeInMB = (compressed.length * 0.75) / (1024 * 1024); // Base64 ç´„ç‚ºåŸå§‹ 4/3
                    if (sizeInMB > 2) {
                        const msg = (typeof langManager !== 'undefined' && langManager.getCurrentLanguage() === 'zh-TW')
                            ? `åœ–ç‰‡å¤ªå¤§ï¼ˆ${sizeInMB.toFixed(1)}MBï¼‰ï¼Œè«‹é¸æ“‡è¼ƒå°çš„åœ–ç‰‡ï¼ˆå»ºè­° < 2MBï¼‰`
                            : `Image too large (${sizeInMB.toFixed(1)}MB). Please choose a smaller image (< 2MB recommended)`;
                        alert(msg);
                        return;
                    }
                    
                    localStorage.setItem(BG_STORAGE_KEY, compressed);
                    document.body.style.backgroundImage = `url('${compressed}')`;
                } catch (e) {
                    console.error('Set background failed:', e);
                    const msg = (typeof langManager !== 'undefined' && langManager.getCurrentLanguage() === 'zh-TW')
                        ? 'è¨­å®šèƒŒæ™¯å¤±æ•—ï¼Œè«‹æ›ä¸€å¼µåœ–ç‰‡å†è©¦ã€‚'
                        : 'Failed to set background. Please try another image.';
                    alert(msg);
                }
            });
        }
        
        // DOM å…ƒç´ 
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const welcomeSection = document.getElementById('welcomeSection');

        function autoResizeTextarea(el) {
            if (!el) return;
            el.style.height = 'auto';
            const maxPx = 160;
            const nextHeight = Math.min(el.scrollHeight, maxPx);
            el.style.height = `${nextHeight}px`;
        }
        
        // æ‡‰ç”¨ç‹€æ…‹
        let currentUser = null;
        let currentSessionId = localStorage.getItem('chatSessionId') || null;
        let isLoggedIn = false;
        
        console.log('é é¢åˆå§‹åŒ–ï¼Œå¾ localStorage è®€å– sessionId:', currentSessionId);

        // æª¢æŸ¥æ˜¯å¦è¼¸å…¥adminç”¨æˆ¶åï¼Œé¡¯ç¤º/éš±è—å¯†ç¢¼æ¡†
        function checkAdminUsername() {
            const username = document.getElementById('usernameInput').value.trim();
            const passwordInput = document.getElementById('passwordInput');
            
            if (username.toLowerCase() === 'admin') {
                passwordInput.classList.remove('hidden');
            } else {
                passwordInput.classList.add('hidden');
            }
        }

        // ç”¨æˆ¶ç®¡ç†å‡½æ•¸
        async function loginUser() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            if (!username) {
                const msg = langManager.getCurrentLanguage() === 'zh-TW' ? 'è«‹è¼¸å…¥ç”¨æˆ¶å' : 'Please enter username';
                alert(msg);
                return;
            }

            try {
                const requestBody = { username };
                if (username.toLowerCase() === 'admin') {
                    if (!password) {
                        const msg = langManager.getCurrentLanguage() === 'zh-TW' ? 'ç®¡ç†å“¡ç™»å…¥éœ€è¦å¯†ç¢¼' : 'Admin login requires password';
                        alert(msg);
                        return;
                    }
                    requestBody.password = password;
                }

                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    isLoggedIn = true;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œå°å‘ç®¡ç†å“¡é é¢
                    if (data.isAdmin) {
                        window.location.href = '/admin.html';
                        return;
                    }
                    
                    showChatInterface();
                    const welcomeMsg = langManager.getCurrentLanguage() === 'zh-TW'
                        ? `æ­¡è¿å›ä¾†ï¼Œ${currentUser.username}ï¼æ‚¨çš„å­¸ç¿’é€²åº¦å°‡è¢«è¨˜éŒ„ã€‚`
                        : `Welcome back, ${currentUser.username}! Your progress will be tracked.`;
                    addMessage(welcomeMsg);
                } else {
                    console.error('ç™»å…¥å¤±æ•—:', data.error);
                    alert(data.error || (langManager.getCurrentLanguage() === 'zh-TW' ? 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦' : 'Login failed, please try again'));
                }
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                const msg = langManager.getCurrentLanguage() === 'zh-TW' ? 'ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦' : 'Error during login, please try again';
                alert(msg);
            }
        }
        
        function handleLoginKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loginUser();
            }
        }

        async function registerUser() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                const msg = langManager.getCurrentLanguage() === 'zh-TW' ? 'è«‹è¼¸å…¥ç”¨æˆ¶å' : 'Please enter username';
                alert(msg);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    isLoggedIn = true;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showChatInterface();
                    const welcomeMsg = langManager.getCurrentLanguage() === 'zh-TW'
                        ? `æ­¡è¿ï¼Œ${currentUser.username}ï¼æ‚¨çš„å¸³æˆ¶å·²å‰µå»ºï¼Œå­¸ç¿’é€²åº¦å°‡è¢«è¿½è¹¤ã€‚`
                        : `Welcome, ${currentUser.username}! Your account has been created, progress will be tracked.`;
                    addMessage(welcomeMsg);
                } else {
                    console.error('è¨»å†Šå¤±æ•—:', data.error);
                    const errorMsg = langManager.getCurrentLanguage() === 'zh-TW' ? 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦' : 'Registration failed, please try again';
                    alert(data.error || errorMsg);
                }
            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                const errorMsg = langManager.getCurrentLanguage() === 'zh-TW' ? 'è¨»å†Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦' : 'Error during registration, please try again';
                alert(errorMsg);
            }
        }

        function continueAsGuest() {
            isLoggedIn = false;
            currentUser = null;
            
            // é¡¯ç¤ºèŠå¤©ç•Œé¢ä½†ä¸é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯æ¬„
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('exampleQuestions').style.display = 'block';
            hideUserInfo();
            
            // å‰µå»ºæœƒè©±
            createChatSession();
            
            const msg = langManager.getCurrentLanguage() === 'zh-TW' 
                ? 'æ‚¨æ­£ä»¥è¨ªå®¢èº«ä»½ä½¿ç”¨ï¼Œå­¸ç¿’é€²åº¦å°‡ä¸æœƒè¢«ä¿å­˜ã€‚' 
                : 'You are using as a guest, your progress will not be saved.';
            addMessage(msg);
        }

        function showChatInterface() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('exampleQuestions').style.display = 'block';
            
            // é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯æ¬„
            showUserInfo();
            
            // åªæœ‰åœ¨æ²’æœ‰ sessionId æ™‚æ‰å‰µå»ºæ–°æœƒè©±
            if (!currentSessionId) {
                createChatSession();
            } else {
                console.log('ä½¿ç”¨ç¾æœ‰æœƒè©±:', currentSessionId);
            }
        }

        function showUserInfo() {
            if (currentUser && isLoggedIn) {
                const userInfoBar = document.getElementById('userInfoBar');
                const userDisplayName = document.getElementById('userDisplayName');
                const userAvatar = document.getElementById('userAvatar');
                const userStatus = document.getElementById('userStatus');
                
                userDisplayName.textContent = currentUser.username;
                userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
                const statusMsg = langManager.getCurrentLanguage() === 'zh-TW' 
                    ? 'å·²ç™»å…¥ â€¢ å­¸ç¿’é€²åº¦å·²è¿½è¹¤' 
                    : 'Logged in â€¢ Progress tracked';
                userStatus.textContent = statusMsg;
                
                userInfoBar.classList.remove('hidden');
                
                // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºç®¡ç†å“¡æŒ‰éˆ•
                if (currentUser.role === 'admin') {
                    const adminNavBtn = document.getElementById('adminNavBtn');
                    if (adminNavBtn) {
                        adminNavBtn.classList.remove('hidden');
                    }
                }
            }
        }

        function hideUserInfo() {
            const userInfoBar = document.getElementById('userInfoBar');
            userInfoBar.classList.add('hidden');
            
            // éš±è—ç®¡ç†å“¡æŒ‰éˆ•
            const adminNavBtn = document.getElementById('adminNavBtn');
            if (adminNavBtn) {
                adminNavBtn.classList.add('hidden');
            }
        }

        function logoutUser() {
            // ç¢ºèªç™»å‡º
            const confirmMsg = langManager.getCurrentLanguage() === 'zh-TW' 
                ? 'ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿæ‚¨çš„å­¸ç¿’é€²åº¦å·²ä¿å­˜ã€‚' 
                : 'Are you sure you want to log out? Your progress has been saved.';
            
            if (confirm(confirmMsg)) {
                // æ¸…é™¤ç”¨æˆ¶è³‡æ–™
                currentUser = null;
                isLoggedIn = false;
                currentSessionId = null;
                
                // æ¸…é™¤æœ¬åœ°å­˜å„²
                localStorage.removeItem('currentUser');
                localStorage.removeItem('chatSessionId');
                
                // éš±è—ç”¨æˆ¶ä¿¡æ¯æ¬„
                hideUserInfo();
                
                // é‡ç½®åˆ°åˆå§‹ç‹€æ…‹
                resetToInitialState();
                
                // é¡¯ç¤ºç™»å‡ºè¨Šæ¯
                setTimeout(() => {
                    const msg = langManager.getCurrentLanguage() === 'zh-TW'
                        ? 'æ‚¨å·²æˆåŠŸç™»å‡ºã€‚æ„Ÿè¬ä½¿ç”¨çµ±è¨ˆå­¸ AI æ•™å­¸åŠ©ç†ï¼'
                        : 'You have successfully logged out. Thank you for using Statistics AI Teaching Assistant!';
                    addMessage(msg);
                }, 100);
            }
        }

        // é–‹å§‹æ–°å°è©±
        function startNewChat() {
            const confirmMsg = langManager.getCurrentLanguage() === 'zh-TW' 
                ? 'ç¢ºå®šè¦é–‹å§‹æ–°å°è©±å—ï¼Ÿç•¶å‰å°è©±è¨˜éŒ„å°‡è¢«ä¿å­˜ï¼Œä½†ä¸æœƒåœ¨é é¢ä¸Šé¡¯ç¤ºã€‚' 
                : 'Start a new conversation? Current chat will be saved but won\'t display on page.';
            
            if (confirm(confirmMsg)) {
                // æ¸…é™¤ç•¶å‰æœƒè©± IDï¼Œä¸‹æ¬¡ç™¼é€è¨Šæ¯æ™‚æœƒå‰µå»ºæ–°çš„
                currentSessionId = null;
                localStorage.removeItem('chatSessionId');
                
                // æ¸…é™¤èŠå¤©å€åŸŸ
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '';
                
                // é¡¯ç¤ºç¯„ä¾‹å•é¡Œï¼ˆç™»å…¥ç‹€æ…‹ä¸‹ï¼‰
                showExamplesOnly();
                
                const msg = langManager.getCurrentLanguage() === 'zh-TW'
                    ? 'å·²é–‹å§‹æ–°å°è©±ï¼è«‹è¼¸å…¥æ‚¨çš„å•é¡Œã€‚'
                    : 'New conversation started! Please enter your question.';
                addMessage(msg);
            }
        }

        // åƒ…é¡¯ç¤ºç¯„ä¾‹å•é¡Œï¼ˆç”¨æ–¼æ–°å°è©±ï¼‰
        function showExamplesOnly() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = `
                <div class="grid gap-3 max-w-2xl mx-auto animate-fadeInUp pt-4" id="exampleQuestions">
                    <h3 class="text-slate-300 text-sm font-medium mb-2 flex items-center justify-center gap-2">
                        <span class="animate-pulse-slow">ğŸ’¡</span> <span data-i18n="exampleTitle">é»æ“Šä¸‹æ–¹ç¯„ä¾‹é–‹å§‹å°è©±</span>
                    </h3>
                    
                    <div class="grid gap-2 md:grid-cols-2">
                        <button onclick="askExample(this.textContent)" 
                                class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50" data-i18n="example1">
                            ä»€éº¼æ˜¯æ¨™æº–å·®ï¼Ÿå¦‚ä½•è¨ˆç®—ï¼Ÿ
                        </button>
                        <button onclick="askExample(this.textContent)" 
                                class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50" data-i18n="example2">
                            è«‹è§£é‡‹ä¸­å¤®æ¥µé™å®šç†
                        </button>
                        <button onclick="askExample(this.textContent)" 
                                class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50" data-i18n="example3">
                            å¦‚ä½•é€²è¡Œtæª¢å®šï¼Ÿ
                        </button>
                        <button onclick="askExample(this.textContent)" 
                                class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50" data-i18n="example4">
                            ä»€éº¼æ™‚å€™ä½¿ç”¨å¡æ–¹æª¢å®šï¼Ÿ
                        </button>
                    </div>
                </div>
            `;
            
            // ç¿»è­¯æ–°å‰µå»ºçš„å…ƒç´ 
            langManager.translatePage('chat');
        }

        function resetToInitialState() {
            // æ¸…é™¤èŠå¤©å€åŸŸ
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            // é‡æ–°å‰µå»ºåˆå§‹çš„æ­¡è¿ç•Œé¢ï¼ˆä½¿ç”¨åŸå§‹çš„ HTML çµæ§‹ï¼‰
            const welcomeHTML = `
                <!-- æ­¡è¿è¨Šæ¯ -->
                <div class="text-center py-8" id="welcomeSection">
                    <div class="glass-dark rounded-2xl p-6 mb-6 mx-auto max-w-md animate-scaleIn animate-delay-500">
                        <div class="text-2xl mb-3 animate-pulse-slow">ğŸ‘‹</div>
                        <p class="text-slate-200 leading-relaxed animate-fadeInUp animate-delay-600" data-i18n="welcomeMessage">
                            æ­¡è¿ä½¿ç”¨çµ±è¨ˆå­¸ AI æ•™å­¸åŠ©ç†ï¼<br>
                            æˆ‘å¯ä»¥å¹«åŠ©æ‚¨è§£ç­”çµ±è¨ˆå­¸ç›¸é—œçš„å•é¡Œï¼ŒåŒ…æ‹¬æè¿°çµ±è¨ˆã€æ¨è«–çµ±è¨ˆã€å‡è¨­æª¢å®šç­‰ä¸»é¡Œã€‚
                        </p>
                    </div>
                    
                    <!-- ç”¨æˆ¶ç™»å…¥å€åŸŸ -->
                    <div class="mb-6 animate-fadeInUp animate-delay-600" id="loginSection">
                        <div class="glass-dark rounded-2xl p-6 max-w-md mx-auto">
                            <h3 class="text-slate-200 text-lg font-medium mb-4 text-center" data-i18n="loginTitle">
                                ğŸ” ç™»å…¥ä»¥è¿½è¹¤å­¸ç¿’é€²åº¦
                            </h3>
                            <div class="space-y-3">
                                <input type="text" id="usernameInput" placeholder="è¼¸å…¥ç”¨æˆ¶å" data-i18n-placeholder="usernamePlaceholder"
                                       class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
                                       onkeyup="checkAdminUsername()">
                                <input type="password" id="passwordInput" placeholder="è¼¸å…¥å¯†ç¢¼" data-i18n-placeholder="passwordPlaceholder"
                                       class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm hidden"
                                       onkeypress="handleLoginKeyPress(event)">
                                <div class="flex gap-2">
                                    <button onclick="loginUser()" 
                                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors" data-i18n="loginBtn">
                                        ç™»å…¥
                                    </button>
                                    <button onclick="registerUser()" 
                                            class="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors" data-i18n="registerBtn">
                                        è¨»å†Š
                                    </button>
                                </div>
                                <button onclick="continueAsGuest()" 
                                        class="w-full text-slate-400 hover:text-slate-300 text-sm py-2 transition-colors" data-i18n="guestBtn">
                                    ä»¥è¨ªå®¢èº«ä»½ç¹¼çºŒ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ç¯„ä¾‹å•é¡Œ -->
                    <div class="grid gap-3 max-w-2xl mx-auto animate-fadeInUp animate-delay-700" id="exampleQuestions" style="display: none;">
                        <h3 class="text-slate-300 text-sm font-medium mb-2 flex items-center justify-center gap-2">
                            <span class="animate-pulse-slow">ğŸ’¡</span> <span data-i18n="exampleTitle">é»æ“Šä¸‹æ–¹ç¯„ä¾‹é–‹å§‹å°è©±</span>
                        </h3>
                        
                        <div class="grid gap-2 md:grid-cols-2">
                            <button onclick="askExample(this.textContent)" 
                                    class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInLeft animate-delay-100" data-i18n="example1">
                                ä»€éº¼æ˜¯æ¨™æº–å·®ï¼Ÿå¦‚ä½•è¨ˆç®—ï¼Ÿ
                            </button>
                            <button onclick="askExample(this.textContent)" 
                                    class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInRight animate-delay-200" data-i18n="example2">
                                è«‹è§£é‡‹ä¸­å¤®æ¥µé™å®šç†
                            </button>
                            <button onclick="askExample(this.textContent)" 
                                    class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInLeft animate-delay-300" data-i18n="example3">
                                å¦‚ä½•é€²è¡Œtæª¢å®šï¼Ÿ
                            </button>
                            <button onclick="askExample(this.textContent)" 
                                    class="glass-dark rounded-xl p-4 text-slate-200 text-sm btn-hover text-left hover:bg-slate-700/50 animate-slideInRight animate-delay-400" data-i18n="example4">
                                ä»€éº¼æ™‚å€™ä½¿ç”¨å¡æ–¹æª¢å®šï¼Ÿ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.innerHTML = welcomeHTML;
            
            // ç¿»è­¯æ–°å‰µå»ºçš„å…ƒç´ 
            langManager.translatePage('chat');
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = langManager.t(key, 'chat');
            });
        }

        function showLoginInterface() {
            // éš±è—ç¯„ä¾‹å•é¡Œ
            const exampleQuestions = document.getElementById('exampleQuestions');
            if (exampleQuestions) {
                exampleQuestions.style.display = 'none';
            }
            
            // ç¢ºä¿ç™»å…¥ç•Œé¢åœ¨èŠå¤©è¨˜éŒ„ä¸­é¡¯ç¤º
            // clearChatHistory() å‡½æ•¸å·²ç¶“è™•ç†äº†é€™å€‹é‚è¼¯
        }

        function clearChatHistory() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            // é‡æ–°æ·»åŠ æ­¡è¿å€åŸŸå’Œç™»å…¥ç•Œé¢
            const welcomeSection = document.createElement('div');
            welcomeSection.className = 'text-center py-8';
            welcomeSection.id = 'welcomeSection';
            welcomeSection.innerHTML = `
                <div class="glass-dark rounded-2xl p-6 mb-6 mx-auto max-w-md animate-scaleIn animate-delay-500">
                    <div class="text-2xl mb-3 animate-pulse-slow">ğŸ‘‹</div>
                    <p class="text-slate-200 leading-relaxed animate-fadeInUp animate-delay-600" data-i18n="welcomeMessage">
                        æ­¡è¿ä½¿ç”¨çµ±è¨ˆå­¸ AI æ•™å­¸åŠ©ç†ï¼<br>
                        æˆ‘å¯ä»¥å¹«åŠ©æ‚¨è§£ç­”çµ±è¨ˆå­¸ç›¸é—œçš„å•é¡Œï¼ŒåŒ…æ‹¬æè¿°çµ±è¨ˆã€æ¨è«–çµ±è¨ˆã€å‡è¨­æª¢å®šç­‰ä¸»é¡Œã€‚
                    </p>
                </div>
                
                <!-- ç”¨æˆ¶ç™»å…¥å€åŸŸ -->
                <div class="mb-6 animate-fadeInUp animate-delay-600" id="loginSection">
                    <div class="glass-dark rounded-2xl p-6 max-w-md mx-auto">
                        <h3 class="text-slate-200 text-lg font-medium mb-4 text-center" data-i18n="loginTitle">
                            ğŸ” ç™»å…¥ä»¥è¿½è¹¤å­¸ç¿’é€²åº¦
                        </h3>
                        <div class="space-y-3">
                            <input type="text" id="usernameInputNew" placeholder="è¼¸å…¥ç”¨æˆ¶å" data-i18n-placeholder="usernamePlaceholder"
                                   class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
                                   onkeyup="checkAdminUsernameNew()"
                                   onkeypress="handleLoginKeyPress(event)">
                            <input type="password" id="passwordInputNew" placeholder="è¼¸å…¥å¯†ç¢¼" data-i18n-placeholder="passwordPlaceholder"
                                   class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-xl text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm hidden"
                                   onkeypress="handleLoginKeyPress(event)">
                            <div class="flex gap-2">
                                <button id="loginBtnNew" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors" data-i18n="loginBtn">
                                    ç™»å…¥
                                </button>
                                <button id="registerBtnNew" 
                                        class="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-3 px-4 rounded-xl text-sm font-medium transition-colors" data-i18n="registerBtn">
                                    è¨»å†Š
                                </button>
                            </div>
                            <button id="guestBtnNew" 
                                    class="w-full text-slate-400 hover:text-slate-300 text-sm py-2 transition-colors" data-i18n="guestBtn">
                                ä»¥è¨ªå®¢èº«ä»½ç¹¼çºŒ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(welcomeSection);
            
            // ç¶å®šæ–°å‰µå»ºçš„ç™»å…¥ç•Œé¢äº‹ä»¶
            bindLoginEvents();
            
            // ç¿»è­¯æ–°å‰µå»ºçš„å…ƒç´ 
            langManager.translatePage('chat');
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = langManager.t(key, 'chat');
            });
        }

        function bindLoginEvents() {
            // ç¶å®šç™»å…¥æŒ‰éˆ•äº‹ä»¶
            const loginBtn = document.getElementById('loginBtnNew');
            const registerBtn = document.getElementById('registerBtnNew');
            const guestBtn = document.getElementById('guestBtnNew');
            
            if (loginBtn) {
                loginBtn.addEventListener('click', loginUserFromNew);
            }
            
            if (registerBtn) {
                registerBtn.addEventListener('click', registerUserFromNew);
            }
            
            if (guestBtn) {
                guestBtn.addEventListener('click', continueAsGuest);
            }
        }

        // æª¢æŸ¥æ˜¯å¦è¼¸å…¥adminç”¨æˆ¶åï¼ˆå‹•æ…‹å‰µå»ºçš„ç™»å…¥ç•Œé¢ç”¨ï¼‰
        function checkAdminUsernameNew() {
            const username = document.getElementById('usernameInputNew').value.trim();
            const passwordInput = document.getElementById('passwordInputNew');
            
            if (passwordInput) {
                if (username.toLowerCase() === 'admin') {
                    passwordInput.classList.remove('hidden');
                } else {
                    passwordInput.classList.add('hidden');
                }
            }
        }
        
        function handleLoginKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loginUserFromNew();
            }
        }

        async function loginUserFromNew() {
            const username = document.getElementById('usernameInputNew').value.trim();
            const passwordInputEl = document.getElementById('passwordInputNew');
            const password = passwordInputEl ? passwordInputEl.value : '';
            
            if (!username) {
                const msg = langManager.getCurrentLanguage() === 'zh-TW' ? 'è«‹è¼¸å…¥ç”¨æˆ¶å' : 'Please enter username';
                alert(msg);
                return;
            }

            try {
                const requestBody = { username };
                if (username.toLowerCase() === 'admin') {
                    if (!password) {
                        const msg = langManager.getCurrentLanguage() === 'zh-TW' ? 'ç®¡ç†å“¡ç™»å…¥éœ€è¦å¯†ç¢¼' : 'Admin login requires password';
                        alert(msg);
                        return;
                    }
                    requestBody.password = password;
                }

                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    isLoggedIn = true;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œå°å‘ç®¡ç†å“¡é é¢
                    if (data.isAdmin) {
                        window.location.href = '/admin.html';
                        return;
                    }
                    
                    showChatInterface();
                    const welcomeMsg = langManager.getCurrentLanguage() === 'zh-TW'
                        ? `æ­¡è¿å›ä¾†ï¼Œ${currentUser.username}ï¼æ‚¨çš„å­¸ç¿’é€²åº¦å°‡è¢«è¨˜éŒ„ã€‚`
                        : `Welcome back, ${currentUser.username}! Your progress will be tracked.`;
                    addMessage(welcomeMsg);
                } else {
                    console.error('ç™»å…¥å¤±æ•—:', data.error);
                    alert(data.error || (langManager.getCurrentLanguage() === 'zh-TW' ? 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦' : 'Login failed, please try again'));
                }
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                const msg = langManager.getCurrentLanguage() === 'zh-TW' ? 'ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦' : 'Error during login, please try again';
                alert(msg);
            }
        }

        async function registerUserFromNew() {
            const username = document.getElementById('usernameInputNew').value.trim();
            if (!username) {
                const msg = langManager.getCurrentLanguage() === 'zh-TW' ? 'è«‹è¼¸å…¥ç”¨æˆ¶å' : 'Please enter username';
                alert(msg);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    isLoggedIn = true;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showChatInterface();
                    const welcomeMsg = langManager.getCurrentLanguage() === 'zh-TW'
                        ? `æ­¡è¿ï¼Œ${currentUser.username}ï¼æ‚¨çš„å¸³æˆ¶å·²å‰µå»ºï¼Œå­¸ç¿’é€²åº¦å°‡è¢«è¿½è¹¤ã€‚`
                        : `Welcome, ${currentUser.username}! Your account has been created, progress will be tracked.`;
                    addMessage(welcomeMsg);
                } else {
                    console.error('è¨»å†Šå¤±æ•—:', data.error);
                    const errorMsg = langManager.getCurrentLanguage() === 'zh-TW' ? 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦' : 'Registration failed, please try again';
                    alert(data.error || errorMsg);
                }
            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                const errorMsg = langManager.getCurrentLanguage() === 'zh-TW' ? 'è¨»å†Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦' : 'Error during registration, please try again';
                alert(errorMsg);
            }
        }

        async function createChatSession() {
            try {
                // ç”Ÿæˆæ–°çš„æœƒè©± ID
                const newSessionId = generateSessionId();
                
                const response = await fetch(`${API_BASE_URL}/chat/session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': newSessionId
                    },
                    body: JSON.stringify({
                        userId: currentUser?.user_id || null
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentSessionId = data.sessionId;
                    localStorage.setItem('chatSessionId', currentSessionId);
                    console.log('æœƒè©±å‰µå»ºæˆåŠŸ:', currentSessionId);
                } else {
                    console.error('å‰µå»ºæœƒè©±å¤±æ•—:', data.error);
                    // å¦‚æœæœƒè©±å‰µå»ºå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆçš„ ID
                    currentSessionId = newSessionId;
                    localStorage.setItem('chatSessionId', currentSessionId);
                }
            } catch (error) {
                console.error('å‰µå»ºæœƒè©±éŒ¯èª¤:', error);
                // å¦‚æœç¶²è·¯éŒ¯èª¤ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆçš„ ID
                currentSessionId = generateSessionId();
                localStorage.setItem('chatSessionId', currentSessionId);
            }
        }

        function generateSessionId() {
            // ç”Ÿæˆç¬¦åˆ UUID v4 æ ¼å¼çš„ ID
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // è¼‰å…¥èŠå¤©æ­·å²è¨˜éŒ„
        async function loadChatHistory() {
            if (!currentSessionId) {
                console.log('æ²’æœ‰æœƒè©± IDï¼Œè·³éè¼‰å…¥æ­·å²è¨˜éŒ„');
                return false;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/chat/history/${currentSessionId}?limit=50`);
                const data = await response.json();

                if (data.success && data.messages && data.messages.length > 0) {
                    console.log(`è¼‰å…¥äº† ${data.messages.length} æ¢æ­·å²è¨˜éŒ„`);
                    
                    // ç§»é™¤æ­¡è¿å€åŸŸ
                    const welcomeSection = document.getElementById('welcomeSection');
                    if (welcomeSection) {
                        welcomeSection.remove();
                    }

                    // é¡¯ç¤ºæ­·å²è¨Šæ¯
                    data.messages.forEach(msg => {
                        addMessageFromHistory(msg.content, msg.sender_type === 'user');
                    });

                    return true;
                }
                return false;
            } catch (error) {
                console.error('è¼‰å…¥èŠå¤©æ­·å²å¤±æ•—:', error);
                return false;
            }
        }

        // å¾æ­·å²è¨˜éŒ„æ·»åŠ è¨Šæ¯ï¼ˆä¸è§¸ç™¼ MathJax å¤šæ¬¡é‡æ¸²æŸ“ï¼‰
        function addMessageFromHistory(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${isUser ? 'flex justify-end' : 'flex justify-start'} message-bubble`;
            
            const bubbleClass = isUser 
                ? 'bg-blue-600/90 text-white ml-auto' 
                : 'glass-dark text-slate-200 mr-auto';
            
            let processedContent;
            if (isUser) {
                processedContent = `<div class="text-sm md:text-base leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</div>`;
            } else {
                let preprocessedContent = preprocessMath(content);
                const markdownHtml = marked.parse(preprocessedContent);
                processedContent = `<div class="text-sm md:text-base markdown-content tex2jax_process">${markdownHtml}</div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="max-w-sm md:max-w-lg lg:max-w-xl xl:max-w-2xl rounded-2xl px-6 py-4 ${bubbleClass} shadow-sm">
                    ${processedContent}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // ä»£ç¢¼é«˜äº®
            if (!isUser && typeof hljs !== 'undefined') {
                messageDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
        }

        // æ‰¹é‡æ¸²æŸ“ MathJaxï¼ˆåœ¨è¼‰å…¥å®Œæ­·å²è¨˜éŒ„å¾Œèª¿ç”¨ï¼‰
        function renderAllMath() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([messagesContainer]).then(() => {
                    console.log('æ­·å²è¨˜éŒ„ MathJax æ¸²æŸ“å®Œæˆ');
                }).catch((err) => {
                    console.error('MathJax æ¸²æŸ“éŒ¯èª¤:', err);
                });
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function askExample(question) {
            messageInput.value = question;
            autoResizeTextarea(messageInput);
            sendMessage();
        }

        function addMessage(content, isUser = false) {
            // ç§»é™¤æ­¡è¿å€åŸŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (welcomeSection) {
                welcomeSection.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${isUser ? 'flex justify-end' : 'flex justify-start'} message-bubble`;
            
            const bubbleClass = isUser 
                ? 'bg-blue-600/90 text-white ml-auto' 
                : 'glass-dark text-slate-200 mr-auto';
            
            // è™•ç† Markdown å…§å®¹
            let processedContent;
            if (isUser) {
                // ç”¨æˆ¶æ¶ˆæ¯ä¿æŒç´”æ–‡å­—
                processedContent = `<div class="text-sm md:text-base leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</div>`;
            } else {
                // AI å›æ‡‰ä½¿ç”¨ Markdown æ¸²æŸ“ï¼Œä¸¦é è™•ç†æ•¸å­¸å…¬å¼
                let preprocessedContent = preprocessMath(content);
                const markdownHtml = marked.parse(preprocessedContent);
                processedContent = `<div class="text-sm md:text-base markdown-content tex2jax_process">${markdownHtml}</div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="max-w-sm md:max-w-lg lg:max-w-xl xl:max-w-2xl rounded-2xl px-6 py-4 ${bubbleClass} shadow-sm">
                    ${processedContent}
                </div>
            `;
            
            // å¦‚æœæ˜¯ AI å›æ‡‰ï¼Œé€²è¡Œä»£ç¢¼é«˜äº®å’Œæ•¸å­¸å…¬å¼æ¸²æŸ“
            if (!isUser) {
                // å…ˆæ·»åŠ åˆ° DOM
                messagesContainer.appendChild(messageDiv);
                
                // ä»£ç¢¼é«˜äº®ï¼ˆæª¢æŸ¥ hljs æ˜¯å¦å¯ç”¨ï¼‰
                if (typeof hljs !== 'undefined') {
                    messageDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
                
                // æ•¸å­¸å…¬å¼æ¸²æŸ“ - ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•
                setTimeout(() => {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        window.MathJax.typesetPromise([messageDiv]).then(() => {
                            console.log('MathJax rendered successfully');
                        }).catch((err) => {
                            console.error('MathJax typeset error:', err);
                            // å¦‚æœ MathJax å¤±æ•—ï¼Œå˜—è©¦æ‰‹å‹•è™•ç†
                            fallbackMathRender(messageDiv);
                        });
                    } else {
                        // MathJax é‚„æœªåŠ è¼‰ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ
                        fallbackMathRender(messageDiv);
                    }
                }, 100);
            } else {
                messagesContainer.appendChild(messageDiv);
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // HTML è½‰ç¾©å‡½æ•¸
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // æ•¸å­¸å…¬å¼é è™•ç†å‡½æ•¸
        function preprocessMath(content) {
            // å°‡æ–¹æ‹¬è™ŸåŒ…åœçš„LaTeXå…¬å¼è½‰æ›ç‚ºMathJaxæ¨™æº–æ ¼å¼
            return content.replace(/\[([^\[\]]*\\[^\[\]]*)\]/g, (match, formula) => {
                // æª¢æŸ¥æ˜¯å¦ç¢ºå¯¦åŒ…å«LaTeXèªæ³•
                if (formula.includes('\\')) {
                    return `$$${formula}$$`;
                }
                return match; // å¦‚æœä¸åŒ…å«LaTeXèªæ³•ï¼Œä¿æŒåŸæ¨£
            });
        }

        // å‚™ç”¨æ•¸å­¸å…¬å¼æ¸²æŸ“å‡½æ•¸
        function fallbackMathRender(element) {
            console.log('Using fallback math rendering');
            
            // ç°¡å–®çš„ LaTeX ç¬¦è™Ÿæ›¿æ›
            const mathReplacements = [
                { pattern: /\\frac\{([^}]+)\}\{([^}]+)\}/g, replacement: '<span style="display: inline-block; text-align: center; vertical-align: middle;"><span style="display: block; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px; font-size: 0.9em;">$1</span><span style="display: block; padding-top: 2px; font-size: 0.9em;">$2</span></span>' },
                { pattern: /\\text\{([^}]+)\}/g, replacement: '$1' },
                { pattern: /\\sum/g, replacement: 'âˆ‘' },
                { pattern: /\\sqrt\{([^}]+)\}/g, replacement: 'âˆš($1)' },
                { pattern: /\^2/g, replacement: 'Â²' },
                { pattern: /\^3/g, replacement: 'Â³' },
                { pattern: /\\mu/g, replacement: 'Î¼' },
                { pattern: /\\sigma/g, replacement: 'Ïƒ' },
                { pattern: /\\alpha/g, replacement: 'Î±' },
                { pattern: /\\beta/g, replacement: 'Î²' },
                { pattern: /\\chi/g, replacement: 'Ï‡' },
                { pattern: /\\bar\{([^}]+)\}/g, replacement: '$1Ì„' },
                { pattern: /\\overline\{([^}]+)\}/g, replacement: '$1Ì„' }
            ];
            
            const textNodes = [];
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            textNodes.forEach(textNode => {
                let content = textNode.textContent;
                let hasLaTeX = false;
                
                // æª¢æŸ¥æ˜¯å¦åŒ…å« LaTeX èªæ³•æˆ–æ–¹æ‹¬è™ŸåŒ…åœçš„å…¬å¼
                if (content.includes('\\') || content.includes('^') || content.includes('_') || 
                    /\[.*\\.*\]/.test(content)) {
                    hasLaTeX = true;
                    
                    // è™•ç†æ–¹æ‹¬è™ŸåŒ…åœçš„å…¬å¼
                    content = content.replace(/\[([^\[\]]*\\[^\[\]]*)\]/g, (match, formula) => {
                        // å°æ–¹æ‹¬è™Ÿå…§çš„å…¬å¼é€²è¡Œè™•ç†
                        let processedFormula = formula;
                        mathReplacements.forEach(replacement => {
                            processedFormula = processedFormula.replace(replacement.pattern, replacement.replacement);
                        });
                        
                        // è™•ç†ä¸‹æ¨™å’Œä¸Šæ¨™
                        processedFormula = processedFormula.replace(/_\{([^}]+)\}/g, '<sub>$1</sub>');
                        processedFormula = processedFormula.replace(/_([a-zA-Z0-9])/g, '<sub>$1</sub>');
                        processedFormula = processedFormula.replace(/\^\{([^}]+)\}/g, '<sup>$1</sup>');
                        
                        return `<span style="display: block; margin: 0.5rem 0; text-align: center; font-size: 1.1em; background: rgba(51, 65, 85, 0.3); padding: 0.5rem; border-radius: 0.5rem;">${processedFormula}</span>`;
                    });
                    
                    // è™•ç†å…¶ä»–LaTeXèªæ³•
                    mathReplacements.forEach(replacement => {
                        content = content.replace(replacement.pattern, replacement.replacement);
                    });
                    
                    // è™•ç†ä¸‹æ¨™
                    content = content.replace(/_\{([^}]+)\}/g, '<sub>$1</sub>');
                    content = content.replace(/_([a-zA-Z0-9])/g, '<sub>$1</sub>');
                    
                    // è™•ç†ä¸Šæ¨™
                    content = content.replace(/\^\{([^}]+)\}/g, '<sup>$1</sup>');
                }
                
                if (hasLaTeX && content !== textNode.textContent) {
                    const span = document.createElement('span');
                    span.innerHTML = content;
                    span.style.fontFamily = 'serif';
                    span.style.color = '#e2e8f0';
                    textNode.parentNode.replaceChild(span, textNode);
                }
            });
        }

        // å‹•æ…‹è¼‰å…¥å‹•ç•«å…ƒç´ 
        let loadingDiv = null;

        function showLoading() {
            // å¦‚æœå·²ç¶“æœ‰è¼‰å…¥å‹•ç•«ï¼Œå…ˆç§»é™¤
            hideLoading();
            
            // å‰µå»ºæ–°çš„è¼‰å…¥å‹•ç•«å…ƒç´ 
            loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.className = 'flex items-center gap-3 mb-4';
            
            const thinkingText = langManager.getCurrentLanguage() === 'zh-TW' ? 'AI æ­£åœ¨æ€è€ƒä¸­' : 'AI is thinking';
            
            loadingDiv.innerHTML = `
                <div class="glass-dark rounded-2xl px-6 py-4 flex items-center gap-3">
                    <span class="text-slate-200 text-sm">${thinkingText}</span>
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°è¨Šæ¯å®¹å™¨åº•éƒ¨
            messagesContainer.appendChild(loadingDiv);
            
            // æ»¾å‹•åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideLoading() {
            // ç§»é™¤è¼‰å…¥å‹•ç•«
            const existingLoading = document.getElementById('loadingIndicator');
            if (existingLoading) {
                existingLoading.remove();
            }
            loadingDiv = null;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
            addMessage(message, true);
            messageInput.value = '';
            autoResizeTextarea(messageInput);
            
            // ç¦ç”¨ç™¼é€æŒ‰éˆ•å’Œè¼¸å…¥æ¡†
            sendButton.disabled = true;
            messageInput.disabled = true;
            
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            showLoading();

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // å¦‚æœæœ‰æœƒè©± IDï¼Œæ·»åŠ åˆ° headers
                if (currentSessionId) {
                    headers['X-Session-ID'] = currentSessionId;
                }

                const response = await fetch(`${API_BASE_URL}/chat/message`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        message: message,
                        userId: currentUser?.user_id || null
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    hideLoading();
                    addMessage(data.response);
                    
                    // é¡¯ç¤ºæª¢æ¸¬åˆ°çš„æ¦‚å¿µï¼ˆå¦‚æœæœ‰ï¼‰
                    if (data.concepts && data.concepts.length > 0) {
                        console.log('æª¢æ¸¬åˆ°çš„çµ±è¨ˆæ¦‚å¿µ:', data.concepts);
                        showConceptTags(data.concepts);
                    }
                    
                    // æ›´æ–°æœƒè©± IDï¼ˆå¦‚æœè¿”å›äº†æ–°çš„ï¼‰
                    if (data.sessionId) {
                        currentSessionId = data.sessionId;
                        localStorage.setItem('chatSessionId', currentSessionId);
                    }
                } else {
                    throw new Error(data.error || 'APIå›æ‡‰éŒ¯èª¤');
                }

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                const errorMsg = langManager.getCurrentLanguage() === 'zh-TW'
                    ? 'æŠ±æ­‰ï¼Œç™¼ç”Ÿäº†éŒ¯èª¤ã€‚è«‹ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤è©³æƒ…ï¼š' + error.message
                    : 'Sorry, an error occurred. Please try again later.\nError details: ' + error.message;
                addMessage(errorMsg);
            } finally {
                // é‡æ–°å•Ÿç”¨ç™¼é€æŒ‰éˆ•å’Œè¼¸å…¥æ¡†
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // é¡¯ç¤ºæ¦‚å¿µæ¨™ç±¤
        function showConceptTags(concepts) {
            if (concepts.length === 0) return;
            
            const tagsDiv = document.createElement('div');
            tagsDiv.className = 'flex flex-wrap gap-2 mb-4 justify-center';
            
            concepts.forEach(concept => {
                const tag = document.createElement('span');
                tag.className = 'px-3 py-1 bg-blue-600/30 text-blue-200 rounded-full text-xs border border-blue-500/30';
                tag.textContent = `ğŸ“Š ${concept}`;
                tagsDiv.appendChild(tag);
            });
            
            messagesContainer.appendChild(tagsDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // èªè¨€åˆ‡æ›åŠŸèƒ½
        function initLanguage() {
            // åˆå§‹åŒ–èªè¨€ç®¡ç†å™¨
            const currentLang = langManager.getCurrentLanguage();
            updateLangButton(currentLang);
            langManager.translatePage('chat');
            
            // åˆå§‹åŒ– placeholder å’Œ send button
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = langManager.t(key, 'chat');
            });
            const sendBtn = document.querySelector('[data-i18n-alt]');
            if (sendBtn) {
                const key = sendBtn.getAttribute('data-i18n-alt');
                sendBtn.setAttribute('alt', langManager.t(key, 'chat'));
            }
            
            // èªè¨€åˆ‡æ›æŒ‰éˆ•äº‹ä»¶
            document.getElementById('langToggle').addEventListener('click', () => {
                const newLang = langManager.getCurrentLanguage() === 'zh-TW' ? 'en' : 'zh-TW';
                langManager.setLanguage(newLang);
                updateLangButton(newLang);
                langManager.translatePage('chat');
                
                // æ›´æ–°placeholderï¼ˆç‰¹æ®Šè™•ç†ï¼‰
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    el.placeholder = langManager.t(key, 'chat');
                });
                
                // æ›´æ–°sendButtonçš„altå±¬æ€§ï¼ˆç‰¹æ®Šè™•ç†ï¼‰
                const sendBtn = document.querySelector('[data-i18n-alt]');
                if (sendBtn) {
                    const key = sendBtn.getAttribute('data-i18n-alt');
                    sendBtn.setAttribute('alt', langManager.t(key, 'chat'));
                }
            });
        }
        
        function updateLangButton(lang) {
            const langText = document.getElementById('langText');
            if (lang === 'zh-TW') {
                langText.textContent = 'ä¸­æ–‡';
            } else {
                langText.textContent = 'English';
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', async () => {
            // åˆå§‹åŒ–èªè¨€
            initLanguage();

            // åˆå§‹åŒ–è¼¸å…¥æ¡†é«˜åº¦ï¼ˆtextarea è‡ªå‹•å¢é«˜ï¼‰
            autoResizeTextarea(messageInput);

            // åˆå§‹åŒ–è‡ªè¨‚èƒŒæ™¯
            initBackgroundPicker();
            
            // é…ç½® marked.js
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
            
            // é…ç½® highlight.jsï¼ˆæª¢æŸ¥æ˜¯å¦è¼‰å…¥æˆåŠŸï¼‰
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['javascript', 'python', 'r', 'sql', 'bash', 'json', 'markdown']
                });
                console.log('Highlight.js é…ç½®æˆåŠŸ');
            } else {
                console.warn('Highlight.js æœªè¼‰å…¥ï¼Œå°‡è·³éä»£ç¢¼é«˜äº®åŠŸèƒ½');
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ¶ä¿¡æ¯
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    showChatInterface();
                    
                    // å˜—è©¦è¼‰å…¥èŠå¤©æ­·å²
                    const hasHistory = await loadChatHistory();
                    if (hasHistory) {
                        // æ‰¹é‡æ¸²æŸ“æ•¸å­¸å…¬å¼
                        setTimeout(() => {
                            renderAllMath();
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }, 500);
                    } else {
                        const welcomeMsg = langManager.getCurrentLanguage() === 'zh-TW' 
                            ? `æ­¡è¿å›ä¾†ï¼Œ${currentUser.username}ï¼æ‚¨çš„å­¸ç¿’é€²åº¦å°‡ç¹¼çºŒè¢«è¿½è¹¤ã€‚`
                            : `Welcome back, ${currentUser.username}! Your progress will continue to be tracked.`;
                        addMessage(welcomeMsg);
                    }
                } catch (error) {
                    console.error('è§£æä¿å­˜çš„ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:', error);
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('chatSessionId');
                }
            }
            
            messageInput.focus();
            
            // ç­‰å¾… MathJax è¼‰å…¥å®Œæˆ
            setTimeout(() => {
                if (window.MathJax && window.MathJax.startup) {
                    MathJax.startup.promise.then(() => {
                        console.log('MathJax is ready');
                        window.mathJaxReady = true;
                    }).catch((err) => {
                        console.error('MathJax startup error:', err);
                        window.mathJaxReady = false;
                    });
                } else {
                    console.warn('MathJax not loaded, using fallback rendering');
                    window.mathJaxReady = false;
                }
            }, 2000);
        });

        // æš—è‰²ä¸»é¡Œäº’å‹•æ•ˆæœ
        messageInput.addEventListener('focus', () => {
            messageInput.style.borderColor = 'rgb(96, 165, 250)';
        });

        messageInput.addEventListener('blur', () => {
            messageInput.style.borderColor = 'rgba(71, 85, 105, 0.6)';
        });
    </script>
</body>
</html>