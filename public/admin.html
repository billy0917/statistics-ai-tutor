<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡æ§åˆ¶å° - Statistics AI Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/i18n.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* æš—è‰²ä¸»é¡Œé…è‰²æ–¹æ¡ˆ */
        .glass {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(71, 85, 105, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(51, 65, 85, 0.4);
        }

        /* æš—è‰²æ»¾å‹•æ¢ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 3px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .user-card {
            transition: all 0.3s ease;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        .stat-card {
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<body class="min-h-screen bg-cover bg-center bg-no-repeat" 
      style="background-image: url('https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg');">
    
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="fixed inset-0 bg-black/20 -z-10"></div>
    
    <div class="relative max-w-7xl mx-auto p-4 md:p-8">
        <!-- æ¨™é¡Œå€ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">ğŸ›¡ï¸</span>
                    <h1 class="text-3xl font-bold text-slate-100" data-i18n="adminTitle">ç®¡ç†å“¡æ§åˆ¶å°</h1>
                </div>
                <div class="flex gap-3 items-center">
                    <button id="langToggle" class="glass-dark px-3 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition-all text-sm font-medium flex items-center gap-2">
                        <span>ğŸŒ</span>
                        <span id="langText">ä¸­æ–‡</span>
                    </button>
                    <button id="bgBtn" class="glass-dark px-3 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition-all text-sm font-medium flex items-center gap-2">
                        <span>ğŸ–¼ï¸</span>
                        <span data-i18n="common.setBackground">ğŸ–¼ï¸ æ›´æ›èƒŒæ™¯</span>
                    </button>
                    <input id="bgInput" type="file" accept="image/*" class="hidden" />
                    <span class="text-slate-500">|</span>
                    <button onclick="logoutAdmin()" class="text-red-400 hover:text-red-300 transition font-medium" data-i18n="logoutBtn">
                        ç™»å‡º
                    </button>
                    <span class="text-slate-500">|</span>
                    <a href="/" class="text-blue-400 hover:text-blue-300 transition" data-i18n="backToHome">
                        è¿”å›é¦–é 
                    </a>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <p class="text-slate-300" data-i18n="adminSubtitle">ç®¡ç†æ‰€æœ‰ç”¨æˆ¶çš„å­¸ç¿’é€²åº¦å’Œç³»çµ±çµ±è¨ˆ</p>
                <button onclick="exportAllChats()" class="glass-dark px-4 py-2 rounded-lg text-green-400 hover:bg-green-500/20 transition text-sm font-medium flex items-center gap-2">
                    ğŸ“¥ Export All Chats
                </button>
            </div>
            
            <!-- AI Disclaimer -->
            <div class="mt-4 p-3 glass-dark rounded-lg border-l-4 border-yellow-500/50">
                <p class="text-sm text-yellow-200/90" data-i18n="common.disclaimer">
                    âš ï¸ å…è²¬è²æ˜ï¼šæœ¬ç³»çµ±ä½¿ç”¨ AI æŠ€è¡“ç”Ÿæˆå…§å®¹ï¼Œç­”æ¡ˆæœªå¿…å®Œå…¨æ­£ç¢ºï¼Œè«‹è¬¹æ…åˆ¤æ–·ä¸¦ä»¥æ•™æåŠè€å¸«æ•™å­¸å…§å®¹ç‚ºæº–ã€‚
                </p>
            </div>
        </div>

        <!-- ç³»çµ±ç¸½è¦½çµ±è¨ˆ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <h2 class="text-2xl font-bold text-slate-100 mb-4" data-i18n="systemOverview">ğŸ“Š ç³»çµ±ç¸½è¦½</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-blue-500/30">
                    <div class="text-3xl font-bold text-blue-400" id="totalUsers">-</div>
                    <div class="text-sm text-slate-400 mt-2" data-i18n="totalUsersLabel">ç¸½ç”¨æˆ¶æ•¸</div>
                </div>
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-green-500/30">
                    <div class="text-3xl font-bold text-green-400" id="totalQuestions">-</div>
                    <div class="text-sm text-slate-400 mt-2" data-i18n="totalQuestionsLabel">ç¸½é¡Œç›®æ•¸</div>
                </div>
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-purple-500/30">
                    <div class="text-3xl font-bold text-purple-400" id="totalAnswers">-</div>
                    <div class="text-sm text-slate-400 mt-2" data-i18n="totalAnswersLabel">ç¸½ç­”é¡Œæ•¸</div>
                </div>
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-yellow-500/30">
                    <div class="text-3xl font-bold text-yellow-400" id="activeToday">-</div>
                    <div class="text-sm text-slate-400 mt-2" data-i18n="activeTodayLabel">ä»Šæ—¥æ´»èº</div>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ¶åˆ—è¡¨ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-slate-100" data-i18n="userListTitle">ğŸ‘¥ ç”¨æˆ¶åˆ—è¡¨</h2>
                <button onclick="refreshUsers()" class="glass-dark px-4 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition text-sm font-medium" data-i18n="refreshBtn">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>

            <!-- æœç´¢å’Œç¯©é¸ -->
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ¶å..." data-i18n-placeholder="searchPlaceholder"
                       class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400"
                       onkeyup="filterUsers()">
            </div>

            <!-- è¼‰å…¥å‹•ç•« -->
            <div id="loadingUsers" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mb-4"></div>
                <p class="text-slate-300" data-i18n="loadingUsers">è¼‰å…¥ç”¨æˆ¶ä¸­...</p>
            </div>

            <!-- ç”¨æˆ¶å¡ç‰‡åˆ—è¡¨ -->
            <div id="usersContainer" class="grid md:grid-cols-2 gap-4 hidden"></div>

            <!-- ç„¡ç”¨æˆ¶æç¤º -->
            <div id="noUsers" class="text-center py-12 hidden">
                <p class="text-slate-400" data-i18n="noUsers">æš«ç„¡ç”¨æˆ¶æ•¸æ“š</p>
            </div>
        </div>

        <!-- è€å¸«é¡Œç›®ç®¡ç† -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                <h2 class="text-2xl font-bold text-slate-100">ğŸ“ Teacher Questions Management</h2>
                <div class="flex gap-2">
                    <button onclick="showCreateQuestionForm()" class="glass-dark px-4 py-2 rounded-lg text-green-400 hover:bg-green-500/20 transition text-sm font-medium">
                        â• Create New Question
                    </button>
                    <button onclick="loadTeacherQuestions()" class="glass-dark px-4 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition text-sm font-medium">
                        ğŸ”„ Refresh
                    </button>
                </div>
            </div>

            <!-- è€å¸«é¡Œç›®çµ±è¨ˆ -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-green-500/30">
                    <div class="text-3xl font-bold text-green-400" id="teacherTotalQuestions">-</div>
                    <div class="text-sm text-slate-400 mt-2">Total Questions</div>
                </div>
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-blue-500/30">
                    <div class="text-3xl font-bold text-blue-400" id="teacherActiveQuestions">-</div>
                    <div class="text-sm text-slate-400 mt-2">Active Questions</div>
                </div>
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-purple-500/30">
                    <div class="text-3xl font-bold text-purple-400" id="teacherTotalAnswers">-</div>
                    <div class="text-sm text-slate-400 mt-2">Total Attempts</div>
                </div>
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-yellow-500/30">
                    <div class="text-3xl font-bold text-yellow-400" id="teacherAvgAccuracy">-</div>
                    <div class="text-sm text-slate-400 mt-2">Avg Accuracy</div>
                </div>
            </div>

            <!-- è€å¸«é¡Œç›®åˆ—è¡¨ -->
            <div id="loadingTeacherQuestions" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-blue-400 mb-3"></div>
                <p class="text-slate-300">Loading questions...</p>
            </div>

            <div id="teacherQuestionsContainer" class="space-y-3 max-h-[500px] overflow-y-auto custom-scrollbar">
                <!-- å‹•æ…‹å¡«å…… -->
            </div>

            <div id="noTeacherQuestions" class="text-center py-8 hidden">
                <p class="text-slate-400">No teacher questions yet. Click "Create New Question" to add one.</p>
            </div>
        </div>

        <!-- AI Practice çµ±è¨ˆ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <h2 class="text-2xl font-bold text-slate-100 mb-4" data-i18n="practiceStatsTitle">ğŸ“ˆ AI Practice çµ±è¨ˆ</h2>
            
            <!-- æ¦‚å¿µçµ±è¨ˆ -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-slate-200 mb-3" data-i18n="conceptStatsTitle">æŒ‰æ¦‚å¿µçµ±è¨ˆ</h3>
                <div id="conceptStatsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- å‹•æ…‹å¡«å…… -->
                </div>
            </div>

            <!-- é›£åº¦çµ±è¨ˆ -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-slate-200 mb-3" data-i18n="difficultyStatsTitle">æŒ‰é›£åº¦çµ±è¨ˆ</h3>
                <div id="difficultyStatsContainer" class="grid grid-cols-3 gap-3">
                    <!-- å‹•æ…‹å¡«å…… -->
                </div>
            </div>

            <!-- é¡Œå‹çµ±è¨ˆ -->
            <div>
                <h3 class="text-lg font-semibold text-slate-200 mb-3" data-i18n="typeStatsTitle">æŒ‰é¡Œå‹çµ±è¨ˆ</h3>
                <div id="typeStatsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- å‹•æ…‹å¡«å…… -->
                </div>
            </div>
        </div>

        <!-- AI Practice ç­”é¡Œè¨˜éŒ„ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                <h2 class="text-2xl font-bold text-slate-100" data-i18n="practiceRecordsTitle">âœï¸ AI Practice ç­”é¡Œè¨˜éŒ„</h2>
                <button onclick="refreshPracticeRecords()" class="glass-dark px-4 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition text-sm font-medium" data-i18n="refreshBtn">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>

            <!-- ç¯©é¸å™¨ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                <select id="conceptFilter" onchange="filterPracticeRecords()" 
                        class="px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="" data-i18n="allConcepts">æ‰€æœ‰æ¦‚å¿µ</option>
                </select>
                <select id="difficultyFilterSelect" onchange="filterPracticeRecords()"
                        class="px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="" data-i18n="allDifficulties">æ‰€æœ‰é›£åº¦</option>
                    <option value="1" data-i18n="basicLevel">åŸºç¤</option>
                    <option value="2" data-i18n="mediumLevel">ä¸­ç´š</option>
                    <option value="3" data-i18n="advancedLevel">é€²éš</option>
                </select>
                <select id="correctFilter" onchange="filterPracticeRecords()"
                        class="px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="" data-i18n="allResults">æ‰€æœ‰çµæœ</option>
                    <option value="true" data-i18n="correctOnly">åƒ…æ­£ç¢º</option>
                    <option value="false" data-i18n="incorrectOnly">åƒ…éŒ¯èª¤</option>
                </select>
                <input type="text" id="userFilter" placeholder="æœç´¢ç”¨æˆ¶..." data-i18n-placeholder="searchUserPlaceholder"
                       class="px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400"
                       onkeyup="filterPracticeRecords()">
            </div>

            <!-- è¼‰å…¥å‹•ç•« -->
            <div id="loadingRecords" class="text-center py-12 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mb-4"></div>
                <p class="text-slate-300" data-i18n="loadingRecords">è¼‰å…¥è¨˜éŒ„ä¸­...</p>
            </div>

            <!-- ç­”é¡Œè¨˜éŒ„åˆ—è¡¨ -->
            <div id="practiceRecordsContainer" class="space-y-3 max-h-[600px] overflow-y-auto custom-scrollbar">
                <!-- å‹•æ…‹å¡«å…… -->
            </div>

            <!-- ç„¡è¨˜éŒ„æç¤º -->
            <div id="noRecords" class="text-center py-12 hidden">
                <p class="text-slate-400" data-i18n="noRecords">æš«ç„¡ç­”é¡Œè¨˜éŒ„</p>
            </div>

            <!-- åˆ†é æ§åˆ¶ -->
            <div id="paginationContainer" class="flex items-center justify-center gap-4 mt-4 hidden">
                <button onclick="loadPracticeRecords(currentPage - 1)" id="prevPageBtn" 
                        class="glass-dark px-4 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    â† <span data-i18n="prevPage">ä¸Šä¸€é </span>
                </button>
                <span id="pageInfo" class="text-slate-300"></span>
                <button onclick="loadPracticeRecords(currentPage + 1)" id="nextPageBtn"
                        class="glass-dark px-4 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <span data-i18n="nextPage">ä¸‹ä¸€é </span> â†’
                </button>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ¶è©³æƒ…Modal -->
    <div id="userModal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 hidden z-50" onclick="closeUserModal(event)">
        <div class="glass rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-slate-100" data-i18n="userDetailsTitle">ç”¨æˆ¶è©³æƒ…</h3>
                <button onclick="closeUserModal()" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
            </div>
            <div id="userModalContent">
                <!-- å‹•æ…‹å…§å®¹ -->
            </div>
        </div>
    </div>

    <!-- å‰µå»º/ç·¨è¼¯é¡Œç›® Modal -->
    <div id="questionModal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 hidden z-50" onclick="closeQuestionModal(event)">
        <div class="glass rounded-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-slate-100" id="questionModalTitle">Create New Question</h3>
                <button onclick="closeQuestionModal()" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
            </div>
            
            <form id="questionForm" class="space-y-4">
                <input type="hidden" id="editQuestionId" value="">
                
                <!-- æ¦‚å¿µé¸æ“‡ -->
                <div>
                    <label class="block text-slate-300 text-sm font-medium mb-2">Statistical Concept *</label>
                    <select id="qConcept" required class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="">Select a concept...</option>
                        <option value="Descriptive Statistics">Descriptive Statistics</option>
                        <option value="Standard Deviation">Standard Deviation</option>
                        <option value="One-Sample t-Test">One-Sample t-Test</option>
                        <option value="Independent Samples t-Test">Independent Samples t-Test</option>
                        <option value="Paired Samples t-Test">Paired Samples t-Test</option>
                        <option value="Correlation Analysis">Correlation Analysis</option>
                        <option value="Simple Regression">Simple Regression</option>
                        <option value="Chi-Square Test">Chi-Square Test</option>
                    </select>
                </div>

                <!-- é¡Œå‹é¸æ“‡ -->
                <div>
                    <label class="block text-slate-300 text-sm font-medium mb-2">Question Type *</label>
                    <select id="qType" required onchange="toggleOptionsField()" class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="">Select type...</option>
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="true_false">True/False</option>
                        <option value="fill_blank">Fill in the Blank</option>
                        <option value="open_ended">Open-Ended (AI Scoring)</option>
                    </select>
                </div>

                <!-- é›£åº¦é¸æ“‡ -->
                <div>
                    <label class="block text-slate-300 text-sm font-medium mb-2">Difficulty Level *</label>
                    <div class="flex gap-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="qDifficulty" value="1" class="w-4 h-4 text-blue-500">
                            <span class="text-blue-400">Basic</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="qDifficulty" value="2" checked class="w-4 h-4 text-yellow-500">
                            <span class="text-yellow-400">Medium</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="qDifficulty" value="3" class="w-4 h-4 text-red-500">
                            <span class="text-red-400">Advanced</span>
                        </label>
                    </div>
                </div>

                <!-- é¡Œç›®å…§å®¹ -->
                <div>
                    <label class="block text-slate-300 text-sm font-medium mb-2">Question Text *</label>
                    <textarea id="qText" required rows="4" placeholder="Enter your question here. You can use LaTeX for math: $x^2$, $$\sum_{i=1}^n x_i$$" 
                              class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none"></textarea>
                </div>

                <!-- é¸é …ï¼ˆåƒ…é¸æ“‡é¡Œé¡¯ç¤ºï¼‰ -->
                <div id="optionsContainer" class="hidden">
                    <label class="block text-slate-300 text-sm font-medium mb-2">Options (for Multiple Choice)</label>
                    <div class="space-y-2">
                        <input type="text" id="optionA" placeholder="A. First option" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <input type="text" id="optionB" placeholder="B. Second option" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <input type="text" id="optionC" placeholder="C. Third option" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <input type="text" id="optionD" placeholder="D. Fourth option" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                </div>

                <!-- æ­£ç¢ºç­”æ¡ˆ -->
                <div>
                    <label class="block text-slate-300 text-sm font-medium mb-2">Correct Answer *</label>
                    <textarea id="qAnswer" required rows="2" placeholder="Enter the correct answer. For multiple choice: A, B, C, or D. For true/false: True or False. For open-ended: provide a model answer for AI reference."
                              class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none"></textarea>
                </div>

                <!-- è§£é‡‹ -->
                <div>
                    <label class="block text-slate-300 text-sm font-medium mb-2">Explanation (Optional)</label>
                    <textarea id="qExplanation" rows="3" placeholder="Explain why this is the correct answer..."
                              class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none"></textarea>
                </div>

                <!-- æäº¤æŒ‰éˆ• -->
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeQuestionModal()" class="px-6 py-2 bg-slate-600/50 text-slate-200 rounded-lg hover:bg-slate-500/50 transition">
                        Cancel
                    </button>
                    <button type="submit" id="saveQuestionBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition font-medium">
                        Save Question
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- æŸ¥çœ‹é¡Œç›®è©³æƒ… Modal -->
    <div id="questionDetailModal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 hidden z-50" onclick="closeQuestionDetailModal(event)">
        <div class="glass rounded-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-slate-100">Question Details</h3>
                <button onclick="closeQuestionDetailModal()" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
            </div>
            <div id="questionDetailContent">
                <!-- å‹•æ…‹å…§å®¹ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let allUsers = [];
        let systemStats = null;
        let allPracticeRecords = [];
        let filteredRecords = [];
        let currentPage = 1;
        let totalPages = 1;
        let practiceStats = null;

        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        function checkAdminAuth() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (!currentUser.role || currentUser.role !== 'admin') {
                alert(langManager.getCurrentLanguage() === 'zh-TW' ? 'ç„¡æ¬Šè¨ªå•æ­¤é é¢' : 'No permission to access this page');
                window.location.href = '/';
                return false;
            }
            return true;
        }

        // ç®¡ç†å“¡ç™»å‡º
        function logoutAdmin() {
            if (confirm(langManager.getCurrentLanguage() === 'zh-TW' ? 'ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ' : 'Confirm logout?')) {
                localStorage.removeItem('currentUser');
                window.location.href = '/';
            }
        }

        // ç²å–ç³»çµ±çµ±è¨ˆ
        async function loadSystemStats() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch('/api/admin/stats/overview', {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    systemStats = data;
                    displaySystemStats(data.overview);
                }
            } catch (error) {
                console.error('ç²å–ç³»çµ±çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºç³»çµ±çµ±è¨ˆ
        function displaySystemStats(stats) {
            document.getElementById('totalUsers').textContent = stats.totalUsers;
            document.getElementById('totalQuestions').textContent = stats.totalQuestions;
            document.getElementById('totalAnswers').textContent = stats.totalAnswers;
            document.getElementById('activeToday').textContent = stats.activeToday;
        }

        // ç²å–æ‰€æœ‰ç”¨æˆ¶
        async function loadUsers() {
            try {
                document.getElementById('loadingUsers').classList.remove('hidden');
                document.getElementById('usersContainer').classList.add('hidden');
                document.getElementById('noUsers').classList.add('hidden');

                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch('/api/admin/users', {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    allUsers = data.users;
                    displayUsers(allUsers);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('ç²å–ç”¨æˆ¶åˆ—è¡¨å¤±æ•—:', error);
                document.getElementById('loadingUsers').classList.add('hidden');
                document.getElementById('noUsers').classList.remove('hidden');
            }
        }

        // é¡¯ç¤ºç”¨æˆ¶åˆ—è¡¨
        function displayUsers(users) {
            document.getElementById('loadingUsers').classList.add('hidden');
            
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.classList.add('hidden');
                document.getElementById('noUsers').classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            document.getElementById('noUsers').classList.add('hidden');

            const viewDetailsText = langManager.t('viewDetails', 'admin');
            const practiceCountText = langManager.t('practiceCountLabel', 'admin');
            const accuracyText = langManager.t('accuracyLabel', 'admin');
            const conceptsText = langManager.t('learningConcepts', 'admin');
            const masteryText = langManager.t('masteryLabel', 'admin');
            const sessionsText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æ¬¡æœƒè©±' : 'sessions';
            const messagesText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æ¢æ¶ˆæ¯' : 'messages';
            const lastActivityText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æœ€å¾Œæ´»å‹•' : 'Last Activity';
            
            container.innerHTML = users.map(user => `
                <div class="user-card glass-dark rounded-xl p-4 border border-slate-600/40">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                ${user.username.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-slate-100">${user.username}</h3>
                                <p class="text-xs text-slate-400">${formatDate(user.created_at)}</p>
                            </div>
                        </div>
                        <button onclick="showUserDetails('${user.user_id}')" class="text-blue-400 hover:text-blue-300 text-sm font-medium">
                            ${viewDetailsText}
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="text-center p-2 bg-slate-700/30 rounded">
                            <div class="text-xl font-bold text-blue-400">${user.stats.totalPractice}</div>
                            <div class="text-xs text-slate-400">${practiceCountText}</div>
                        </div>
                        <div class="text-center p-2 bg-slate-700/30 rounded">
                            <div class="text-xl font-bold text-green-400">${user.stats.accuracy}%</div>
                            <div class="text-xs text-slate-400">${accuracyText}</div>
                        </div>
                        <div class="text-center p-2 bg-slate-700/30 rounded">
                            <div class="text-xl font-bold text-purple-400">${user.stats.totalConcepts}</div>
                            <div class="text-xs text-slate-400">${conceptsText}</div>
                        </div>
                        <div class="text-center p-2 bg-slate-700/30 rounded">
                            <div class="text-xl font-bold text-yellow-400">${user.stats.averageMastery}%</div>
                            <div class="text-xs text-slate-400">${masteryText}</div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between text-xs text-slate-400">
                        <span>ğŸ’¬ ${user.stats.totalSessions} ${sessionsText}</span>
                        <span>ğŸ“ ${user.stats.totalMessages} ${messagesText}</span>
                    </div>
                    
                    ${user.stats.lastActivity ? `
                    <div class="mt-2 pt-2 border-t border-slate-600/40 text-xs text-slate-400">
                        ${lastActivityText}: ${formatDate(user.stats.lastActivity)}
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // æœç´¢éæ¿¾ç”¨æˆ¶
        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm)
            );
            displayUsers(filtered);
        }

        // åˆ·æ–°ç”¨æˆ¶åˆ—è¡¨
        function refreshUsers() {
            loadUsers();
            loadSystemStats();
        }

        // ========== AI Practice çµ±è¨ˆå’Œè¨˜éŒ„ ==========

        // è¼‰å…¥ AI Practice çµ±è¨ˆ
        async function loadPracticeStats() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch('/api/admin/practice-stats', {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    practiceStats = data.stats;
                    displayPracticeStats(data.stats);
                    populateConceptFilter(data.stats.byConcept);
                }
            } catch (error) {
                console.error('ç²å–ç·´ç¿’çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // æ¦‚å¿µåç¨±æ˜ å°„ï¼ˆä¸­æ–‡ -> è‹±æ–‡ï¼‰
        const CONCEPT_NAME_MAP = {
            'æè¿°çµ±è¨ˆ': 'Descriptive Statistics',
            'æè¿°ç»Ÿè®¡': 'Descriptive Statistics',
            'æ¨™æº–å·®': 'Standard Deviation',
            'æ ‡å‡†å·®': 'Standard Deviation',
            'å–®æ¨£æœ¬tæª¢å®š': 'One-Sample t-Test',
            'å•æ ·æœ¬tæ£€å®š': 'One-Sample t-Test',
            'ç¨ç«‹æ¨£æœ¬tæª¢å®š': 'Independent Samples t-Test',
            'ç‹¬ç«‹æ ·æœ¬tæ£€å®š': 'Independent Samples t-Test',
            'é…å°æ¨£æœ¬tæª¢å®š': 'Paired Samples t-Test',
            'é…å¯¹æ ·æœ¬tæ£€å®š': 'Paired Samples t-Test',
            'ç›¸é—œåˆ†æ': 'Correlation Analysis',
            'ç›¸å…³åˆ†æ': 'Correlation Analysis',
            'ç°¡å–®è¿´æ­¸': 'Simple Regression',
            'ç®€å•å›å½’': 'Simple Regression',
            'å¡æ–¹æª¢å®š': 'Chi-Square Test',
            'å¡æ–¹æ£€å®š': 'Chi-Square Test'
        };

        // å°‡æ¦‚å¿µåç¨±è½‰ç‚ºè‹±æ–‡
        function toEnglishConcept(conceptName) {
            return CONCEPT_NAME_MAP[conceptName] || conceptName;
        }

        // é¡¯ç¤ºç·´ç¿’çµ±è¨ˆ
        function displayPracticeStats(stats) {
            const isZh = langManager.getCurrentLanguage() === 'zh-TW';
            
            // æ¦‚å¿µçµ±è¨ˆ
            const conceptContainer = document.getElementById('conceptStatsContainer');
            conceptContainer.innerHTML = stats.byConcept.map(c => {
                const conceptName = toEnglishConcept(c.concept);
                return `
                <div class="stat-card glass-dark rounded-lg p-3 border border-slate-600/30">
                    <div class="text-sm font-medium text-slate-200 mb-1 truncate" title="${conceptName}">${conceptName}</div>
                    <div class="flex items-end justify-between">
                        <div>
                            <span class="text-lg font-bold text-blue-400">${c.total}</span>
                            <span class="text-xs text-slate-400 ml-1">${isZh ? 'é¡Œ' : 'Q'}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-semibold ${parseFloat(c.accuracy) >= 60 ? 'text-green-400' : 'text-orange-400'}">${c.accuracy}%</span>
                        </div>
                    </div>
                    <div class="mt-2 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                        <div class="h-full ${parseFloat(c.accuracy) >= 60 ? 'bg-green-500' : 'bg-orange-500'}" style="width: ${c.accuracy}%"></div>
                    </div>
                </div>
            `}).join('');

            // é›£åº¦çµ±è¨ˆ
            const difficultyContainer = document.getElementById('difficultyStatsContainer');
            const diffColors = ['blue', 'yellow', 'red'];
            const diffNames = isZh ? ['åŸºç¤', 'ä¸­ç´š', 'é€²éš'] : ['Basic', 'Medium', 'Advanced'];
            difficultyContainer.innerHTML = stats.byDifficulty.map((d, i) => `
                <div class="stat-card glass-dark rounded-lg p-4 border border-${diffColors[i]}-500/30 text-center">
                    <div class="text-sm font-medium text-${diffColors[i]}-400 mb-2">${diffNames[i]}</div>
                    <div class="text-2xl font-bold text-slate-100">${d.total}</div>
                    <div class="text-sm text-slate-400 mt-1">${isZh ? 'æ­£ç¢ºç‡' : 'Accuracy'}: ${d.accuracy}%</div>
                    <div class="mt-2 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                        <div class="h-full bg-${diffColors[i]}-500" style="width: ${d.accuracy}%"></div>
                    </div>
                </div>
            `).join('');

            // é¡Œå‹çµ±è¨ˆ
            const typeContainer = document.getElementById('typeStatsContainer');
            const typeNames = {
                'multiple_choice': isZh ? 'é¸æ“‡é¡Œ' : 'Multiple Choice',
                'case_study': isZh ? 'æ¡ˆä¾‹åˆ†æ' : 'Case Study',
                'calculation': isZh ? 'è¨ˆç®—é¡Œ' : 'Calculation',
                'interpretation': isZh ? 'è§£è®€é¡Œ' : 'Interpretation',
                'short_answer': isZh ? 'ç°¡ç­”é¡Œ' : 'Short Answer'
            };
            typeContainer.innerHTML = stats.byType.map(t => `
                <div class="stat-card glass-dark rounded-lg p-3 border border-purple-500/30">
                    <div class="text-sm font-medium text-purple-400 mb-1">${typeNames[t.type] || t.type}</div>
                    <div class="flex items-end justify-between">
                        <span class="text-lg font-bold text-slate-100">${t.total}</span>
                        <span class="text-sm ${parseFloat(t.accuracy) >= 60 ? 'text-green-400' : 'text-orange-400'}">${t.accuracy}%</span>
                    </div>
                </div>
            `).join('');
        }

        // å¡«å……æ¦‚å¿µç¯©é¸å™¨
        function populateConceptFilter(concepts) {
            const select = document.getElementById('conceptFilter');
            select.innerHTML = `<option value="">All Concepts</option>` +
                concepts.map(c => {
                    const englishName = toEnglishConcept(c.concept);
                    return `<option value="${c.concept}">${englishName}</option>`;
                }).join('');
        }

        // è¼‰å…¥ç­”é¡Œè¨˜éŒ„
        async function loadPracticeRecords(page = 1) {
            try {
                document.getElementById('loadingRecords').classList.remove('hidden');
                document.getElementById('practiceRecordsContainer').classList.add('hidden');
                document.getElementById('noRecords').classList.add('hidden');

                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch(`/api/admin/practice-records?page=${page}&limit=20`, {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    allPracticeRecords = data.records;
                    filteredRecords = [...allPracticeRecords];
                    currentPage = data.pagination.page;
                    totalPages = data.pagination.totalPages;
                    
                    filterPracticeRecords();
                    updatePagination(data.pagination);
                }
            } catch (error) {
                console.error('ç²å–ç­”é¡Œè¨˜éŒ„å¤±æ•—:', error);
                document.getElementById('loadingRecords').classList.add('hidden');
                document.getElementById('noRecords').classList.remove('hidden');
            }
        }

        // ç¯©é¸ç­”é¡Œè¨˜éŒ„
        function filterPracticeRecords() {
            const conceptFilter = document.getElementById('conceptFilter').value.toLowerCase();
            const difficultyFilter = document.getElementById('difficultyFilterSelect').value;
            const correctFilter = document.getElementById('correctFilter').value;
            const userFilter = document.getElementById('userFilter').value.toLowerCase();

            filteredRecords = allPracticeRecords.filter(record => {
                const matchConcept = !conceptFilter || 
                    (record.practice_questions?.concept_name?.toLowerCase().includes(conceptFilter));
                const matchDifficulty = !difficultyFilter || 
                    (record.practice_questions?.difficulty_level === parseInt(difficultyFilter));
                const matchCorrect = correctFilter === '' || 
                    (record.is_correct === (correctFilter === 'true'));
                const matchUser = !userFilter || 
                    (record.users?.username?.toLowerCase().includes(userFilter));
                
                return matchConcept && matchDifficulty && matchCorrect && matchUser;
            });

            displayPracticeRecords(filteredRecords);
        }

        // é¡¯ç¤ºç­”é¡Œè¨˜éŒ„
        function displayPracticeRecords(records) {
            document.getElementById('loadingRecords').classList.add('hidden');
            
            const container = document.getElementById('practiceRecordsContainer');
            
            if (records.length === 0) {
                container.classList.add('hidden');
                document.getElementById('noRecords').classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            document.getElementById('noRecords').classList.add('hidden');

            const isZh = langManager.getCurrentLanguage() === 'zh-TW';
            const diffNames = { 1: 'Basic', 2: 'Medium', 3: 'Advanced' };
            const typeNames = {
                'multiple_choice': 'MC',
                'case_study': 'Case',
                'calculation': 'Calc',
                'interpretation': 'Interp',
                'short_answer': 'Short'
            };

            container.innerHTML = records.map(record => {
                const q = record.practice_questions || {};
                const username = record.users?.username || 'Unknown';
                const questionText = q.question_text || 'N/A';
                const shortQuestion = questionText.length > 100 ? questionText.substring(0, 100) + '...' : questionText;
                const conceptName = toEnglishConcept(q.concept_name) || 'N/A';
                
                return `
                <div class="glass-dark rounded-xl p-4 border border-slate-600/40 hover:border-slate-500/60 transition">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <!-- ç”¨æˆ¶å’Œæ™‚é–“ -->
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                    ${username.charAt(0).toUpperCase()}
                                </div>
                                <span class="font-medium text-slate-200">${username}</span>
                                <span class="text-xs text-slate-500">â€¢</span>
                                <span class="text-xs text-slate-400">${formatDate(record.answered_at)}</span>
                            </div>
                            
                            <!-- é¡Œç›® -->
                            <p class="text-slate-300 text-sm mb-2 leading-relaxed">${shortQuestion}</p>
                            
                            <!-- æ¨™ç±¤ -->
                            <div class="flex flex-wrap items-center gap-2 text-xs">
                                <span class="px-2 py-1 rounded bg-blue-500/20 text-blue-300">${conceptName}</span>
                                <span class="px-2 py-1 rounded bg-slate-600/40 text-slate-300">${diffNames[q.difficulty_level] || 'N/A'}</span>
                                <span class="px-2 py-1 rounded bg-purple-500/20 text-purple-300">${typeNames[q.question_type] || q.question_type || 'N/A'}</span>
                                ${record.time_taken ? `<span class="text-slate-400">â± ${record.time_taken}s</span>` : ''}
                            </div>
                        </div>
                        
                        <!-- çµæœæ¨™è¨˜ -->
                        <div class="flex flex-col items-center gap-1">
                            <span class="text-2xl">${record.is_correct ? 'âœ…' : 'âŒ'}</span>
                            <span class="text-xs ${record.is_correct ? 'text-green-400' : 'text-red-400'}">${record.is_correct ? (isZh ? 'æ­£ç¢º' : 'Correct') : (isZh ? 'éŒ¯èª¤' : 'Wrong')}</span>
                        </div>
                    </div>
                    
                    <!-- å±•é–‹æŸ¥çœ‹è©³æƒ… -->
                    <details class="mt-3">
                        <summary class="text-xs text-blue-400 cursor-pointer hover:text-blue-300">${isZh ? 'æŸ¥çœ‹è©³æƒ…' : 'View Details'}</summary>
                        <div class="mt-3 space-y-2 text-sm">
                            <div class="p-3 bg-slate-700/30 rounded-lg">
                                <div class="text-slate-400 text-xs mb-1">${isZh ? 'å®Œæ•´é¡Œç›®' : 'Full Question'}:</div>
                                <div class="text-slate-200">${questionText}</div>
                            </div>
                            <div class="p-3 bg-slate-700/30 rounded-lg">
                                <div class="text-slate-400 text-xs mb-1">${isZh ? 'ç”¨æˆ¶ç­”æ¡ˆ' : 'User Answer'}:</div>
                                <div class="${record.is_correct ? 'text-green-300' : 'text-red-300'}">${record.user_answer || 'N/A'}</div>
                            </div>
                            <div class="p-3 bg-green-500/10 rounded-lg border border-green-500/30">
                                <div class="text-green-400 text-xs mb-1">${isZh ? 'æ­£ç¢ºç­”æ¡ˆ' : 'Correct Answer'}:</div>
                                <div class="text-green-200">${q.correct_answer || 'N/A'}</div>
                            </div>
                            ${q.explanation ? `
                            <div class="p-3 bg-blue-500/10 rounded-lg border border-blue-500/30">
                                <div class="text-blue-400 text-xs mb-1">${isZh ? 'è§£é‡‹' : 'Explanation'}:</div>
                                <div class="text-slate-300">${q.explanation}</div>
                            </div>
                            ` : ''}
                        </div>
                    </details>
                </div>
                `;
            }).join('');
        }

        // æ›´æ–°åˆ†é 
        function updatePagination(pagination) {
            const container = document.getElementById('paginationContainer');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const isZh = langManager.getCurrentLanguage() === 'zh-TW';

            if (pagination.totalPages > 1) {
                container.classList.remove('hidden');
                pageInfo.textContent = isZh 
                    ? `ç¬¬ ${pagination.page} / ${pagination.totalPages} é  (å…± ${pagination.total} æ¢)`
                    : `Page ${pagination.page} / ${pagination.totalPages} (${pagination.total} total)`;
                
                prevBtn.disabled = pagination.page <= 1;
                nextBtn.disabled = pagination.page >= pagination.totalPages;
            } else {
                container.classList.add('hidden');
            }
        }

        // åˆ·æ–°ç­”é¡Œè¨˜éŒ„
        function refreshPracticeRecords() {
            loadPracticeStats();
            loadPracticeRecords(1);
        }

        // é¡¯ç¤ºç”¨æˆ¶è©³æƒ…
        async function showUserDetails(userId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch(`/api/admin/users/${userId}/details`, {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    displayUserDetails(data);
                    document.getElementById('userModal').classList.remove('hidden');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('ç²å–ç”¨æˆ¶è©³æƒ…å¤±æ•—:', error);
                alert(langManager.getCurrentLanguage() === 'zh-TW' ? 'ç²å–ç”¨æˆ¶è©³æƒ…å¤±æ•—' : 'Failed to load user details');
            }
        }

        // ç•¶å‰æŸ¥çœ‹çš„ç”¨æˆ¶IDï¼ˆç”¨æ–¼å°å‡ºï¼‰
        let currentViewingUserId = null;

        // é¡¯ç¤ºç”¨æˆ¶è©³æƒ…Modalå…§å®¹
        function displayUserDetails(data) {
            const { user, progress, recentAnswers, recentSessions } = data;
            currentViewingUserId = user.user_id;
            
            const basicInfoText = 'Basic Info';
            const usernameText = 'Username';
            const userIdText = 'User ID';
            const createdAtText = 'Created At';
            const lastActiveText = 'Last Active';
            const levelText = 'Level';
            const emailText = langManager.getCurrentLanguage() === 'zh-TW' ? 'é›»éƒµ' : 'Email';
            const notSetText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æœªè¨­ç½®' : 'Not set';
            const learningProgressTitle = langManager.t('learningProgressTitle', 'admin');
            const conceptsText = langManager.getCurrentLanguage() === 'zh-TW' ? 'å€‹æ¦‚å¿µ' : 'concepts';
            const practiceText = langManager.getCurrentLanguage() === 'zh-TW' ? 'ç·´ç¿’' : 'Practiced';
            const timesText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æ¬¡' : 'times';
            const correctText = langManager.getCurrentLanguage() === 'zh-TW' ? 'ç­”å°' : 'Correct';
            const questionsText = langManager.getCurrentLanguage() === 'zh-TW' ? 'é¡Œ' : 'questions';
            const noProgressText = langManager.t('noProgressData', 'admin');
            const recentAnswersText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æœ€è¿‘ç­”é¡Œè¨˜éŒ„' : 'Recent Answers';
            
            const content = `
                <div class="space-y-6">
                    <!-- ç”¨æˆ¶åŸºæœ¬ä¿¡æ¯ -->
                    <div class="glass-dark rounded-xl p-4">
                        <h4 class="font-semibold text-slate-100 mb-3 flex items-center gap-2">
                            <span>ğŸ‘¤</span> ${basicInfoText}
                        </h4>
                        <div class="grid md:grid-cols-2 gap-3 text-sm">
                            <div><span class="text-slate-400">${usernameText}:</span> <span class="text-slate-100">${user.username}</span></div>
                            <div><span class="text-slate-400">${userIdText}:</span> <span class="text-slate-300 text-xs">${user.user_id}</span></div>
                            <div><span class="text-slate-400">${createdAtText}:</span> <span class="text-slate-100">${formatDate(user.created_at)}</span></div>
                            <div><span class="text-slate-400">${lastActiveText}:</span> <span class="text-slate-100">${formatDate(user.last_active)}</span></div>
                            <div><span class="text-slate-400">${levelText}:</span> <span class="text-slate-100">Level ${user.learning_level}</span></div>
                            <div><span class="text-slate-400">${emailText}:</span> <span class="text-slate-100">${user.email || notSetText}</span></div>
                        </div>
                    </div>

                    <!-- å­¸ç¿’é€²åº¦ -->
                    <div class="glass-dark rounded-xl p-4">
                        <h4 class="font-semibold text-slate-100 mb-3 flex items-center gap-2">
                            <span>ğŸ“š</span> ${learningProgressTitle} (${progress.length} ${conceptsText})
                        </h4>
                        <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                            ${progress.length > 0 ? progress.map(p => `
                                <div class="bg-slate-700/30 rounded p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-slate-100 font-medium text-sm">${p.concept_name}</span>
                                        <span class="text-slate-300 text-sm">${(parseFloat(p.mastery_level) * 100).toFixed(0)}%</span>
                                    </div>
                                    <div class="w-full bg-slate-600 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full" style="width: ${parseFloat(p.mastery_level) * 100}%"></div>
                                    </div>
                                    <div class="flex items-center justify-between mt-2 text-xs text-slate-400">
                                        <span>${practiceText} ${p.practice_count} ${timesText}</span>
                                        <span>${correctText} ${p.correct_answers} ${questionsText}</span>
                                    </div>
                                </div>
                            `).join('') : `<p class="text-slate-400 text-sm text-center py-4">${noProgressText}</p>`}
                        </div>
                    </div>

                    <!-- æœ€è¿‘ç­”é¡Œè¨˜éŒ„ -->
                    <div class="glass-dark rounded-xl p-4">
                        <h4 class="font-semibold text-slate-100 mb-3 flex items-center gap-2">
                            <span>âœï¸</span> ${recentAnswersText}
                        </h4>
                        <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                            ${recentAnswers.length > 0 ? recentAnswers.slice(0, 10).map(a => `
                                <div class="bg-slate-700/30 rounded p-3 text-sm">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex-1">
                                            <p class="text-slate-100 mb-1">${a.practice_questions?.question_text?.substring(0, 80)}...</p>
                                            <div class="flex items-center gap-2 text-xs text-slate-400">
                                                <span>${a.practice_questions?.concept_name}</span>
                                                <span>â€¢</span>
                                                <span>${langManager.getCurrentLanguage() === 'zh-TW' ? 'é›£åº¦' : 'Difficulty'} ${a.practice_questions?.difficulty_level}</span>
                                                <span>â€¢</span>
                                                <span>${formatDate(a.answered_at)}</span>
                                            </div>
                                        </div>
                                        <span class="${a.is_correct ? 'text-green-400' : 'text-red-400'} font-medium ml-2">
                                            ${a.is_correct ? 'âœ“' : 'âœ—'}
                                        </span>
                                    </div>
                                </div>
                            `).join('') : `<p class="text-slate-400 text-sm text-center py-4">No answer records</p>`}
                        </div>
                    </div>

                    <!-- èŠå¤©æœƒè©± -->
                    <div class="glass-dark rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-100 flex items-center gap-2">
                                <span>ğŸ’¬</span> Chat Session History
                            </h4>
                            <button onclick="exportUserChats('${user.user_id}')" class="text-xs bg-blue-500/20 text-blue-400 px-3 py-1 rounded hover:bg-blue-500/30 transition">
                                ğŸ“¥ Export Chats
                            </button>
                        </div>
                        <div class="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar">
                            ${recentSessions.length > 0 ? recentSessions.map(s => `
                                <div class="bg-slate-700/30 rounded-lg p-3 text-sm cursor-pointer hover:bg-slate-600/40 transition" onclick="loadSessionMessages('${s.session_id}')">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <p class="text-slate-100 font-medium">${s.topic || 'General Conversation'}</p>
                                            <p class="text-xs text-slate-400 mt-1">${formatDate(s.start_time)}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-slate-300">${s.message_count || 0} messages</p>
                                            <p class="text-xs ${s.is_active ? 'text-green-400' : 'text-slate-400'} mt-1">
                                                ${s.is_active ? 'Active' : 'Ended'}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-xs text-blue-400 flex items-center gap-1">
                                        <span>ğŸ‘ï¸</span> Click to view messages
                                    </div>
                                </div>
                            `).join('') : `<p class="text-slate-400 text-sm text-center py-4">No session records</p>`}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('userModalContent').innerHTML = content;
        }

        // è¼‰å…¥æœƒè©±çš„è©³ç´°æ¶ˆæ¯
        async function loadSessionMessages(sessionId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch(`/api/admin/sessions/${sessionId}/messages`, {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    showSessionMessagesModal(data.session, data.messages);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
                alert('Failed to load chat messages');
            }
        }

        // é¡¯ç¤ºæœƒè©±æ¶ˆæ¯è©³æƒ…
        function showSessionMessagesModal(session, messages) {
            const username = session.users?.username || 'Unknown';
            const modalContent = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-100">${session.topic || 'General Conversation'}</h4>
                            <p class="text-sm text-slate-400">User: ${username} â€¢ ${formatDate(session.start_time)} â€¢ ${messages.length} messages</p>
                        </div>
                        <button onclick="displayUserDetails({user: {user_id: '${session.user_id}'}, progress: [], recentAnswers: [], recentSessions: []}); showUserDetails('${session.user_id}')" class="text-sm text-blue-400 hover:text-blue-300">
                            â† Back
                        </button>
                    </div>
                    
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar p-2">
                        ${messages.length > 0 ? messages.map(m => `
                            <div class="flex ${m.sender_type === 'user' ? 'justify-end' : 'justify-start'}">
                                <div class="max-w-[80%] ${m.sender_type === 'user' 
                                    ? 'bg-blue-600/40 border-blue-500/50' 
                                    : 'bg-slate-700/60 border-slate-600/50'} border rounded-xl p-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-medium ${m.sender_type === 'user' ? 'text-blue-300' : 'text-green-300'}">
                                            ${m.sender_type === 'user' ? 'ğŸ‘¤ User' : 'ğŸ¤– AI'}
                                        </span>
                                        <span class="text-xs text-slate-500">${new Date(m.timestamp).toLocaleString()}</span>
                                    </div>
                                    <div class="text-sm text-slate-200 whitespace-pre-wrap break-words">${escapeHtml(m.content)}</div>
                                </div>
                            </div>
                        `).join('') : '<p class="text-slate-400 text-center py-8">No messages in this session</p>'}
                    </div>
                </div>
            `;
            
            document.getElementById('userModalContent').innerHTML = modalContent;
        }

        // HTML è½‰ç¾©å‡½æ•¸
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å°å‡ºå–®å€‹ç”¨æˆ¶çš„èŠå¤©è¨˜éŒ„
        async function exportUserChats(userId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch(`/api/admin/users/${userId}/export-chats`, {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    downloadJson(data, `chat_export_${data.user.username}_${new Date().toISOString().split('T')[0]}.json`);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export chat records');
            }
        }

        // å°å‡ºæ‰€æœ‰ç”¨æˆ¶çš„èŠå¤©è¨˜éŒ„
        async function exportAllChats() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch('/api/admin/export-all-chats', {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    downloadJson(data, `all_chats_export_${new Date().toISOString().split('T')[0]}.json`);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export chat records');
            }
        }

        // ä¸‹è¼‰ JSON æ–‡ä»¶
        function downloadJson(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ========== è€å¸«é¡Œç›®ç®¡ç†åŠŸèƒ½ ==========
        let allTeacherQuestions = [];
        let teacherQuestionStats = null;

        // è¼‰å…¥è€å¸«é¡Œç›®çµ±è¨ˆ
        async function loadTeacherQuestionStats() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch('/api/admin/teacher-questions-stats', {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    teacherQuestionStats = data.stats;
                    displayTeacherStats(data.stats);
                }
            } catch (error) {
                console.error('Failed to load teacher question stats:', error);
            }
        }

        // é¡¯ç¤ºè€å¸«é¡Œç›®çµ±è¨ˆ
        function displayTeacherStats(stats) {
            document.getElementById('teacherTotalQuestions').textContent = stats.totalQuestions;
            document.getElementById('teacherActiveQuestions').textContent = stats.activeQuestions;
            document.getElementById('teacherTotalAnswers').textContent = stats.totalAnswers;
            document.getElementById('teacherAvgAccuracy').textContent = stats.accuracy + '%';
        }

        // è¼‰å…¥è€å¸«é¡Œç›®åˆ—è¡¨
        async function loadTeacherQuestions() {
            try {
                document.getElementById('loadingTeacherQuestions').classList.remove('hidden');
                document.getElementById('teacherQuestionsContainer').classList.add('hidden');
                document.getElementById('noTeacherQuestions').classList.add('hidden');

                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch('/api/admin/teacher-questions?limit=50', {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    allTeacherQuestions = data.questions;
                    displayTeacherQuestions(data.questions);
                    loadTeacherQuestionStats();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Failed to load teacher questions:', error);
                document.getElementById('loadingTeacherQuestions').classList.add('hidden');
                document.getElementById('noTeacherQuestions').classList.remove('hidden');
            }
        }

        // é¡¯ç¤ºè€å¸«é¡Œç›®åˆ—è¡¨
        function displayTeacherQuestions(questions) {
            document.getElementById('loadingTeacherQuestions').classList.add('hidden');
            
            const container = document.getElementById('teacherQuestionsContainer');
            
            if (questions.length === 0) {
                container.classList.add('hidden');
                document.getElementById('noTeacherQuestions').classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            document.getElementById('noTeacherQuestions').classList.add('hidden');

            const diffNames = { 1: 'Basic', 2: 'Medium', 3: 'Advanced' };
            const diffColors = { 1: 'blue', 2: 'yellow', 3: 'red' };
            const typeNames = {
                'multiple_choice': 'Multiple Choice',
                'true_false': 'True/False',
                'fill_blank': 'Fill in Blank',
                'open_ended': 'Open-Ended'
            };

            container.innerHTML = questions.map(q => {
                const shortText = q.question_text.length > 120 ? q.question_text.substring(0, 120) + '...' : q.question_text;
                const diffColor = diffColors[q.difficulty_level] || 'slate';
                return `
                <div class="glass-dark rounded-xl p-4 border ${q.is_active ? 'border-slate-600/40' : 'border-red-500/30 opacity-60'} hover:border-slate-500/60 transition">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <!-- æ¨™ç±¤ -->
                            <div class="flex flex-wrap items-center gap-2 mb-2 text-xs">
                                <span class="px-2 py-1 rounded bg-green-500/20 text-green-300">${q.concept_name || 'N/A'}</span>
                                <span class="px-2 py-1 rounded bg-${diffColor}-500/20 text-${diffColor}-300">${diffNames[q.difficulty_level]}</span>
                                <span class="px-2 py-1 rounded bg-purple-500/20 text-purple-300">${typeNames[q.question_type] || q.question_type}</span>
                                ${!q.is_active ? '<span class="px-2 py-1 rounded bg-red-500/20 text-red-400">Inactive</span>' : ''}
                            </div>
                            
                            <!-- é¡Œç›®å…§å®¹ -->
                            <p class="text-slate-200 text-sm mb-2 leading-relaxed">${escapeHtml(shortText)}</p>
                            
                            <!-- æ™‚é–“ -->
                            <p class="text-xs text-slate-500">Created: ${formatDate(q.created_at)}</p>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="flex flex-col gap-2">
                            <button onclick="viewQuestionDetail('${q.question_id}')" class="text-xs px-3 py-1.5 bg-blue-500/20 text-blue-400 rounded hover:bg-blue-500/30 transition">
                                ğŸ‘ï¸ View
                            </button>
                            <button onclick="editQuestion('${q.question_id}')" class="text-xs px-3 py-1.5 bg-yellow-500/20 text-yellow-400 rounded hover:bg-yellow-500/30 transition">
                                âœï¸ Edit
                            </button>
                            <button onclick="toggleQuestionStatus('${q.question_id}')" class="text-xs px-3 py-1.5 ${q.is_active ? 'bg-orange-500/20 text-orange-400' : 'bg-green-500/20 text-green-400'} rounded hover:opacity-80 transition">
                                ${q.is_active ? 'â¸ï¸ Disable' : 'â–¶ï¸ Enable'}
                            </button>
                            <button onclick="deleteQuestion('${q.question_id}')" class="text-xs px-3 py-1.5 bg-red-500/20 text-red-400 rounded hover:bg-red-500/30 transition">
                                ğŸ—‘ï¸ Delete
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // æŸ¥çœ‹é¡Œç›®è©³æƒ…
        async function viewQuestionDetail(questionId) {
            const question = allTeacherQuestions.find(q => q.question_id === questionId);
            if (!question) return;

            const diffNames = { 1: 'Basic', 2: 'Medium', 3: 'Advanced' };
            const typeNames = {
                'multiple_choice': 'Multiple Choice',
                'true_false': 'True/False',
                'fill_blank': 'Fill in Blank',
                'open_ended': 'Open-Ended (AI Scoring)'
            };

            let optionsHtml = '';
            if (question.question_type === 'multiple_choice' && question.options) {
                const opts = question.options;
                optionsHtml = `
                    <div class="glass-dark rounded-lg p-4 border border-slate-600/40">
                        <h5 class="text-sm font-medium text-slate-400 mb-2">Options:</h5>
                        <div class="space-y-2">
                            ${Object.entries(opts).map(([key, value]) => `
                                <div class="flex items-center gap-2 ${question.correct_answer.toUpperCase() === key ? 'text-green-400' : 'text-slate-200'}">
                                    <span class="font-bold">${key}.</span> ${escapeHtml(value)}
                                    ${question.correct_answer.toUpperCase() === key ? '<span class="text-green-400">âœ“</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            const content = `
                <div class="space-y-4">
                    <!-- æ¨™ç±¤ -->
                    <div class="flex flex-wrap items-center gap-2 text-sm">
                        <span class="px-3 py-1 rounded-full bg-green-500/20 text-green-300">${question.concept_name}</span>
                        <span class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-300">${diffNames[question.difficulty_level]}</span>
                        <span class="px-3 py-1 rounded-full bg-purple-500/20 text-purple-300">${typeNames[question.question_type]}</span>
                        <span class="px-3 py-1 rounded-full ${question.is_active ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                            ${question.is_active ? 'âœ“ Active' : 'âœ— Inactive'}
                        </span>
                    </div>

                    <!-- é¡Œç›® -->
                    <div class="glass-dark rounded-lg p-4 border border-slate-600/40">
                        <h5 class="text-sm font-medium text-slate-400 mb-2">Question:</h5>
                        <p class="text-slate-100 leading-relaxed">${escapeHtml(question.question_text)}</p>
                    </div>

                    ${optionsHtml}

                    <!-- æ­£ç¢ºç­”æ¡ˆ -->
                    <div class="glass-dark rounded-lg p-4 border border-green-500/30 bg-green-500/5">
                        <h5 class="text-sm font-medium text-green-400 mb-2">Correct Answer:</h5>
                        <p class="text-green-200">${escapeHtml(question.correct_answer)}</p>
                    </div>

                    ${question.explanation ? `
                    <!-- è§£é‡‹ -->
                    <div class="glass-dark rounded-lg p-4 border border-blue-500/30 bg-blue-500/5">
                        <h5 class="text-sm font-medium text-blue-400 mb-2">Explanation:</h5>
                        <p class="text-slate-200">${escapeHtml(question.explanation)}</p>
                    </div>
                    ` : ''}

                    <!-- å…ƒä¿¡æ¯ -->
                    <div class="text-xs text-slate-500 pt-2 border-t border-slate-600/40">
                        <p>Created: ${new Date(question.created_at).toLocaleString()}</p>
                        <p>Question ID: ${question.question_id}</p>
                    </div>

                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div class="flex gap-3 pt-2">
                        <button onclick="closeQuestionDetailModal(); editQuestion('${question.question_id}')" 
                                class="px-4 py-2 bg-yellow-500/20 text-yellow-400 rounded-lg hover:bg-yellow-500/30 transition">
                            âœï¸ Edit
                        </button>
                        <button onclick="closeQuestionDetailModal(); toggleQuestionStatus('${question.question_id}')" 
                                class="px-4 py-2 ${question.is_active ? 'bg-orange-500/20 text-orange-400' : 'bg-green-500/20 text-green-400'} rounded-lg hover:opacity-80 transition">
                            ${question.is_active ? 'â¸ï¸ Disable' : 'â–¶ï¸ Enable'}
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('questionDetailContent').innerHTML = content;
            document.getElementById('questionDetailModal').classList.remove('hidden');
        }

        // é—œé–‰é¡Œç›®è©³æƒ… Modal
        function closeQuestionDetailModal(event) {
            if (!event || event.target.id === 'questionDetailModal') {
                document.getElementById('questionDetailModal').classList.add('hidden');
            }
        }

        // é¡¯ç¤ºå‰µå»ºé¡Œç›®è¡¨å–®
        function showCreateQuestionForm() {
            document.getElementById('questionModalTitle').textContent = 'Create New Question';
            document.getElementById('editQuestionId').value = '';
            document.getElementById('questionForm').reset();
            document.getElementById('optionsContainer').classList.add('hidden');
            document.getElementById('questionModal').classList.remove('hidden');
        }

        // ç·¨è¼¯é¡Œç›®
        async function editQuestion(questionId) {
            const question = allTeacherQuestions.find(q => q.question_id === questionId);
            if (!question) return;

            document.getElementById('questionModalTitle').textContent = 'Edit Question';
            document.getElementById('editQuestionId').value = questionId;
            document.getElementById('qConcept').value = question.concept_name;
            document.getElementById('qType').value = question.question_type;
            document.getElementById('qText').value = question.question_text;
            document.getElementById('qAnswer').value = question.correct_answer;
            document.getElementById('qExplanation').value = question.explanation || '';
            
            // è¨­ç½®é›£åº¦
            const diffRadio = document.querySelector(`input[name="qDifficulty"][value="${question.difficulty_level}"]`);
            if (diffRadio) diffRadio.checked = true;

            // è¨­ç½®é¸é …
            toggleOptionsField();
            if (question.question_type === 'multiple_choice' && question.options) {
                const options = question.options;
                document.getElementById('optionA').value = options.A || options[0] || '';
                document.getElementById('optionB').value = options.B || options[1] || '';
                document.getElementById('optionC').value = options.C || options[2] || '';
                document.getElementById('optionD').value = options.D || options[3] || '';
            }

            document.getElementById('questionModal').classList.remove('hidden');
        }

        // åˆ‡æ›é¸é …æ¬„ä½é¡¯ç¤º
        function toggleOptionsField() {
            const type = document.getElementById('qType').value;
            const container = document.getElementById('optionsContainer');
            if (type === 'multiple_choice') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // é—œé–‰é¡Œç›®è¡¨å–®
        function closeQuestionModal(event) {
            if (!event || event.target.id === 'questionModal') {
                document.getElementById('questionModal').classList.add('hidden');
            }
        }

        // ä¿å­˜é¡Œç›®
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('questionForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const questionId = document.getElementById('editQuestionId').value;
                const isEdit = !!questionId;

                const concept = document.getElementById('qConcept').value;
                const type = document.getElementById('qType').value;
                const difficulty = parseInt(document.querySelector('input[name="qDifficulty"]:checked').value);
                const text = document.getElementById('qText').value;
                const answer = document.getElementById('qAnswer').value;
                const explanation = document.getElementById('qExplanation').value;

                // çµ„è£é¸é …
                let options = null;
                if (type === 'multiple_choice') {
                    options = {
                        A: document.getElementById('optionA').value,
                        B: document.getElementById('optionB').value,
                        C: document.getElementById('optionC').value,
                        D: document.getElementById('optionD').value
                    };
                }

                try {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    const url = isEdit 
                        ? `/api/admin/teacher-questions/${questionId}`
                        : '/api/admin/teacher-questions';
                    
                    const response = await fetch(url, {
                        method: isEdit ? 'PUT' : 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Admin-Auth': `admin-${currentUser.username}123`
                        },
                        body: JSON.stringify({
                            concept_name: concept,
                            question_type: type,
                            difficulty_level: difficulty,
                            question_text: text,
                            correct_answer: answer,
                            explanation: explanation,
                            options: options
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert(isEdit ? 'Question updated successfully!' : 'Question created successfully!');
                        closeQuestionModal();
                        loadTeacherQuestions();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Failed to save question:', error);
                    alert('Failed to save question: ' + error.message);
                }
            });
        });

        // åˆ‡æ›é¡Œç›®ç‹€æ…‹
        async function toggleQuestionStatus(questionId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch(`/api/admin/teacher-questions/${questionId}/toggle`, {
                    method: 'PATCH',
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    loadTeacherQuestions();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Failed to toggle question status:', error);
                alert('Failed to toggle question status');
            }
        }

        // åˆªé™¤é¡Œç›®
        async function deleteQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
                return;
            }

            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch(`/api/admin/teacher-questions/${questionId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Question deleted successfully!');
                    loadTeacherQuestions();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Failed to delete question:', error);
                alert('Failed to delete question');
            }
        }

        // é—œé–‰ç”¨æˆ¶è©³æƒ…Modal
        function closeUserModal(event) {
            if (!event || event.target.id === 'userModal') {
                document.getElementById('userModal').classList.add('hidden');
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                if (hours === 0) {
                    const minutes = Math.floor(diff / (1000 * 60));
                    return langManager.getCurrentLanguage() === 'zh-TW' 
                        ? `${minutes} åˆ†é˜å‰` 
                        : `${minutes} mins ago`;
                }
                return langManager.getCurrentLanguage() === 'zh-TW' 
                    ? `${hours} å°æ™‚å‰` 
                    : `${hours} hours ago`;
            }
            if (days < 7) {
                return langManager.getCurrentLanguage() === 'zh-TW' 
                    ? `${days} å¤©å‰` 
                    : `${days} days ago`;
            }
            return date.toLocaleDateString(langManager.getCurrentLanguage() === 'zh-TW' ? 'zh-TW' : 'en-US');
        }

        // èªè¨€åˆ‡æ›åŠŸèƒ½
        function initLanguage() {
            const currentLang = langManager.getCurrentLanguage();
            updateLangButton(currentLang);
            langManager.translatePage('admin');
            
            // æ›´æ–°placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = langManager.t(key, 'admin');
            });
            
            document.getElementById('langToggle').addEventListener('click', () => {
                const newLang = langManager.getCurrentLanguage() === 'zh-TW' ? 'en' : 'zh-TW';
                langManager.setLanguage(newLang);
                updateLangButton(newLang);
                
                // ç¿»è­¯é é¢å…ƒç´ 
                langManager.translatePage('admin');
                
                // æ›´æ–°placeholder
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    el.placeholder = langManager.t(key, 'admin');
                });
                
                // é‡æ–°æ¸²æŸ“ç”¨æˆ¶åˆ—è¡¨ï¼ˆå¦‚æœå·²è¼‰å…¥ï¼‰
                if (allUsers.length > 0) {
                    displayUsers(allUsers);
                }
            });
        }
        
        function updateLangButton(lang) {
            const langText = document.getElementById('langText');
            if (lang === 'zh-TW') {
                langText.textContent = 'ä¸­æ–‡';
            } else {
                langText.textContent = 'English';
            }
        }

        function applyCustomBackgroundFromStorage() {
            const dataUrl = localStorage.getItem('customBackgroundImage');
            if (!dataUrl) return;
            document.body.style.backgroundImage = `url('${dataUrl}')`;
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        async function fileToCompressedDataURL(file) {
            const dataUrl = await readFileAsDataURL(file);
            const img = await loadImage(dataUrl);

            const maxW = 1920;
            const maxH = 1080;
            const scale = Math.min(maxW / img.width, maxH / img.height, 1);
            const targetW = Math.round(img.width * scale);
            const targetH = Math.round(img.height * scale);

            const canvas = document.createElement('canvas');
            canvas.width = targetW;
            canvas.height = targetH;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, targetW, targetH);

            return canvas.toDataURL('image/jpeg', 0.85);
        }

        function initBackgroundPicker() {
            applyCustomBackgroundFromStorage();

            const btn = document.getElementById('bgBtn');
            const input = document.getElementById('bgInput');
            if (!btn || !input) return;

            btn.addEventListener('click', () => input.click());
            input.addEventListener('change', async () => {
                const file = input.files && input.files[0];
                if (!file) return;

                try {
                    const compressed = await fileToCompressedDataURL(file);
                    localStorage.setItem('customBackgroundImage', compressed);
                    applyCustomBackgroundFromStorage();
                } catch (err) {
                    console.error('Failed to set background:', err);
                    alert('Failed to set background image');
                } finally {
                    input.value = '';
                }
            });
        }

        // åˆå§‹åŒ–
        if (checkAdminAuth()) {
            initLanguage();
            initBackgroundPicker();
            loadSystemStats();
            loadUsers();
            loadPracticeStats();
            loadPracticeRecords(1);
            loadTeacherQuestions();
        }
    </script>
</body>
</html>