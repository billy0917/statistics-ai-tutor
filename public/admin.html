<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡æ§åˆ¶å° - Statistics AI Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/i18n.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* æš—è‰²ä¸»é¡Œé…è‰²æ–¹æ¡ˆ */
        .glass {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(71, 85, 105, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(51, 65, 85, 0.4);
        }

        /* æš—è‰²æ»¾å‹•æ¢ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 3px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .user-card {
            transition: all 0.3s ease;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        .stat-card {
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<body class="min-h-screen bg-cover bg-center bg-no-repeat" 
      style="background-image: url('https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg');">
    
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="fixed inset-0 bg-black/20 -z-10"></div>
    
    <div class="relative max-w-7xl mx-auto p-4 md:p-8">
        <!-- æ¨™é¡Œå€ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">ğŸ›¡ï¸</span>
                    <h1 class="text-3xl font-bold text-slate-100" data-i18n="adminTitle">ç®¡ç†å“¡æ§åˆ¶å°</h1>
                </div>
                <div class="flex gap-3 items-center">
                    <button id="langToggle" class="glass-dark px-3 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition-all text-sm font-medium flex items-center gap-2">
                        <span>ğŸŒ</span>
                        <span id="langText">ä¸­æ–‡</span>
                    </button>
                    <span class="text-slate-500">|</span>
                    <button onclick="logoutAdmin()" class="text-red-400 hover:text-red-300 transition font-medium" data-i18n="logoutBtn">
                        ç™»å‡º
                    </button>
                    <span class="text-slate-500">|</span>
                    <a href="/" class="text-blue-400 hover:text-blue-300 transition" data-i18n="backToHome">
                        è¿”å›é¦–é 
                    </a>
                </div>
            </div>
            <p class="text-slate-300" data-i18n="adminSubtitle">ç®¡ç†æ‰€æœ‰ç”¨æˆ¶çš„å­¸ç¿’é€²åº¦å’Œç³»çµ±çµ±è¨ˆ</p>
        </div>

        <!-- ç³»çµ±ç¸½è¦½çµ±è¨ˆ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <h2 class="text-2xl font-bold text-slate-100 mb-4" data-i18n="systemOverview">ğŸ“Š ç³»çµ±ç¸½è¦½</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-blue-500/30">
                    <div class="text-3xl font-bold text-blue-400" id="totalUsers">-</div>
                    <div class="text-sm text-slate-400 mt-2" data-i18n="totalUsersLabel">ç¸½ç”¨æˆ¶æ•¸</div>
                </div>
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-green-500/30">
                    <div class="text-3xl font-bold text-green-400" id="totalQuestions">-</div>
                    <div class="text-sm text-slate-400 mt-2" data-i18n="totalQuestionsLabel">ç¸½é¡Œç›®æ•¸</div>
                </div>
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-purple-500/30">
                    <div class="text-3xl font-bold text-purple-400" id="totalAnswers">-</div>
                    <div class="text-sm text-slate-400 mt-2" data-i18n="totalAnswersLabel">ç¸½ç­”é¡Œæ•¸</div>
                </div>
                <div class="stat-card glass-dark rounded-xl p-4 text-center border border-yellow-500/30">
                    <div class="text-3xl font-bold text-yellow-400" id="activeToday">-</div>
                    <div class="text-sm text-slate-400 mt-2" data-i18n="activeTodayLabel">ä»Šæ—¥æ´»èº</div>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ¶åˆ—è¡¨ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-slate-100" data-i18n="userListTitle">ğŸ‘¥ ç”¨æˆ¶åˆ—è¡¨</h2>
                <button onclick="refreshUsers()" class="glass-dark px-4 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition text-sm font-medium" data-i18n="refreshBtn">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>

            <!-- æœç´¢å’Œç¯©é¸ -->
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ¶å..." data-i18n-placeholder="searchPlaceholder"
                       class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400"
                       onkeyup="filterUsers()">
            </div>

            <!-- è¼‰å…¥å‹•ç•« -->
            <div id="loadingUsers" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mb-4"></div>
                <p class="text-slate-300" data-i18n="loadingUsers">è¼‰å…¥ç”¨æˆ¶ä¸­...</p>
            </div>

            <!-- ç”¨æˆ¶å¡ç‰‡åˆ—è¡¨ -->
            <div id="usersContainer" class="grid md:grid-cols-2 gap-4 hidden"></div>

            <!-- ç„¡ç”¨æˆ¶æç¤º -->
            <div id="noUsers" class="text-center py-12 hidden">
                <p class="text-slate-400" data-i18n="noUsers">æš«ç„¡ç”¨æˆ¶æ•¸æ“š</p>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ¶è©³æƒ…Modal -->
    <div id="userModal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 hidden z-50" onclick="closeUserModal(event)">
        <div class="glass rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-slate-100" data-i18n="userDetailsTitle">ç”¨æˆ¶è©³æƒ…</h3>
                <button onclick="closeUserModal()" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
            </div>
            <div id="userModalContent">
                <!-- å‹•æ…‹å…§å®¹ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let allUsers = [];
        let systemStats = null;

        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        function checkAdminAuth() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (!currentUser.role || currentUser.role !== 'admin') {
                alert(langManager.getCurrentLanguage() === 'zh-TW' ? 'ç„¡æ¬Šè¨ªå•æ­¤é é¢' : 'No permission to access this page');
                window.location.href = '/';
                return false;
            }
            return true;
        }

        // ç®¡ç†å“¡ç™»å‡º
        function logoutAdmin() {
            if (confirm(langManager.getCurrentLanguage() === 'zh-TW' ? 'ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ' : 'Confirm logout?')) {
                localStorage.removeItem('currentUser');
                window.location.href = '/';
            }
        }

        // ç²å–ç³»çµ±çµ±è¨ˆ
        async function loadSystemStats() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch('/api/admin/stats/overview', {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    systemStats = data;
                    displaySystemStats(data.overview);
                }
            } catch (error) {
                console.error('ç²å–ç³»çµ±çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºç³»çµ±çµ±è¨ˆ
        function displaySystemStats(stats) {
            document.getElementById('totalUsers').textContent = stats.totalUsers;
            document.getElementById('totalQuestions').textContent = stats.totalQuestions;
            document.getElementById('totalAnswers').textContent = stats.totalAnswers;
            document.getElementById('activeToday').textContent = stats.activeToday;
        }

        // ç²å–æ‰€æœ‰ç”¨æˆ¶
        async function loadUsers() {
            try {
                document.getElementById('loadingUsers').classList.remove('hidden');
                document.getElementById('usersContainer').classList.add('hidden');
                document.getElementById('noUsers').classList.add('hidden');

                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch('/api/admin/users', {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    allUsers = data.users;
                    displayUsers(allUsers);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('ç²å–ç”¨æˆ¶åˆ—è¡¨å¤±æ•—:', error);
                document.getElementById('loadingUsers').classList.add('hidden');
                document.getElementById('noUsers').classList.remove('hidden');
            }
        }

        // é¡¯ç¤ºç”¨æˆ¶åˆ—è¡¨
        function displayUsers(users) {
            document.getElementById('loadingUsers').classList.add('hidden');
            
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.classList.add('hidden');
                document.getElementById('noUsers').classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            document.getElementById('noUsers').classList.add('hidden');

            const viewDetailsText = langManager.t('viewDetails', 'admin');
            const practiceCountText = langManager.t('practiceCountLabel', 'admin');
            const accuracyText = langManager.t('accuracyLabel', 'admin');
            const conceptsText = langManager.t('learningConcepts', 'admin');
            const masteryText = langManager.t('masteryLabel', 'admin');
            const sessionsText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æ¬¡æœƒè©±' : 'sessions';
            const messagesText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æ¢æ¶ˆæ¯' : 'messages';
            const lastActivityText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æœ€å¾Œæ´»å‹•' : 'Last Activity';
            
            container.innerHTML = users.map(user => `
                <div class="user-card glass-dark rounded-xl p-4 border border-slate-600/40">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                ${user.username.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-slate-100">${user.username}</h3>
                                <p class="text-xs text-slate-400">${formatDate(user.created_at)}</p>
                            </div>
                        </div>
                        <button onclick="showUserDetails('${user.user_id}')" class="text-blue-400 hover:text-blue-300 text-sm font-medium">
                            ${viewDetailsText}
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="text-center p-2 bg-slate-700/30 rounded">
                            <div class="text-xl font-bold text-blue-400">${user.stats.totalPractice}</div>
                            <div class="text-xs text-slate-400">${practiceCountText}</div>
                        </div>
                        <div class="text-center p-2 bg-slate-700/30 rounded">
                            <div class="text-xl font-bold text-green-400">${user.stats.accuracy}%</div>
                            <div class="text-xs text-slate-400">${accuracyText}</div>
                        </div>
                        <div class="text-center p-2 bg-slate-700/30 rounded">
                            <div class="text-xl font-bold text-purple-400">${user.stats.totalConcepts}</div>
                            <div class="text-xs text-slate-400">${conceptsText}</div>
                        </div>
                        <div class="text-center p-2 bg-slate-700/30 rounded">
                            <div class="text-xl font-bold text-yellow-400">${user.stats.averageMastery}%</div>
                            <div class="text-xs text-slate-400">${masteryText}</div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between text-xs text-slate-400">
                        <span>ğŸ’¬ ${user.stats.totalSessions} ${sessionsText}</span>
                        <span>ğŸ“ ${user.stats.totalMessages} ${messagesText}</span>
                    </div>
                    
                    ${user.stats.lastActivity ? `
                    <div class="mt-2 pt-2 border-t border-slate-600/40 text-xs text-slate-400">
                        ${lastActivityText}: ${formatDate(user.stats.lastActivity)}
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // æœç´¢éæ¿¾ç”¨æˆ¶
        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm)
            );
            displayUsers(filtered);
        }

        // åˆ·æ–°ç”¨æˆ¶åˆ—è¡¨
        function refreshUsers() {
            loadUsers();
            loadSystemStats();
        }

        // é¡¯ç¤ºç”¨æˆ¶è©³æƒ…
        async function showUserDetails(userId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch(`/api/admin/users/${userId}/details`, {
                    headers: {
                        'X-Admin-Auth': `admin-${currentUser.username}123`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    displayUserDetails(data);
                    document.getElementById('userModal').classList.remove('hidden');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('ç²å–ç”¨æˆ¶è©³æƒ…å¤±æ•—:', error);
                alert(langManager.getCurrentLanguage() === 'zh-TW' ? 'ç²å–ç”¨æˆ¶è©³æƒ…å¤±æ•—' : 'Failed to load user details');
            }
        }

        // é¡¯ç¤ºç”¨æˆ¶è©³æƒ…Modalå…§å®¹
        function displayUserDetails(data) {
            const { user, progress, recentAnswers, recentSessions } = data;
            
            const basicInfoText = langManager.getCurrentLanguage() === 'zh-TW' ? 'åŸºæœ¬ä¿¡æ¯' : 'Basic Info';
            const usernameText = langManager.t('usernameLabel', 'admin');
            const userIdText = langManager.t('userIdLabel', 'admin');
            const createdAtText = langManager.t('createdAtLabel', 'admin');
            const lastActiveText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æœ€å¾Œæ´»å‹•' : 'Last Active';
            const levelText = langManager.getCurrentLanguage() === 'zh-TW' ? 'å­¸ç¿’ç­‰ç´š' : 'Level';
            const emailText = langManager.getCurrentLanguage() === 'zh-TW' ? 'é›»éƒµ' : 'Email';
            const notSetText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æœªè¨­ç½®' : 'Not set';
            const learningProgressTitle = langManager.t('learningProgressTitle', 'admin');
            const conceptsText = langManager.getCurrentLanguage() === 'zh-TW' ? 'å€‹æ¦‚å¿µ' : 'concepts';
            const practiceText = langManager.getCurrentLanguage() === 'zh-TW' ? 'ç·´ç¿’' : 'Practiced';
            const timesText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æ¬¡' : 'times';
            const correctText = langManager.getCurrentLanguage() === 'zh-TW' ? 'ç­”å°' : 'Correct';
            const questionsText = langManager.getCurrentLanguage() === 'zh-TW' ? 'é¡Œ' : 'questions';
            const noProgressText = langManager.t('noProgressData', 'admin');
            const recentAnswersText = langManager.getCurrentLanguage() === 'zh-TW' ? 'æœ€è¿‘ç­”é¡Œè¨˜éŒ„' : 'Recent Answers';
            
            const content = `
                <div class="space-y-6">
                    <!-- ç”¨æˆ¶åŸºæœ¬ä¿¡æ¯ -->
                    <div class="glass-dark rounded-xl p-4">
                        <h4 class="font-semibold text-slate-100 mb-3 flex items-center gap-2">
                            <span>ğŸ‘¤</span> ${basicInfoText}
                        </h4>
                        <div class="grid md:grid-cols-2 gap-3 text-sm">
                            <div><span class="text-slate-400">${usernameText}:</span> <span class="text-slate-100">${user.username}</span></div>
                            <div><span class="text-slate-400">${userIdText}:</span> <span class="text-slate-300 text-xs">${user.user_id}</span></div>
                            <div><span class="text-slate-400">${createdAtText}:</span> <span class="text-slate-100">${formatDate(user.created_at)}</span></div>
                            <div><span class="text-slate-400">${lastActiveText}:</span> <span class="text-slate-100">${formatDate(user.last_active)}</span></div>
                            <div><span class="text-slate-400">${levelText}:</span> <span class="text-slate-100">Level ${user.learning_level}</span></div>
                            <div><span class="text-slate-400">${emailText}:</span> <span class="text-slate-100">${user.email || notSetText}</span></div>
                        </div>
                    </div>

                    <!-- å­¸ç¿’é€²åº¦ -->
                    <div class="glass-dark rounded-xl p-4">
                        <h4 class="font-semibold text-slate-100 mb-3 flex items-center gap-2">
                            <span>ğŸ“š</span> ${learningProgressTitle} (${progress.length} ${conceptsText})
                        </h4>
                        <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                            ${progress.length > 0 ? progress.map(p => `
                                <div class="bg-slate-700/30 rounded p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-slate-100 font-medium text-sm">${p.concept_name}</span>
                                        <span class="text-slate-300 text-sm">${(parseFloat(p.mastery_level) * 100).toFixed(0)}%</span>
                                    </div>
                                    <div class="w-full bg-slate-600 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full" style="width: ${parseFloat(p.mastery_level) * 100}%"></div>
                                    </div>
                                    <div class="flex items-center justify-between mt-2 text-xs text-slate-400">
                                        <span>${practiceText} ${p.practice_count} ${timesText}</span>
                                        <span>${correctText} ${p.correct_answers} ${questionsText}</span>
                                    </div>
                                </div>
                            `).join('') : `<p class="text-slate-400 text-sm text-center py-4">${noProgressText}</p>`}
                        </div>
                    </div>

                    <!-- æœ€è¿‘ç­”é¡Œè¨˜éŒ„ -->
                    <div class="glass-dark rounded-xl p-4">
                        <h4 class="font-semibold text-slate-100 mb-3 flex items-center gap-2">
                            <span>âœï¸</span> ${recentAnswersText}
                        </h4>
                        <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                            ${recentAnswers.length > 0 ? recentAnswers.slice(0, 10).map(a => `
                                <div class="bg-slate-700/30 rounded p-3 text-sm">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex-1">
                                            <p class="text-slate-100 mb-1">${a.practice_questions?.question_text?.substring(0, 80)}...</p>
                                            <div class="flex items-center gap-2 text-xs text-slate-400">
                                                <span>${a.practice_questions?.concept_name}</span>
                                                <span>â€¢</span>
                                                <span>${langManager.getCurrentLanguage() === 'zh-TW' ? 'é›£åº¦' : 'Difficulty'} ${a.practice_questions?.difficulty_level}</span>
                                                <span>â€¢</span>
                                                <span>${formatDate(a.created_at)}</span>
                                            </div>
                                        </div>
                                        <span class="${a.is_correct ? 'text-green-400' : 'text-red-400'} font-medium ml-2">
                                            ${a.is_correct ? 'âœ“' : 'âœ—'}
                                        </span>
                                    </div>
                                </div>
                            `).join('') : `<p class="text-slate-400 text-sm text-center py-4">${langManager.getCurrentLanguage() === 'zh-TW' ? 'æš«ç„¡ç­”é¡Œè¨˜éŒ„' : 'No answer records'}</p>`}
                        </div>
                    </div>

                    <!-- èŠå¤©æœƒè©± -->
                    <div class="glass-dark rounded-xl p-4">
                        <h4 class="font-semibold text-slate-100 mb-3 flex items-center gap-2">
                            <span>ğŸ’¬</span> ${langManager.getCurrentLanguage() === 'zh-TW' ? 'èŠå¤©æœƒè©±æ­·å²' : 'Chat Session History'}
                        </h4>
                        <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                            ${recentSessions.length > 0 ? recentSessions.map(s => `
                                <div class="bg-slate-700/30 rounded p-3 text-sm">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-slate-100">${s.topic || (langManager.getCurrentLanguage() === 'zh-TW' ? 'ä¸€èˆ¬å°è©±' : 'General Conversation')}</p>
                                            <p class="text-xs text-slate-400 mt-1">${formatDate(s.start_time)}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-slate-300">${s.message_count} ${langManager.getCurrentLanguage() === 'zh-TW' ? 'æ¢æ¶ˆæ¯' : 'messages'}</p>
                                            <p class="text-xs ${s.is_active ? 'text-green-400' : 'text-slate-400'} mt-1">
                                                ${s.is_active ? (langManager.getCurrentLanguage() === 'zh-TW' ? 'é€²è¡Œä¸­' : 'Active') : (langManager.getCurrentLanguage() === 'zh-TW' ? 'å·²çµæŸ' : 'Ended')}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `<p class="text-slate-400 text-sm text-center py-4">${langManager.getCurrentLanguage() === 'zh-TW' ? 'æš«ç„¡æœƒè©±è¨˜éŒ„' : 'No session records'}</p>`}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('userModalContent').innerHTML = content;
        }

        // é—œé–‰ç”¨æˆ¶è©³æƒ…Modal
        function closeUserModal(event) {
            if (!event || event.target.id === 'userModal') {
                document.getElementById('userModal').classList.add('hidden');
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                if (hours === 0) {
                    const minutes = Math.floor(diff / (1000 * 60));
                    return langManager.getCurrentLanguage() === 'zh-TW' 
                        ? `${minutes} åˆ†é˜å‰` 
                        : `${minutes} mins ago`;
                }
                return langManager.getCurrentLanguage() === 'zh-TW' 
                    ? `${hours} å°æ™‚å‰` 
                    : `${hours} hours ago`;
            }
            if (days < 7) {
                return langManager.getCurrentLanguage() === 'zh-TW' 
                    ? `${days} å¤©å‰` 
                    : `${days} days ago`;
            }
            return date.toLocaleDateString(langManager.getCurrentLanguage() === 'zh-TW' ? 'zh-TW' : 'en-US');
        }

        // èªè¨€åˆ‡æ›åŠŸèƒ½
        function initLanguage() {
            const currentLang = langManager.getCurrentLanguage();
            updateLangButton(currentLang);
            langManager.translatePage('admin');
            
            // æ›´æ–°placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = langManager.t(key, 'admin');
            });
            
            document.getElementById('langToggle').addEventListener('click', () => {
                const newLang = langManager.getCurrentLanguage() === 'zh-TW' ? 'en' : 'zh-TW';
                langManager.setLanguage(newLang);
                updateLangButton(newLang);
                
                // ç¿»è­¯é é¢å…ƒç´ 
                langManager.translatePage('admin');
                
                // æ›´æ–°placeholder
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    el.placeholder = langManager.t(key, 'admin');
                });
                
                // é‡æ–°æ¸²æŸ“ç”¨æˆ¶åˆ—è¡¨ï¼ˆå¦‚æœå·²è¼‰å…¥ï¼‰
                if (allUsers.length > 0) {
                    displayUsers(allUsers);
                }
            });
        }
        
        function updateLangButton(lang) {
            const langText = document.getElementById('langText');
            if (lang === 'zh-TW') {
                langText.textContent = 'ä¸­æ–‡';
            } else {
                langText.textContent = 'English';
            }
        }

        // åˆå§‹åŒ–
        if (checkAdminAuth()) {
            initLanguage();
            loadSystemStats();
            loadUsers();
        }
    </script>
</body>
</html>

