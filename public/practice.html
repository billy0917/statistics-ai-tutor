<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±è¨ˆå­¸ç·´ç¿’ç³»çµ± - PSY2032</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="/i18n.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* æš—è‰²ä¸»é¡Œé…è‰²æ–¹æ¡ˆ */
        .glass {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(71, 85, 105, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(51, 65, 85, 0.4);
        }

        /* æš—è‰²æ»¾å‹•æ¢ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 3px;
        }

        .option-btn {
            transition: all 0.2s ease;
            background: rgba(51, 65, 85, 0.4);
            border: 2px solid rgba(71, 85, 105, 0.6);
            color: #e2e8f0;
            cursor: pointer;
            position: relative;
        }

        .option-btn:hover:not(.correct):not(.incorrect):not(:disabled):not(.selected) {
            transform: translateX(8px);
            background: rgba(71, 85, 105, 0.6);
            border-color: #60a5fa;
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
        }

        .option-btn:active:not(.correct):not(.incorrect):not(:disabled):not(.selected) {
            transform: translateX(8px) scale(0.98);
            background: rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .option-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .option-btn.correct {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .option-btn.incorrect {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .option-btn.selected {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-color: #1d4ed8;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.6), 0 0 0 3px rgba(59, 130, 246, 0.2);
            transform: translateX(4px);
            font-weight: 600;
        }
        
        .option-btn.selected:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateX(4px) scale(1.01);
        }

        /* é»æ“Šå‹•ç•«æ•ˆæœ - ç°¡æ½”æµæš¢çš„å–®æ¬¡å½ˆæ€§æ•ˆæœ */
        @keyframes btnClick {
            0% { 
                transform: translateX(0) scale(1);
            }
            60% { 
                transform: translateX(5px) scale(0.98);
            }
            100% { 
                transform: translateX(4px) scale(1);
            }
        }

        .option-btn.clicked {
            animation: btnClick 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .progress-bar {
            transition: width 0.5s ease;
        }

        .difficulty-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .difficulty-basic {
            background-color: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .difficulty-medium {
            background-color: rgba(251, 191, 36, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(251, 191, 36, 0.4);
        }

        .difficulty-advanced {
            background-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
    </style>
</head>
<body class="min-h-screen bg-cover bg-center bg-no-repeat p-4 md:p-8" 
      style="background-image: url('https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg');">
    
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="fixed inset-0 bg-black/20 -z-10"></div>
    
    <div class="relative max-w-4xl mx-auto">
        <!-- æ¨™é¡Œå€ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-3xl font-bold text-slate-100" data-i18n="title">ğŸ“š çµ±è¨ˆå­¸ç·´ç¿’ç³»çµ±</h1>
                <div class="flex gap-3 items-center">
                    <button id="langToggle" class="glass-dark px-3 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition-all text-sm font-medium flex items-center gap-2">
                        <span id="langIcon">ğŸŒ</span>
                        <span id="langText">ä¸­æ–‡</span>
                    </button>
                    <span class="text-slate-500">|</span>
                    <a href="/question-bank.html" class="text-blue-400 hover:text-blue-300 transition font-medium" data-i18n="questionBankLink">
                        ğŸ“– é¡Œåº«ç·´ç¿’
                    </a>
                    <span class="text-slate-500">|</span>
                    <a href="/" class="text-blue-400 hover:text-blue-300 transition" data-i18n="backToChat">
                        è¿”å›èŠå¤©
                    </a>
                </div>
            </div>
            <p class="text-slate-300" data-i18n="subtitle">é¸æ“‡æ¦‚å¿µå’Œé›£åº¦ï¼Œä½¿ç”¨ AI ç”Ÿæˆå€‹æ€§åŒ–ç·´ç¿’é¡Œï¼</p>
            <div class="mt-3 p-3 glass-dark rounded-lg border border-blue-500/30">
                <div class="flex items-center gap-2 text-sm text-blue-200">
                    <span>ğŸ’¡</span>
                    <span><strong data-i18n="newFeature">æ–°åŠŸèƒ½ï¼š</strong><span data-i18n="newFeatureText">æƒ³è¦ç³»çµ±åŒ–ç·´ç¿’ï¼Ÿè©¦è©¦</span> <a href="/question-bank.html" class="underline font-medium text-blue-300 hover:text-blue-200" data-i18n="questionBankLink">é¡Œåº«ç·´ç¿’ç³»çµ±</a><span data-i18n="questionBankDesc">ï¼ŒåŒ…å« Topic 1-10 çš„ 60+ é“é¡Œç›®ï¼</span></span>
                </div>
            </div>
            
            <!-- ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤ºå€ -->
            <div id="userInfoArea" class="mt-4 hidden">
                <div class="flex items-center gap-3 p-3 glass-dark rounded-lg border border-green-500/30">
                    <span class="text-2xl">ğŸ‘¤</span>
                    <div class="flex-1">
                        <div class="font-semibold text-slate-100" id="displayUserName"></div>
                        <div class="text-sm text-slate-400">å­¸ç¿’é€²åº¦å·²è¿½è¹¤</div>
                    </div>
                    <span class="text-sm text-green-400 font-medium">âœ“ å·²ç™»å…¥</span>
                </div>
            </div>
            
            <!-- æœªç™»å…¥æç¤ºå€ -->
            <div id="notLoggedInArea" class="mt-4 hidden">
                <div class="p-4 glass-dark rounded-lg border border-yellow-500/30">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-2xl">âš ï¸</span>
                        <div class="flex-1">
                            <div class="font-semibold text-slate-100">éœ€è¦ç™»å…¥æ‰èƒ½ä½¿ç”¨ç·´ç¿’ç³»çµ±</div>
                            <div class="text-sm text-slate-400">è«‹å…ˆåœ¨ä¸»é é¢ç™»å…¥ï¼Œä»¥ä¾¿è¿½è¹¤æ‚¨çš„å­¸ç¿’é€²åº¦</div>
                        </div>
                    </div>
                    <a href="/" class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                        å‰å¾€ç™»å…¥ â†’
                    </a>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <div class="grid md:grid-cols-3 gap-4 mb-4">
                <!-- æ¦‚å¿µé¸æ“‡ -->
                <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2" data-i18n="conceptLabel">çµ±è¨ˆæ¦‚å¿µ</label>
                    <select id="conceptSelect" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                        <option value="" data-i18n="conceptPlaceholder">é¸æ“‡æ¦‚å¿µ...</option>
                        <option value="æè¿°çµ±è¨ˆ" data-i18n="conceptDescriptive">æè¿°çµ±è¨ˆ</option>
                        <option value="æ¨™æº–å·®" data-i18n="conceptStdDev">æ¨™æº–å·®</option>
                        <option value="å–®æ¨£æœ¬tæª¢å®š" data-i18n="conceptOneSampleT">å–®æ¨£æœ¬tæª¢å®š</option>
                        <option value="ç¨ç«‹æ¨£æœ¬tæª¢å®š" data-i18n="conceptIndependentT">ç¨ç«‹æ¨£æœ¬tæª¢å®š</option>
                        <option value="é…å°æ¨£æœ¬tæª¢å®š" data-i18n="conceptPairedT">é…å°æ¨£æœ¬tæª¢å®š</option>
                        <option value="ç›¸é—œåˆ†æ" data-i18n="conceptCorrelation">ç›¸é—œåˆ†æ</option>
                        <option value="ç°¡å–®è¿´æ­¸" data-i18n="conceptRegression">ç°¡å–®è¿´æ­¸</option>
                        <option value="å¡æ–¹æª¢å®š" data-i18n="conceptChiSquare">å¡æ–¹æª¢å®š</option>
                    </select>
                </div>

                <!-- é›£åº¦é¸æ“‡ -->
                <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2" data-i18n="difficultyLabel">é›£åº¦ç´šåˆ¥</label>
                    <select id="difficultySelect" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                        <option value="basic" data-i18n="difficultyBasic">åŸºç¤ (Basic)</option>
                        <option value="medium" data-i18n="difficultyMedium">ä¸­ç´š (Medium)</option>
                        <option value="advanced" data-i18n="difficultyAdvanced">é€²éš (Advanced)</option>
                    </select>
                </div>

                <!-- é¡Œå‹é¸æ“‡ -->
                <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2" data-i18n="typeLabel">é¡Œå‹</label>
                    <select id="typeSelect" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                        <option value="multiple_choice" data-i18n="typeMultipleChoice">é¸æ“‡é¡Œ (MC)</option>
                        <option value="case_study" data-i18n="typeCaseStudy">æ¡ˆä¾‹åˆ†æ</option>
                        <option value="calculation" data-i18n="typeCalculation">è¨ˆç®—é¡Œ</option>
                        <option value="interpretation" data-i18n="typeInterpretation">è§£é‡‹é¡Œ</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="generateBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition shadow-lg" data-i18n="generateBtn">
                    ğŸ¯ ç”Ÿæˆæ–°é¡Œç›®
                </button>
                <button id="loadBtn" class="flex-1 bg-slate-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-slate-500 transition shadow-lg" data-i18n="loadBtn">
                    ğŸ“– å¾é¡Œåº«è¼‰å…¥
                </button>
            </div>
        </div>

        <!-- é€²åº¦çµ±è¨ˆå€ -->
        <div id="statsArea" class="glass rounded-2xl p-6 mb-6 fade-in hidden">
            <h3 class="text-xl font-bold text-slate-100 mb-4" data-i18n="statsTitle">ğŸ“Š ç·´ç¿’çµ±è¨ˆ</h3>
            <div class="grid md:grid-cols-4 gap-4">
                <div class="text-center p-4 glass-dark rounded-lg border border-blue-500/30">
                    <div class="text-3xl font-bold text-blue-400" id="totalCount">0</div>
                    <div class="text-sm text-slate-400" data-i18n="totalCount">ç¸½é¡Œæ•¸</div>
                </div>
                <div class="text-center p-4 glass-dark rounded-lg border border-green-500/30">
                    <div class="text-3xl font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-sm text-slate-400" data-i18n="correctCount">ç­”å°</div>
                </div>
                <div class="text-center p-4 glass-dark rounded-lg border border-red-500/30">
                    <div class="text-3xl font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-sm text-slate-400" data-i18n="incorrectCount">ç­”éŒ¯</div>
                </div>
                <div class="text-center p-4 glass-dark rounded-lg border border-purple-500/30">
                    <div class="text-3xl font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-sm text-slate-400" data-i18n="accuracy">æ­£ç¢ºç‡</div>
                </div>
            </div>
        </div>

        <!-- é¡Œç›®é¡¯ç¤ºå€ -->
        <div id="questionArea" class="glass rounded-2xl p-8 mb-6 fade-in hidden">
            <!-- é¡Œç›®æ¨™é¡Œ -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <span class="difficulty-badge" id="difficultyBadge">åŸºç¤</span>
                    <span class="text-sm text-slate-300" id="questionType">é¸æ“‡é¡Œ</span>
                    <span class="text-sm text-slate-300" id="conceptName">æè¿°çµ±è¨ˆ</span>
                </div>
                <button id="skipBtn" class="text-slate-400 hover:text-slate-300 transition" data-i18n="skipBtn">
                    è·³é â†’
                </button>
            </div>

            <!-- é¡Œç›®å…§å®¹ -->
            <div class="mb-6">
                <div class="text-lg font-medium text-slate-100 mb-4 leading-relaxed" id="questionText">
                    è¼‰å…¥ä¸­...
                </div>
            </div>

            <!-- é¸æ“‡é¡Œé¸é … -->
            <div id="optionsArea" class="space-y-3 mb-6"></div>

            <!-- é–‹æ”¾å¼ç­”æ¡ˆè¼¸å…¥ -->
            <div id="answerInputArea" class="mb-6 hidden">
                <textarea id="answerInput" class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:ring-2 focus:ring-blue-400 focus:border-transparent" rows="4" placeholder="è«‹è¼¸å…¥ä½ çš„ç­”æ¡ˆ..." data-i18n-placeholder="answerPlaceholder"></textarea>
            </div>

            <!-- æäº¤æŒ‰éˆ• -->
            <div class="flex gap-3">
                <button id="submitBtn" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-lg disabled:bg-slate-600 disabled:cursor-not-allowed" data-i18n="submitBtn">
                    æäº¤ç­”æ¡ˆ
                </button>
                <button id="hintBtn" class="bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-yellow-500 transition shadow-lg" data-i18n="hintBtn">
                    ğŸ’¡ æç¤º
                </button>
            </div>

            <!-- åé¥‹å€ -->
            <div id="feedbackArea" class="mt-6 hidden"></div>

            <!-- è§£é‡‹å€ -->
            <div id="explanationArea" class="mt-6 p-4 glass-dark border-l-4 border-blue-500 rounded hidden">
                <h4 class="font-semibold text-blue-300 mb-2" data-i18n="explanationTitle">ğŸ“– è©³ç´°è§£é‡‹</h4>
                <div id="explanationText" class="text-slate-300"></div>
            </div>

            <!-- ä¸‹ä¸€é¡ŒæŒ‰éˆ• -->
            <div id="nextBtnArea" class="mt-6 hidden">
                <button id="nextBtn" class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-blue-700 transition shadow-lg" data-i18n="nextBtn">
                    ä¸‹ä¸€é¡Œ â†’
                </button>
            </div>
        </div>

        <!-- è¼‰å…¥å‹•ç•« -->
        <div id="loadingArea" class="glass rounded-2xl p-12 text-center hidden">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mb-4"></div>
            <p class="text-slate-300" data-i18n="loadingMsg">æ­£åœ¨ç”Ÿæˆé¡Œç›®...</p>
        </div>
    </div>

    <script>
        let currentQuestion = null;
        let selectedAnswer = null;
        let startTime = null;
        let currentUser = null;
        let isLoggedIn = false;
        let stats = {
            total: 0,
            correct: 0,
            incorrect: 0
        };

        // DOM å…ƒç´ 
        const conceptSelect = document.getElementById('conceptSelect');
        const difficultySelect = document.getElementById('difficultySelect');
        const typeSelect = document.getElementById('typeSelect');
        const generateBtn = document.getElementById('generateBtn');
        const loadBtn = document.getElementById('loadBtn');
        const questionArea = document.getElementById('questionArea');
        const loadingArea = document.getElementById('loadingArea');
        const statsArea = document.getElementById('statsArea');
        const submitBtn = document.getElementById('submitBtn');
        const nextBtn = document.getElementById('nextBtn');
        const skipBtn = document.getElementById('skipBtn');
        const hintBtn = document.getElementById('hintBtn');
        const userInfoArea = document.getElementById('userInfoArea');
        const notLoggedInArea = document.getElementById('notLoggedInArea');
        const displayUserName = document.getElementById('displayUserName');

        // åˆå§‹åŒ–ç”¨æˆ¶ä¿¡æ¯ï¼ˆå¾ä¸»é é¢çš„ç™»éŒ„ç‹€æ…‹ï¼‰
        function initUser() {
            // å¾ localStorage ç²å–ç”¨æˆ¶ä¿¡æ¯ï¼ˆèˆ‡ AI å°è©±é é¢å…±ç”¨ï¼‰
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    
                    // é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯
                    displayUserName.textContent = currentUser.username;
                    userInfoArea.classList.remove('hidden');
                    notLoggedInArea.classList.add('hidden');
                    
                    console.log('âœ… ç”¨æˆ¶å·²ç™»å…¥:', currentUser.username, 'ID:', currentUser.user_id);
                } catch (error) {
                    console.error('è§£æç”¨æˆ¶ä¿¡æ¯å¤±æ•—:', error);
                    showNotLoggedIn();
                }
            } else {
                // æœªç™»å…¥
                showNotLoggedIn();
            }
        }

        // é¡¯ç¤ºæœªç™»å…¥æç¤º
        function showNotLoggedIn() {
            isLoggedIn = false;
            currentUser = null;
            userInfoArea.classList.add('hidden');
            notLoggedInArea.classList.remove('hidden');
            
            // ç¦ç”¨ç·´ç¿’åŠŸèƒ½
            generateBtn.disabled = true;
            loadBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            loadBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // èªè¨€åˆ‡æ›åŠŸèƒ½
        function initLanguage() {
            const currentLang = langManager.getCurrentLanguage();
            updateLangButton(currentLang);
            langManager.translatePage('practice');
            
            // èªè¨€åˆ‡æ›æŒ‰éˆ•äº‹ä»¶
            document.getElementById('langToggle').addEventListener('click', () => {
                const newLang = langManager.getCurrentLanguage() === 'zh-TW' ? 'en' : 'zh-TW';
                langManager.setLanguage(newLang);
                updateLangButton(newLang);
                langManager.translatePage('practice');
                
                // æ›´æ–°placeholder
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    el.placeholder = langManager.t(key, 'practice');
                });
            });
        }
        
        function updateLangButton(lang) {
            const langText = document.getElementById('langText');
            if (lang === 'zh-TW') {
                langText.textContent = 'ä¸­æ–‡';
            } else {
                langText.textContent = 'English';
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        initLanguage();
        initUser();

        // ç”Ÿæˆæ–°é¡Œç›®
        generateBtn.addEventListener('click', async () => {
            // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
            if (!isLoggedIn || !currentUser) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                window.location.href = '/';
                return;
            }
            
            const concept = conceptSelect.value;
            if (!concept) {
                alert('è«‹é¸æ“‡çµ±è¨ˆæ¦‚å¿µï¼');
                return;
            }

            const difficulty = difficultySelect.value;
            const questionType = typeSelect.value;

            showLoading();

            try {
                const response = await fetch('/api/practice/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        concept,
                        difficulty,
                        questionType,
                        saveToDatabase: true
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentQuestion = data.question;
                    displayQuestion(currentQuestion);
                    startTime = Date.now();
                } else {
                    alert('ç”Ÿæˆé¡Œç›®å¤±æ•—ï¼š' + data.error);
                    hideLoading();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ç”Ÿæˆé¡Œç›®æ™‚ç™¼ç”ŸéŒ¯èª¤');
                hideLoading();
            }
        });

        // å¾é¡Œåº«è¼‰å…¥ - ä½¿ç”¨æ–°çš„é¡Œåº« API
        loadBtn.addEventListener('click', async () => {
            // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
            if (!isLoggedIn || !currentUser) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                window.location.href = '/';
                return;
            }
            
            const concept = conceptSelect.value;
            const difficulty = difficultySelect.value;
            const questionType = typeSelect.value;

            if (!concept) {
                alert('è«‹å…ˆé¸æ“‡çµ±è¨ˆæ¦‚å¿µï¼\n\næç¤ºï¼šæˆ–ä½¿ç”¨é¡Œåº«ç·´ç¿’ç³»çµ±ç²å¾—æ›´å¥½çš„é«”é©—');
                return;
            }

            showLoading();

            try {
                // å…ˆå˜—è©¦å¾é¡Œåº« API è¼‰å…¥
                let url = '/api/practice/questions?limit=1&source=question_bank';
                if (concept) url += `&concept=${concept}`;
                if (difficulty) {
                    const diffMap = { 'basic': 1, 'medium': 2, 'advanced': 3 };
                    url += `&difficulty=${diffMap[difficulty]}`;
                }
                if (questionType) url += `&questionType=${questionType}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.questions.length > 0) {
                    currentQuestion = data.questions[0];
                    displayQuestion(currentQuestion);
                    startTime = Date.now();
                } else {
                    // å¦‚æœé¡Œåº«æ²’æœ‰ï¼Œæç¤ºç”¨æˆ¶
                    hideLoading();
                    const goToBank = confirm('é¡Œåº«ä¸­æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ã€‚\n\nè¦å‰å¾€é¡Œåº«ç·´ç¿’ç³»çµ±ç€è¦½æ‰€æœ‰å¯ç”¨é¡Œç›®å—ï¼Ÿ');
                    if (goToBank) {
                        window.location.href = '/question-bank.html';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('è¼‰å…¥é¡Œç›®æ™‚ç™¼ç”ŸéŒ¯èª¤');
                hideLoading();
            }
        });

        // é¡¯ç¤ºé¡Œç›®
        function displayQuestion(question) {
            hideLoading();
            questionArea.classList.remove('hidden');
            statsArea.classList.remove('hidden');

            // é‡ç½®ç‹€æ…‹
            selectedAnswer = null;
            document.getElementById('feedbackArea').classList.add('hidden');
            document.getElementById('explanationArea').classList.add('hidden');
            document.getElementById('nextBtnArea').classList.add('hidden');
            submitBtn.disabled = false;

            // è¨­ç½®é¡Œç›®è³‡è¨Š
            document.getElementById('questionText').textContent = question.question_text;
            document.getElementById('conceptName').textContent = question.concept_name;
            
            // é›£åº¦æ¨™ç±¤
            const difficultyBadge = document.getElementById('difficultyBadge');
            const difficultyNames = { 1: 'åŸºç¤', 2: 'ä¸­ç´š', 3: 'é€²éš' };
            const difficultyClasses = { 1: 'difficulty-basic', 2: 'difficulty-medium', 3: 'difficulty-advanced' };
            difficultyBadge.textContent = difficultyNames[question.difficulty_level];
            difficultyBadge.className = 'difficulty-badge ' + difficultyClasses[question.difficulty_level];

            // é¡Œå‹
            const typeNames = {
                'multiple_choice': 'é¸æ“‡é¡Œ (MC)',
                'case_study': 'æ¡ˆä¾‹åˆ†æ',
                'calculation': 'è¨ˆç®—é¡Œ',
                'interpretation': 'è§£é‡‹é¡Œ'
            };
            document.getElementById('questionType').textContent = typeNames[question.question_type];

            // é¡¯ç¤ºé¸é …æˆ–è¼¸å…¥æ¡†
            const optionsArea = document.getElementById('optionsArea');
            const answerInputArea = document.getElementById('answerInputArea');

            if (question.question_type === 'multiple_choice' && question.options) {
                optionsArea.innerHTML = '';
                optionsArea.classList.remove('hidden');
                answerInputArea.classList.add('hidden');

                const options = typeof question.options === 'string' ? JSON.parse(question.options) : question.options;
                options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn w-full text-left px-6 py-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition';
                    const optionLetter = String.fromCharCode(65 + index); // A, B, C, D
                    btn.innerHTML = `<span class="font-semibold">${optionLetter}.</span> ${option}`;
                    btn.onclick = () => selectOption(btn, optionLetter); // åªå‚³éå­—æ¯ï¼Œä¸å‚³éå®Œæ•´æ–‡æœ¬
                    optionsArea.appendChild(btn);
                });
            } else {
                optionsArea.classList.add('hidden');
                answerInputArea.classList.remove('hidden');
                document.getElementById('answerInput').value = '';
            }

            // æ¸²æŸ“ MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        // é¸æ“‡é¸é …
        function selectOption(btn, answer) {
            // ç§»é™¤å…¶ä»–é¸é …çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected');
            });
            
            // æ¨™è¨˜ç•¶å‰é¸é …ç‚ºé¸ä¸­
            btn.classList.add('selected');
            selectedAnswer = answer;
        }

        // æäº¤ç­”æ¡ˆ
        submitBtn.addEventListener('click', async () => {
            let userAnswer;
            
            if (currentQuestion.question_type === 'multiple_choice') {
                userAnswer = selectedAnswer;
            } else {
                userAnswer = document.getElementById('answerInput').value.trim();
            }

            if (!userAnswer) {
                alert('è«‹å…ˆé¸æ“‡æˆ–è¼¸å…¥ç­”æ¡ˆï¼');
                return;
            }

            const timeTaken = Math.floor((Date.now() - startTime) / 1000);

            try {
                const response = await fetch('/api/practice/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId: currentQuestion.question_id,
                        userAnswer,
                        timeTaken,
                        userId: currentUser?.user_id || null,  // ä½¿ç”¨ç™»å…¥çš„ç”¨æˆ¶ ID
                        sessionId: null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showFeedback(data.isCorrect, data.feedback, data.explanation);
                    updateStats(data.isCorrect);
                    submitBtn.disabled = true;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('æäº¤ç­”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        });

        // é¡¯ç¤ºåé¥‹
        function showFeedback(isCorrect, feedback, explanation) {
            const feedbackArea = document.getElementById('feedbackArea');
            const explanationArea = document.getElementById('explanationArea');
            const nextBtnArea = document.getElementById('nextBtnArea');

            feedbackArea.className = `mt-6 p-4 rounded-lg ${isCorrect ? 'bg-green-50 border-l-4 border-green-500' : 'bg-red-50 border-l-4 border-red-500'}`;
            feedbackArea.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-2xl">${isCorrect ? 'âœ…' : 'âŒ'}</span>
                    <span class="font-semibold ${isCorrect ? 'text-green-900' : 'text-red-900'}">${feedback}</span>
                </div>
            `;
            feedbackArea.classList.remove('hidden');

            document.getElementById('explanationText').innerHTML = explanation;
            explanationArea.classList.remove('hidden');

            nextBtnArea.classList.remove('hidden');

            // æ¨™è¨˜é¸é …
            if (currentQuestion.question_type === 'multiple_choice') {
                document.querySelectorAll('.option-btn').forEach(btn => {
                    const optionText = btn.textContent.substring(3).trim();
                    if (optionText === currentQuestion.correct_answer) {
                        btn.classList.add('correct');
                    } else if (optionText === selectedAnswer && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                    btn.onclick = null;
                });
            }
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats(isCorrect) {
            stats.total++;
            if (isCorrect) {
                stats.correct++;
            } else {
                stats.incorrect++;
            }

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('correctCount').textContent = stats.correct;
            document.getElementById('incorrectCount').textContent = stats.incorrect;
            document.getElementById('accuracy').textContent = Math.round((stats.correct / stats.total) * 100) + '%';
        }

        // ä¸‹ä¸€é¡Œ
        nextBtn.addEventListener('click', () => {
            generateBtn.click();
        });

        // è·³é
        skipBtn.addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦è·³éé€™é¡Œå—ï¼Ÿ')) {
                generateBtn.click();
            }
        });

        // æç¤º
        hintBtn.addEventListener('click', () => {
            alert('æç¤ºåŠŸèƒ½é–‹ç™¼ä¸­...\n\nå¯ä»¥è€ƒæ…®ï¼š\n1. å›é¡§çŸ¥è­˜åº«å…§å®¹\n2. æ€è€ƒç›¸é—œæ¦‚å¿µ\n3. æª¢æŸ¥è¨ˆç®—æ­¥é©Ÿ');
        });

        // é¡¯ç¤º/éš±è—è¼‰å…¥å‹•ç•«
        function showLoading() {
            loadingArea.classList.remove('hidden');
            questionArea.classList.add('hidden');
        }

        function hideLoading() {
            loadingArea.classList.add('hidden');
        }
    </script>
</body>
</html>


