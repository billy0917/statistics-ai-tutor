<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±è¨ˆå­¸ç·´ç¿’ç³»çµ± - PSY2032</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="/i18n.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* æš—è‰²ä¸»é¡Œé…è‰²æ–¹æ¡ˆ */
        .glass {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(71, 85, 105, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(51, 65, 85, 0.4);
        }

        /* æš—è‰²æ»¾å‹•æ¢ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 3px;
        }

        .option-btn {
            transition: all 0.2s ease;
            background: rgba(51, 65, 85, 0.4);
            border: 2px solid rgba(71, 85, 105, 0.6);
            color: #e2e8f0;
            cursor: pointer;
            position: relative;
        }

        .option-btn:hover:not(.correct):not(.incorrect):not(:disabled):not(.selected) {
            transform: translateX(8px);
            background: rgba(71, 85, 105, 0.6);
            border-color: #60a5fa;
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
        }

        .option-btn:active:not(.correct):not(.incorrect):not(:disabled):not(.selected) {
            transform: translateX(8px) scale(0.98);
            background: rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .option-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .option-btn.correct {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .option-btn.incorrect {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .option-btn.selected {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-color: #1d4ed8;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.6), 0 0 0 3px rgba(59, 130, 246, 0.2);
            transform: translateX(4px);
            font-weight: 600;
        }
        
        .option-btn.selected:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateX(4px) scale(1.01);
        }

        /* é»æ“Šå‹•ç•«æ•ˆæœ - ç°¡æ½”æµæš¢çš„å–®æ¬¡å½ˆæ€§æ•ˆæœ */
        @keyframes btnClick {
            0% { 
                transform: translateX(0) scale(1);
            }
            60% { 
                transform: translateX(5px) scale(0.98);
            }
            100% { 
                transform: translateX(4px) scale(1);
            }
        }

        .option-btn.clicked {
            animation: btnClick 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .progress-bar {
            transition: width 0.5s ease;
        }

        .difficulty-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .difficulty-basic {
            background-color: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .difficulty-medium {
            background-color: rgba(251, 191, 36, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(251, 191, 36, 0.4);
        }

        .difficulty-advanced {
            background-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        /* é¡Œç›®ä¾†æºé¸æ“‡æŒ‰éˆ• */
        .source-btn {
            cursor: pointer;
        }
        .source-btn.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .source-btn:not(.selected):hover {
            border-color: rgba(100, 116, 139, 0.8);
        }
    </style>
</head>
<body class="min-h-screen bg-cover bg-center bg-no-repeat p-4 md:p-8" 
      style="background-image: url('https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg');">
    
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="fixed inset-0 bg-black/20 -z-10"></div>
    
    <div class="relative max-w-4xl mx-auto">
        <!-- æ¨™é¡Œå€ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-3xl font-bold text-slate-100" data-i18n="title">ğŸ“š çµ±è¨ˆå­¸ç·´ç¿’ç³»çµ±</h1>
                <div class="flex gap-3 items-center">
                    <button id="langToggle" class="glass-dark px-3 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition-all text-sm font-medium flex items-center gap-2">
                        <span id="langIcon">ğŸŒ</span>
                        <span id="langText">ä¸­æ–‡</span>
                    </button>
                    <button id="bgBtn" class="glass-dark px-3 py-2 rounded-lg text-slate-200 hover:bg-slate-700/50 transition-all text-sm font-medium flex items-center gap-2" data-i18n="common.setBackground">
                        ğŸ–¼ï¸ æ›´æ›èƒŒæ™¯
                    </button>
                    <input id="bgInput" type="file" accept="image/*" class="hidden" />
                    <span class="text-slate-500">|</span>
                    <a href="/question-bank.html" class="text-blue-400 hover:text-blue-300 transition font-medium hidden" data-i18n="questionBankLink">
                        ğŸ“– é¡Œåº«ç·´ç¿’
                    </a>
                    <span class="text-slate-500">|</span>
                    <a href="/" class="text-blue-400 hover:text-blue-300 transition" data-i18n="backToChat">
                        è¿”å›èŠå¤©
                    </a>
                </div>
            </div>
            <p class="text-slate-300" data-i18n="subtitle">é¸æ“‡æ¦‚å¿µå’Œé›£åº¦ï¼Œä½¿ç”¨ AI ç”Ÿæˆå€‹æ€§åŒ–ç·´ç¿’é¡Œï¼</p>
            <!-- æš«æ™‚éš±è—æ–°åŠŸèƒ½æç¤º
            <div class="mt-3 p-3 glass-dark rounded-lg border border-blue-500/30">
                <div class="flex items-center gap-2 text-sm text-blue-200">
                    <span>ğŸ’¡</span>
                    <span><strong data-i18n="newFeature">æ–°åŠŸèƒ½ï¼š</strong><span data-i18n="newFeatureText">æƒ³è¦ç³»çµ±åŒ–ç·´ç¿’ï¼Ÿè©¦è©¦</span> <a href="/question-bank.html" class="underline font-medium text-blue-300 hover:text-blue-200" data-i18n="questionBankLink">é¡Œåº«ç·´ç¿’ç³»çµ±</a><span data-i18n="questionBankDesc">ï¼ŒåŒ…å« Topic 1-10 çš„ 60+ é“é¡Œç›®ï¼</span></span>
                </div>
            </div>
            -->
            
            <!-- AI Disclaimer -->
            <div class="mt-4 p-3 glass-dark rounded-lg border-l-4 border-yellow-500/50">
                <p class="text-sm text-yellow-200/90" data-i18n="common.disclaimer">
                    âš ï¸ å…è²¬è²æ˜ï¼šæœ¬ç³»çµ±ä½¿ç”¨ AI æŠ€è¡“ç”Ÿæˆå…§å®¹ï¼Œç­”æ¡ˆæœªå¿…å®Œå…¨æ­£ç¢ºï¼Œè«‹è¬¹æ…åˆ¤æ–·ä¸¦ä»¥æ•™æåŠè€å¸«æ•™å­¸å…§å®¹ç‚ºæº–ã€‚
                </p>
            </div>
            
            <!-- ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤ºå€ -->
            <div id="userInfoArea" class="mt-4 hidden">
                <div class="flex items-center gap-3 p-3 glass-dark rounded-lg border border-green-500/30">
                    <span class="text-2xl">ğŸ‘¤</span>
                    <div class="flex-1">
                        <div class="font-semibold text-slate-100" id="displayUserName"></div>
                        <div class="text-sm text-slate-400">å­¸ç¿’é€²åº¦å·²è¿½è¹¤</div>
                    </div>
                    <span class="text-sm text-green-400 font-medium">âœ“ å·²ç™»å…¥</span>
                </div>
            </div>
            
            <!-- æœªç™»å…¥æç¤ºå€ -->
            <div id="notLoggedInArea" class="mt-4 hidden">
                <div class="p-4 glass-dark rounded-lg border border-yellow-500/30">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-2xl">âš ï¸</span>
                        <div class="flex-1">
                            <div class="font-semibold text-slate-100">éœ€è¦ç™»å…¥æ‰èƒ½ä½¿ç”¨ç·´ç¿’ç³»çµ±</div>
                            <div class="text-sm text-slate-400">è«‹å…ˆåœ¨ä¸»é é¢ç™»å…¥ï¼Œä»¥ä¾¿è¿½è¹¤æ‚¨çš„å­¸ç¿’é€²åº¦</div>
                        </div>
                    </div>
                    <a href="/" class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                        å‰å¾€ç™»å…¥ â†’
                    </a>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <!-- é¡Œç›®ä¾†æºé¸æ“‡ -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-200 mb-3">Question Source</label>
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" id="sourceAI" onclick="selectQuestionSource('ai')" 
                            class="source-btn p-4 rounded-xl border-2 border-blue-500/60 bg-blue-500/20 text-left transition-all hover:bg-blue-500/30">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ¤–</span>
                            <div>
                                <div class="font-semibold text-blue-200">AI Generated</div>
                                <div class="text-xs text-slate-400">Dynamically generated questions</div>
                            </div>
                        </div>
                    </button>
                    <button type="button" id="sourceTeacher" onclick="selectQuestionSource('teacher')" 
                            class="source-btn p-4 rounded-xl border-2 border-slate-600/60 bg-slate-700/30 text-left transition-all hover:bg-slate-600/30">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ‘¨â€ğŸ«</span>
                            <div>
                                <div class="font-semibold text-slate-200">Teacher Questions</div>
                                <div class="text-xs text-slate-400">Curated by instructors</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- è‡ªé©æ‡‰æ¨è–¦å€åŸŸ -->
            <div id="adaptiveRecommendation" class="mb-6 hidden">
                <div class="glass-dark rounded-xl p-4 border border-purple-500/30">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">ğŸ¯</span>
                            <h3 class="text-lg font-semibold text-purple-300">Adaptive Recommendation</h3>
                        </div>
                        <button id="refreshRecommendationBtn" class="text-purple-400 hover:text-purple-300 text-sm">
                            ğŸ”„ Refresh
                        </button>
                    </div>
                    
                    <div id="recommendationContent" class="space-y-3">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                    
                    <div class="mt-4 flex gap-3">
                        <button id="useRecommendationBtn" 
                                class="flex-1 py-2.5 px-4 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 
                                       text-white font-medium hover:opacity-90 transition-opacity">
                            âœ¨ Use Recommendation
                        </button>
                        <button id="ignoreRecommendationBtn" 
                                class="py-2.5 px-4 rounded-lg bg-slate-600/50 text-slate-300 
                                       hover:bg-slate-500/50 transition-colors">
                            Choose Myself
                        </button>
                    </div>
                </div>
            </div>

            <!-- å¼±é …æ¦‚å¿µå¿«é€Ÿç·´ç¿’å€ -->
            <div id="weakConceptsPanel" class="mb-6 hidden">
                <div class="glass-dark rounded-xl p-4 border border-orange-500/30">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-2xl">ğŸ’ª</span>
                        <h3 class="text-lg font-semibold text-orange-300">Concepts to Improve</h3>
                    </div>
                    
                    <div id="weakConceptsList" class="flex flex-wrap gap-2">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                </div>
            </div>

            <!-- AI é¡Œç›®æ§åˆ¶å€ï¼ˆé è¨­é¡¯ç¤ºï¼‰ -->
            <div id="aiControlArea">
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <!-- æ¦‚å¿µé¸æ“‡ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-200 mb-2" data-i18n="conceptLabel">çµ±è¨ˆæ¦‚å¿µ</label>
                        <select id="conceptSelect" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            <option value="" data-i18n="conceptPlaceholder">Select concept...</option>
                            <option value="Descriptive Statistics">Descriptive Statistics</option>
                            <option value="Sample Size">Sample Size</option>
                            <option value="One-Sample t-Test">One-Sample t-Test</option>
                            <option value="Independent Samples t-Test">Independent Samples t-Test</option>
                            <option value="Paired Samples t-Test">Paired Samples t-Test</option>
                            <option value="Correlation Analysis">Correlation Analysis</option>
                            <option value="Simple Regression">Simple Regression</option>
                            <option value="Chi-Square Test">Chi-Square Test</option>
                        </select>
                    </div>

                    <!-- é›£åº¦é¸æ“‡ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-200 mb-2" data-i18n="difficultyLabel">é›£åº¦ç´šåˆ¥</label>
                        <select id="difficultySelect" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            <option value="basic" data-i18n="difficultyBasic">åŸºç¤ (Basic)</option>
                            <option value="medium" data-i18n="difficultyMedium">ä¸­ç´š (Medium)</option>
                            <option value="advanced" data-i18n="difficultyAdvanced">é€²éš (Advanced)</option>
                        </select>
                    </div>

                    <!-- é¡Œå‹é¸æ“‡ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-200 mb-2" data-i18n="typeLabel">é¡Œå‹</label>
                        <select id="typeSelect" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            <option value="multiple_choice" data-i18n="typeMultipleChoice">é¸æ“‡é¡Œ (MC)</option>
                            <option value="case_study" data-i18n="typeCaseStudy">æ¡ˆä¾‹åˆ†æ</option>
                            <option value="calculation" data-i18n="typeCalculation">è¨ˆç®—é¡Œ</option>
                            <option value="interpretation" data-i18n="typeInterpretation">è§£é‡‹é¡Œ</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="generateBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition shadow-lg" data-i18n="generateBtn">
                        ğŸ¯ ç”Ÿæˆæ–°é¡Œç›®
                    </button>
                    <button id="loadBtn" class="flex-1 bg-slate-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-slate-500 transition shadow-lg hidden" data-i18n="loadBtn">
                        ğŸ“– å¾é¡Œåº«è¼‰å…¥
                    </button>
                </div>
            </div>

            <!-- Teacher é¡Œç›®é¸æ“‡å€ï¼ˆé è¨­éš±è—ï¼‰ -->
            <div id="teacherControlArea" class="hidden">
                <!-- ç¯©é¸å™¨ -->
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-200 mb-2">Filter by Concept</label>
                        <select id="teacherConceptFilter" onchange="loadTeacherQuestionsList()" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            <option value="">All Concepts</option>
                            <option value="Descriptive Statistics">Descriptive Statistics</option>
                            <option value="Standard Deviation">Standard Deviation</option>
                            <option value="One-Sample t-Test">One-Sample t-Test</option>
                            <option value="Independent Samples t-Test">Independent Samples t-Test</option>
                            <option value="Paired Samples t-Test">Paired Samples t-Test</option>
                            <option value="Correlation Analysis">Correlation Analysis</option>
                            <option value="Simple Regression">Simple Regression</option>
                            <option value="Chi-Square Test">Chi-Square Test</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-200 mb-2">Filter by Difficulty</label>
                        <select id="teacherDifficultyFilter" onchange="loadTeacherQuestionsList()" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            <option value="">All Difficulties</option>
                            <option value="1">Basic</option>
                            <option value="2">Medium</option>
                            <option value="3">Advanced</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadTeacherQuestionsList()" class="w-full px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500 transition">
                            ğŸ”„ Refresh
                        </button>
                    </div>
                </div>

                <!-- é¡Œç›®åˆ—è¡¨ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-200 mb-2">
                        ğŸ“ Select a Question (<span id="teacherQuestionCount">0</span> available)
                    </label>
                    <div id="teacherQuestionsList" class="max-h-[300px] overflow-y-auto custom-scrollbar space-y-2 p-2 glass-dark rounded-lg border border-slate-600/40">
                        <p class="text-slate-400 text-center py-4">Loading questions...</p>
                    </div>
                </div>

                <!-- é–‹å§‹æŒ‰éˆ• -->
                <button id="startTeacherQuestionBtn" disabled class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-emerald-700 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    â–¶ï¸ Start Selected Question
                </button>
            </div>
        </div>

        <!-- é€²åº¦çµ±è¨ˆå€ -->
        <div id="statsArea" class="glass rounded-2xl p-6 mb-6 fade-in hidden">
            <h3 class="text-xl font-bold text-slate-100 mb-4" data-i18n="statsTitle">ğŸ“Š ç·´ç¿’çµ±è¨ˆ</h3>
            <div class="grid md:grid-cols-4 gap-4">
                <div class="text-center p-4 glass-dark rounded-lg border border-blue-500/30">
                    <div class="text-3xl font-bold text-blue-400" id="totalCount">0</div>
                    <div class="text-sm text-slate-400" data-i18n="totalCount">ç¸½é¡Œæ•¸</div>
                </div>
                <div class="text-center p-4 glass-dark rounded-lg border border-green-500/30">
                    <div class="text-3xl font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-sm text-slate-400" data-i18n="correctCount">ç­”å°</div>
                </div>
                <div class="text-center p-4 glass-dark rounded-lg border border-red-500/30">
                    <div class="text-3xl font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-sm text-slate-400" data-i18n="incorrectCount">ç­”éŒ¯</div>
                </div>
                <div class="text-center p-4 glass-dark rounded-lg border border-purple-500/30">
                    <div class="text-3xl font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-sm text-slate-400" data-i18n="accuracy">æ­£ç¢ºç‡</div>
                </div>
            </div>
        </div>

        <!-- é¡Œç›®é¡¯ç¤ºå€ -->
        <div id="questionArea" class="glass rounded-2xl p-8 mb-6 fade-in hidden">
            <!-- é¡Œç›®æ¨™é¡Œ -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <span class="difficulty-badge" id="difficultyBadge">Basic</span>
                    <span class="text-sm text-slate-300" id="questionType">Multiple Choice</span>
                    <span class="text-sm text-slate-300" id="conceptName">Descriptive Statistics</span>
                </div>
                <button id="skipBtn" class="text-slate-400 hover:text-slate-300 transition" data-i18n="skipBtn">
                    Skip â†’
                </button>
            </div>

            <!-- é¡Œç›®å…§å®¹ -->
            <div class="mb-6">
                <div class="text-lg font-medium text-slate-100 mb-4 leading-relaxed" id="questionText">
                    è¼‰å…¥ä¸­...
                </div>
            </div>

            <!-- é¸æ“‡é¡Œé¸é … -->
            <div id="optionsArea" class="space-y-3 mb-6"></div>

            <!-- é–‹æ”¾å¼ç­”æ¡ˆè¼¸å…¥ -->
            <div id="answerInputArea" class="mb-6 hidden">
                <textarea id="answerInput" class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:ring-2 focus:ring-blue-400 focus:border-transparent" rows="4" placeholder="è«‹è¼¸å…¥ä½ çš„ç­”æ¡ˆ..." data-i18n-placeholder="answerPlaceholder"></textarea>
            </div>

            <!-- æäº¤æŒ‰éˆ• -->
            <div class="flex gap-3">
                <button id="submitBtn" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-lg disabled:bg-slate-600 disabled:cursor-not-allowed" data-i18n="submitBtn">
                    æäº¤ç­”æ¡ˆ
                </button>
                <button id="hintBtn" class="bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-yellow-500 transition shadow-lg hidden" data-i18n="hintBtn">
                    ğŸ’¡ æç¤º
                </button>
            </div>

            <!-- åé¥‹å€ -->
            <div id="feedbackArea" class="mt-6 hidden"></div>

            <!-- è§£é‡‹å€ -->
            <div id="explanationArea" class="mt-6 p-5 rounded-xl glass border-l-4 border-blue-500/50 hidden">
                <h4 class="font-semibold text-blue-400 mb-3 flex items-center gap-2" data-i18n="explanationTitle">
                    <span>ğŸ“–</span> è©³ç´°è§£é‡‹
                </h4>
                <div id="explanationText" class="text-slate-300 leading-relaxed"></div>
            </div>

            <!-- æŒ‰éˆ•å€åŸŸ -->
            <div id="nextBtnArea" class="mt-6 hidden">
                <div class="flex gap-4">
                    <!-- Try Again æŒ‰éˆ•ï¼ˆç­”éŒ¯æ™‚é¡¯ç¤ºï¼‰ -->
                    <button id="tryAgainBtn" class="flex-1 bg-gradient-to-r from-orange-500 to-amber-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-orange-600 hover:to-amber-600 transition shadow-lg hidden" data-i18n="tryAgainBtn">
                        ğŸ”„ å†è©¦ä¸€æ¬¡
                    </button>
                    <!-- ä¸‹ä¸€é¡ŒæŒ‰éˆ• -->
                    <button id="nextBtn" class="flex-1 bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-blue-700 transition shadow-lg" data-i18n="nextBtn">
                        ä¸‹ä¸€é¡Œ â†’
                    </button>
                </div>
            </div>
        </div>

        <!-- è¼‰å…¥å‹•ç•« -->
        <div id="loadingArea" class="glass rounded-2xl p-12 text-center hidden">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mb-4"></div>
            <p class="text-slate-300" data-i18n="loadingMsg">æ­£åœ¨ç”Ÿæˆé¡Œç›®...</p>
        </div>
    </div>

    <script>
        let currentQuestion = null;
        let selectedAnswer = null;
        let startTime = null;
        let currentUser = null;
        let isLoggedIn = false;
        let questionSource = 'ai'; // 'ai' or 'teacher'
        let teacherQuestionsList = [];
        let stats = {
            total: 0,
            correct: 0,
            incorrect: 0
        };

        // DOM å…ƒç´ 
        const conceptSelect = document.getElementById('conceptSelect');
        const difficultySelect = document.getElementById('difficultySelect');
        const typeSelect = document.getElementById('typeSelect');
        const generateBtn = document.getElementById('generateBtn');
        const loadBtn = document.getElementById('loadBtn');
        const questionArea = document.getElementById('questionArea');
        const loadingArea = document.getElementById('loadingArea');
        const statsArea = document.getElementById('statsArea');
        const submitBtn = document.getElementById('submitBtn');
        const nextBtn = document.getElementById('nextBtn');
        const skipBtn = document.getElementById('skipBtn');
        const hintBtn = document.getElementById('hintBtn');
        const userInfoArea = document.getElementById('userInfoArea');
        const notLoggedInArea = document.getElementById('notLoggedInArea');
        const displayUserName = document.getElementById('displayUserName');

        // åˆå§‹åŒ–ç”¨æˆ¶ä¿¡æ¯ï¼ˆå¾ä¸»é é¢çš„ç™»éŒ„ç‹€æ…‹ï¼‰
        function initUser() {
            // å¾ localStorage ç²å–ç”¨æˆ¶ä¿¡æ¯ï¼ˆèˆ‡ AI å°è©±é é¢å…±ç”¨ï¼‰
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    
                    // é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯
                    displayUserName.textContent = currentUser.username;
                    userInfoArea.classList.remove('hidden');
                    notLoggedInArea.classList.add('hidden');
                    
                    console.log('âœ… ç”¨æˆ¶å·²ç™»å…¥:', currentUser.username, 'ID:', currentUser.user_id);
                    
                    // è¼‰å…¥è‡ªé©æ‡‰æ¨è–¦ï¼ˆå»¶é²ç¢ºä¿å‡½æ•¸å·²å®šç¾©ï¼‰
                    setTimeout(() => {
                        if (typeof loadAdaptiveRecommendation === 'function') {
                            loadAdaptiveRecommendation();
                        }
                    }, 100);
                } catch (error) {
                    console.error('è§£æç”¨æˆ¶ä¿¡æ¯å¤±æ•—:', error);
                    showNotLoggedIn();
                }
            } else {
                // æœªç™»å…¥
                showNotLoggedIn();
            }
        }

        // é¡¯ç¤ºæœªç™»å…¥æç¤º
        function showNotLoggedIn() {
            isLoggedIn = false;
            currentUser = null;
            userInfoArea.classList.add('hidden');
            notLoggedInArea.classList.remove('hidden');
            
            // ç¦ç”¨ç·´ç¿’åŠŸèƒ½
            generateBtn.disabled = true;
            loadBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            loadBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // é¡Œç›®ä¾†æºé¸æ“‡
        function selectQuestionSource(source) {
            questionSource = source;
            
            // æ›´æ–° UI
            const sourceAI = document.getElementById('sourceAI');
            const sourceTeacher = document.getElementById('sourceTeacher');
            const aiControlArea = document.getElementById('aiControlArea');
            const teacherControlArea = document.getElementById('teacherControlArea');
            
            if (source === 'ai') {
                sourceAI.classList.add('selected', 'border-blue-500/60', 'bg-blue-500/20');
                sourceAI.classList.remove('border-slate-600/60', 'bg-slate-700/30');
                sourceTeacher.classList.remove('selected', 'border-blue-500/60', 'bg-blue-500/20');
                sourceTeacher.classList.add('border-slate-600/60', 'bg-slate-700/30');
                
                // é¡¯ç¤º AI æ§åˆ¶å€ï¼Œéš±è— Teacher æ§åˆ¶å€
                aiControlArea.classList.remove('hidden');
                teacherControlArea.classList.add('hidden');
            } else {
                sourceTeacher.classList.add('selected', 'border-blue-500/60', 'bg-blue-500/20');
                sourceTeacher.classList.remove('border-slate-600/60', 'bg-slate-700/30');
                sourceAI.classList.remove('selected', 'border-blue-500/60', 'bg-blue-500/20');
                sourceAI.classList.add('border-slate-600/60', 'bg-slate-700/30');
                
                // é¡¯ç¤º Teacher æ§åˆ¶å€ï¼Œéš±è— AI æ§åˆ¶å€
                aiControlArea.classList.add('hidden');
                teacherControlArea.classList.remove('hidden');
                
                // è¼‰å…¥è€å¸«é¡Œç›®åˆ—è¡¨
                loadTeacherQuestionsList();
            }
        }

        // è¼‰å…¥è€å¸«é¡Œç›®åˆ—è¡¨
        let selectedTeacherQuestionId = null;
        
        async function loadTeacherQuestionsList() {
            const listContainer = document.getElementById('teacherQuestionsList');
            const countSpan = document.getElementById('teacherQuestionCount');
            const startBtn = document.getElementById('startTeacherQuestionBtn');
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            listContainer.innerHTML = '<p class="text-slate-400 text-center py-4">Loading questions...</p>';
            startBtn.disabled = true;
            selectedTeacherQuestionId = null;
            
            try {
                const conceptFilter = document.getElementById('teacherConceptFilter').value;
                const difficultyFilter = document.getElementById('teacherDifficultyFilter').value;
                
                let url = '/api/practice/teacher-questions/list?active=true';
                if (conceptFilter) url += `&concept=${encodeURIComponent(conceptFilter)}`;
                if (difficultyFilter) url += `&difficulty=${difficultyFilter}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.questions && data.questions.length > 0) {
                    teacherQuestionsList = data.questions;
                    countSpan.textContent = data.questions.length;
                    
                    const diffNames = { 1: 'Basic', 2: 'Medium', 3: 'Advanced' };
                    const diffColors = { 1: 'blue', 2: 'yellow', 3: 'red' };
                    const typeIcons = {
                        'multiple_choice': 'ğŸ“',
                        'true_false': 'âœ…',
                        'fill_blank': 'âœï¸',
                        'open_ended': 'ğŸ’­'
                    };
                    
                    listContainer.innerHTML = data.questions.map((q, index) => {
                        const shortText = q.question_text.length > 80 ? q.question_text.substring(0, 80) + '...' : q.question_text;
                        const diffColor = diffColors[q.difficulty_level] || 'slate';
                        return `
                            <div class="teacher-question-item p-3 rounded-lg border border-slate-600/40 hover:border-blue-500/60 cursor-pointer transition-all"
                                 onclick="selectTeacherQuestion('${q.question_id}', this)"
                                 data-question-id="${q.question_id}">
                                <div class="flex items-start gap-3">
                                    <div class="text-lg">${typeIcons[q.question_type] || 'ğŸ“„'}</div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex flex-wrap items-center gap-2 mb-1 text-xs">
                                            <span class="px-2 py-0.5 rounded bg-green-500/20 text-green-300">${q.concept_name}</span>
                                            <span class="px-2 py-0.5 rounded bg-${diffColor}-500/20 text-${diffColor}-300">${diffNames[q.difficulty_level]}</span>
                                        </div>
                                        <p class="text-sm text-slate-200 leading-snug">${shortText}</p>
                                    </div>
                                    <div class="text-slate-500 text-sm">#${index + 1}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    countSpan.textContent = '0';
                    listContainer.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-slate-400 mb-2">No teacher questions available</p>
                            <p class="text-xs text-slate-500">Try adjusting your filters or check back later</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load teacher questions:', error);
                listContainer.innerHTML = '<p class="text-red-400 text-center py-4">Failed to load questions</p>';
            }
        }

        // é¸æ“‡è€å¸«é¡Œç›®
        function selectTeacherQuestion(questionId, element) {
            // ç§»é™¤å…¶ä»–é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.teacher-question-item').forEach(item => {
                item.classList.remove('border-blue-500', 'bg-blue-500/10');
                item.classList.add('border-slate-600/40');
            });
            
            // æ¨™è¨˜é¸ä¸­
            element.classList.remove('border-slate-600/40');
            element.classList.add('border-blue-500', 'bg-blue-500/10');
            
            selectedTeacherQuestionId = questionId;
            document.getElementById('startTeacherQuestionBtn').disabled = false;
        }

        // é–‹å§‹è€å¸«é¡Œç›®
        document.getElementById('startTeacherQuestionBtn').addEventListener('click', async () => {
            if (!selectedTeacherQuestionId) {
                alert('Please select a question first!');
                return;
            }
            
            // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
            if (!isLoggedIn || !currentUser) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                window.location.href = '/';
                return;
            }
            
            showLoading();
            
            try {
                // å¾ API ç²å–å®Œæ•´é¡Œç›®è³‡æ–™
                const url = `/api/practice/teacher-questions/${selectedTeacherQuestionId}`;
                console.log('Fetching question from:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success && data.question) {
                    currentQuestion = {
                        ...data.question,
                        source: 'teacher'
                    };
                    displayQuestion(currentQuestion);
                    startTime = Date.now();
                } else {
                    alert('Failed to load question: ' + (data.error || 'Unknown error'));
                    hideLoading();
                }
            } catch (error) {
                console.error('Error loading question:', error);
                alert('Failed to load question: ' + error.message);
                hideLoading();
            }
        });

        // ç•¶é¸æ“‡å™¨è®ŠåŒ–æ™‚æ›´æ–°è€å¸«é¡Œç›®æ•¸é‡ï¼ˆä¿ç•™èˆŠçš„å…¼å®¹æ€§ï¼‰
        conceptSelect.addEventListener('change', () => {
            // ä¸å†éœ€è¦æ›´æ–°è€å¸«é¡Œç›®æ•¸é‡
        });
        difficultySelect.addEventListener('change', () => {
            // ä¸å†éœ€è¦æ›´æ–°è€å¸«é¡Œç›®æ•¸é‡
        });

        // èªè¨€åˆ‡æ›åŠŸèƒ½
        function initLanguage() {
            const currentLang = langManager.getCurrentLanguage();
            updateLangButton(currentLang);
            langManager.translatePage('practice');
            
            // èªè¨€åˆ‡æ›æŒ‰éˆ•äº‹ä»¶
            document.getElementById('langToggle').addEventListener('click', () => {
                const newLang = langManager.getCurrentLanguage() === 'zh-TW' ? 'en' : 'zh-TW';
                langManager.setLanguage(newLang);
                updateLangButton(newLang);
                langManager.translatePage('practice');
                
                // æ›´æ–°placeholder
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    el.placeholder = langManager.t(key, 'practice');
                });
            });
        }
        
        function updateLangButton(lang) {
            const langText = document.getElementById('langText');
            if (lang === 'zh-TW') {
                langText.textContent = 'ä¸­æ–‡';
            } else {
                langText.textContent = 'English';
            }
        }

        // ============ Custom Background (Local) ============
        const BG_STORAGE_KEY = 'customBackgroundImage';

        function applyCustomBackgroundFromStorage() {
            const stored = localStorage.getItem(BG_STORAGE_KEY);
            if (stored) {
                document.body.style.backgroundImage = `url('${stored}')`;
            }
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = src;
            });
        }

        async function fileToCompressedDataURL(file) {
            const dataUrl = await readFileAsDataURL(file);
            
            // å¦‚æœåŸåœ–æª”æ¡ˆå°æ–¼ 500KBï¼Œç›´æ¥ä½¿ç”¨åŸåœ–ï¼ˆä¿ç•™æœ€é«˜å“è³ªï¼‰
            if (file.size < 500 * 1024) {
                return dataUrl;
            }
            
            const img = await loadImage(dataUrl);
            const originalW = img.naturalWidth;
            const originalH = img.naturalHeight;

            // åªæœ‰ç•¶åœ–ç‰‡è¶…é 1920Ã—1080 æ™‚æ‰ç¸®å°
            const maxW = 1920;
            const maxH = 1080;
            const needsResize = originalW > maxW || originalH > maxH;
            
            if (!needsResize) {
                // åœ–ç‰‡å°ºå¯¸åˆç†ï¼Œåªè½‰ JPEG æ ¼å¼å£“ç¸®ï¼ˆä¿æŒåŸå°ºå¯¸ï¼‰
                const canvas = document.createElement('canvas');
                canvas.width = originalW;
                canvas.height = originalH;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                return canvas.toDataURL('image/jpeg', 0.9);
            }

            // éœ€è¦ç¸®å°ï¼šæŒ‰æ¯”ä¾‹ç¸®è‡³ 1920Ã—1080 å…§
            const scale = Math.min(maxW / originalW, maxH / originalH);
            const targetW = Math.max(1, Math.round(originalW * scale));
            const targetH = Math.max(1, Math.round(originalH * scale));

            const canvas = document.createElement('canvas');
            canvas.width = targetW;
            canvas.height = targetH;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, targetW, targetH);

            return canvas.toDataURL('image/jpeg', 0.85);
        }

        function initBackgroundPicker() {
            applyCustomBackgroundFromStorage();

            const btn = document.getElementById('bgBtn');
            const input = document.getElementById('bgInput');
            if (!btn || !input) return;

            btn.addEventListener('click', () => input.click());
            input.addEventListener('change', async () => {
                const file = input.files && input.files[0];
                input.value = '';
                if (!file) return;

                try {
                    const compressed = await fileToCompressedDataURL(file);
                    
                    // æª¢æŸ¥å£“ç¸®å¾Œå¤§å°ï¼ˆlocalStorage é™åˆ¶ç´„ 5-10MBï¼Œä¿å®ˆé™åˆ¶ 2MBï¼‰
                    const sizeInMB = (compressed.length * 0.75) / (1024 * 1024); // Base64 ç´„ç‚ºåŸå§‹ 4/3
                    if (sizeInMB > 2) {
                        const msg = (typeof langManager !== 'undefined' && langManager.getCurrentLanguage() === 'zh-TW')
                            ? `åœ–ç‰‡å¤ªå¤§ï¼ˆ${sizeInMB.toFixed(1)}MBï¼‰ï¼Œè«‹é¸æ“‡è¼ƒå°çš„åœ–ç‰‡ï¼ˆå»ºè­° < 2MBï¼‰`
                            : `Image too large (${sizeInMB.toFixed(1)}MB). Please choose a smaller image (< 2MB recommended)`;
                        alert(msg);
                        return;
                    }
                    
                    localStorage.setItem(BG_STORAGE_KEY, compressed);
                    document.body.style.backgroundImage = `url('${compressed}')`;
                } catch (e) {
                    console.error('Set background failed:', e);
                    const msg = (typeof langManager !== 'undefined' && langManager.getCurrentLanguage() === 'zh-TW')
                        ? 'è¨­å®šèƒŒæ™¯å¤±æ•—ï¼Œè«‹æ›ä¸€å¼µåœ–ç‰‡å†è©¦ã€‚'
                        : 'Failed to set background. Please try another image.';
                    alert(msg);
                }
            });
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        initLanguage();
        initBackgroundPicker();
        initUser();
        selectQuestionSource('ai'); // é è¨­é¸æ“‡ AI ç”Ÿæˆ

        // ç”Ÿæˆæ–°é¡Œç›®
        generateBtn.addEventListener('click', async () => {
            // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
            if (!isLoggedIn || !currentUser) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                window.location.href = '/';
                return;
            }
            
            const concept = conceptSelect.value;
            if (!concept) {
                alert('è«‹é¸æ“‡çµ±è¨ˆæ¦‚å¿µï¼');
                return;
            }

            const difficulty = difficultySelect.value;
            const questionType = typeSelect.value;

            showLoading();

            try {
                // æ ¹æ“šé¡Œç›®ä¾†æºé¸æ“‡ä¸åŒçš„ API
                if (questionSource === 'teacher') {
                    // è€å¸«é¡Œç›®
                    const diffMap = { 'basic': 1, 'medium': 2, 'advanced': 3 };
                    let url = `/api/practice/teacher-questions/random?concept=${concept}&difficulty=${diffMap[difficulty]}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.success && data.question) {
                        currentQuestion = {
                            ...data.question,
                            source: 'teacher',
                            question_id: data.question.question_id
                        };
                        displayQuestion(currentQuestion);
                        startTime = Date.now();
                    } else {
                        alert('No teacher questions available for this concept. Try AI Generated instead.');
                        hideLoading();
                    }
                } else {
                    // AI ç”Ÿæˆé¡Œç›®
                    const response = await fetch('/api/practice/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            concept,
                            difficulty,
                            questionType,
                            saveToDatabase: true
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        currentQuestion = {
                            ...data.question,
                            source: 'ai'
                        };
                        displayQuestion(currentQuestion);
                        startTime = Date.now();
                    } else {
                        alert('ç”Ÿæˆé¡Œç›®å¤±æ•—ï¼š' + data.error);
                        hideLoading();
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ç”Ÿæˆé¡Œç›®æ™‚ç™¼ç”ŸéŒ¯èª¤');
                hideLoading();
            }
        });

        // å¾é¡Œåº«è¼‰å…¥ - ä½¿ç”¨æ–°çš„é¡Œåº« API
        loadBtn.addEventListener('click', async () => {
            // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
            if (!isLoggedIn || !currentUser) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                window.location.href = '/';
                return;
            }
            
            const concept = conceptSelect.value;
            const difficulty = difficultySelect.value;
            const questionType = typeSelect.value;

            if (!concept) {
                alert('è«‹å…ˆé¸æ“‡çµ±è¨ˆæ¦‚å¿µï¼\n\næç¤ºï¼šæˆ–ä½¿ç”¨é¡Œåº«ç·´ç¿’ç³»çµ±ç²å¾—æ›´å¥½çš„é«”é©—');
                return;
            }

            showLoading();

            try {
                // å…ˆå˜—è©¦å¾é¡Œåº« API è¼‰å…¥
                let url = '/api/practice/questions?limit=1&source=question_bank';
                if (concept) url += `&concept=${concept}`;
                if (difficulty) {
                    const diffMap = { 'basic': 1, 'medium': 2, 'advanced': 3 };
                    url += `&difficulty=${diffMap[difficulty]}`;
                }
                if (questionType) url += `&questionType=${questionType}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.questions.length > 0) {
                    currentQuestion = data.questions[0];
                    displayQuestion(currentQuestion);
                    startTime = Date.now();
                } else {
                    // å¦‚æœé¡Œåº«æ²’æœ‰ï¼Œæç¤ºç”¨æˆ¶
                    hideLoading();
                    const goToBank = confirm('é¡Œåº«ä¸­æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ã€‚\n\nè¦å‰å¾€é¡Œåº«ç·´ç¿’ç³»çµ±ç€è¦½æ‰€æœ‰å¯ç”¨é¡Œç›®å—ï¼Ÿ');
                    if (goToBank) {
                        window.location.href = '/question-bank.html';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('è¼‰å…¥é¡Œç›®æ™‚ç™¼ç”ŸéŒ¯èª¤');
                hideLoading();
            }
        });

        // é¡¯ç¤ºé¡Œç›®
        function displayQuestion(question) {
            hideLoading();
            questionArea.classList.remove('hidden');
            statsArea.classList.remove('hidden');

            // é‡ç½®ç‹€æ…‹
            selectedAnswer = null;
            document.getElementById('feedbackArea').classList.add('hidden');
            document.getElementById('explanationArea').classList.add('hidden');
            document.getElementById('nextBtnArea').classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'æäº¤ç­”æ¡ˆ';  // é‡ç½®æäº¤æŒ‰éˆ•æ–‡å­—

            // è¨­ç½®é¡Œç›®è³‡è¨Š
            document.getElementById('questionText').textContent = question.question_text;
            document.getElementById('conceptName').textContent = question.concept_name;
            
            // é›£åº¦æ¨™ç±¤
            const difficultyBadge = document.getElementById('difficultyBadge');
            const difficultyNames = { 1: 'åŸºç¤', 2: 'ä¸­ç´š', 3: 'é€²éš' };
            const difficultyClasses = { 1: 'difficulty-basic', 2: 'difficulty-medium', 3: 'difficulty-advanced' };
            difficultyBadge.textContent = difficultyNames[question.difficulty_level];
            difficultyBadge.className = 'difficulty-badge ' + difficultyClasses[question.difficulty_level];

            // é¡Œå‹
            const typeNames = {
                'multiple_choice': 'é¸æ“‡é¡Œ (MC)',
                'case_study': 'æ¡ˆä¾‹åˆ†æ',
                'calculation': 'è¨ˆç®—é¡Œ',
                'interpretation': 'è§£é‡‹é¡Œ'
            };
            document.getElementById('questionType').textContent = typeNames[question.question_type];

            // é¡¯ç¤ºé¸é …æˆ–è¼¸å…¥æ¡†
            const optionsArea = document.getElementById('optionsArea');
            const answerInputArea = document.getElementById('answerInputArea');

            if (question.question_type === 'multiple_choice' && question.options) {
                optionsArea.innerHTML = '';
                optionsArea.classList.remove('hidden');
                answerInputArea.classList.add('hidden');

                let options = typeof question.options === 'string' ? JSON.parse(question.options) : question.options;
                
                // è™•ç†ä¸åŒæ ¼å¼çš„ optionsï¼ˆé™£åˆ—æˆ–ç‰©ä»¶ï¼‰
                if (Array.isArray(options)) {
                    // é™£åˆ—æ ¼å¼: ["é¸é …1", "é¸é …2", ...]
                    options.forEach((option, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn w-full text-left px-6 py-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition';
                        const optionLetter = String.fromCharCode(65 + index); // A, B, C, D
                        btn.innerHTML = `<span class="font-semibold">${optionLetter}.</span> ${option}`;
                        btn.onclick = () => selectOption(btn, optionLetter);
                        optionsArea.appendChild(btn);
                    });
                } else if (typeof options === 'object') {
                    // ç‰©ä»¶æ ¼å¼: {A: "é¸é …A", B: "é¸é …B", ...}
                    Object.entries(options).forEach(([key, value]) => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn w-full text-left px-6 py-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition';
                        btn.innerHTML = `<span class="font-semibold">${key}.</span> ${value}`;
                        btn.onclick = () => selectOption(btn, key);
                        optionsArea.appendChild(btn);
                    });
                }
            } else {
                optionsArea.classList.add('hidden');
                answerInputArea.classList.remove('hidden');
                document.getElementById('answerInput').value = '';
            }

            // æ¸²æŸ“ MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        // é¸æ“‡é¸é …
        function selectOption(btn, answer) {
            // ç§»é™¤å…¶ä»–é¸é …çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected');
            });
            
            // æ¨™è¨˜ç•¶å‰é¸é …ç‚ºé¸ä¸­
            btn.classList.add('selected');
            selectedAnswer = answer;
        }

        // æäº¤ç­”æ¡ˆ
        submitBtn.addEventListener('click', async () => {
            let userAnswer;
            
            if (currentQuestion.question_type === 'multiple_choice' || currentQuestion.question_type === 'true_false') {
                userAnswer = selectedAnswer;
            } else {
                userAnswer = document.getElementById('answerInput').value.trim();
            }

            if (!userAnswer) {
                alert('è«‹å…ˆé¸æ“‡æˆ–è¼¸å…¥ç­”æ¡ˆï¼');
                return;
            }

            const timeTaken = Math.floor((Date.now() - startTime) / 1000);

            // é¡¯ç¤ºè©•åˆ†ä¸­çš„æç¤º
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="animate-pulse">â³ è©•åˆ†ä¸­...</span>';

            try {
                let response;
                let data;
                
                // æ ¹æ“šé¡Œç›®ä¾†æºé¸æ“‡ä¸åŒçš„æäº¤æ–¹å¼
                if (currentQuestion.source === 'teacher') {
                    // è€å¸«é¡Œç›®ä½¿ç”¨å°ˆç”¨ API
                    response = await fetch('/api/practice/teacher-questions/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            questionId: currentQuestion.question_id,
                            userAnswer,
                            timeTaken,
                            userId: currentUser?.user_id || null
                        })
                    });
                    data = await response.json();
                } else if (currentQuestion.question_type === 'multiple_choice' || currentQuestion.question_type === 'true_false') {
                    // MC/TF é¡Œç›®ï¼šç›´æ¥åœ¨å‰ç«¯æ¯”å°ç­”æ¡ˆï¼ˆä¸éœ€è¦ AIï¼‰
                    const correctAnswer = currentQuestion.correct_answer.toString().toUpperCase().trim();
                    const userAns = userAnswer.toString().toUpperCase().trim();
                    const isCorrect = correctAnswer === userAns;
                    
                    data = {
                        success: true,
                        isCorrect,
                        score: isCorrect ? 100 : 0,
                        correctAnswer: currentQuestion.correct_answer,
                        explanation: currentQuestion.explanation
                    };
                    
                    // å¦‚æœæœ‰ question_idï¼Œå˜—è©¦ä¿å­˜è¨˜éŒ„ï¼ˆéé˜»å¡ï¼‰
                    if (currentQuestion.question_id && currentUser?.user_id) {
                        fetch('/api/practice/submit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                questionId: currentQuestion.question_id,
                                userAnswer,
                                timeTaken,
                                userId: currentUser.user_id,
                                sessionId: null
                            })
                        }).catch(err => console.log('è¨˜éŒ„ä¿å­˜å¤±æ•—ï¼ˆéé—œéµï¼‰:', err));
                    }
                } else {
                    // é–‹æ”¾å¼é¡Œç›®ï¼šä½¿ç”¨ AI è©•åˆ† API
                    response = await fetch('/api/practice/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            questionId: currentQuestion.question_id,
                            // è‹¥é¡Œç›®æœªæˆåŠŸå¯«å…¥è³‡æ–™åº«ï¼ˆç¼ºå°‘ question_idï¼‰ï¼Œæ”¹é€å‡ºå®Œæ•´é¡Œç›®è³‡æ–™è®“å¾Œç«¯ç›´æ¥è©•åˆ†
                            question: currentQuestion.question_id ? null : currentQuestion,
                            userAnswer,
                            timeTaken,
                            userId: currentUser?.user_id || null,
                            sessionId: null
                        })
                    });
                    data = await response.json();
                }

                if (data.success) {
                    // æ¨™æº–åŒ–åé¥‹æ•¸æ“š
                    const isOpenEnded = ['case_study', 'calculation', 'interpretation', 'short_answer', 'open_ended'].includes(currentQuestion.question_type);
                    
                    const feedbackData = {
                        isCorrect: data.isCorrect,
                        score: data.score,
                        feedback: data.feedback || (data.isCorrect ? 'Correct! Well done!' : 'Incorrect. Review the explanation below.'),
                        correctAnswer: data.correctAnswer,
                        explanation: data.explanation || currentQuestion.explanation,
                        questionType: currentQuestion.question_type,
                        aiEvaluation: data.aiEvaluation || (isOpenEnded && data.score !== undefined ? {
                            score: data.score,
                            feedback: data.feedback,
                            keyPointsMatched: data.keyPointsMatched,
                            missingPoints: data.missingPoints
                        } : null)
                    };
                    
                    console.log('Feedback data:', feedbackData);
                    
                    showFeedback(feedbackData);
                    updateStats(data.isCorrect);
                    submitBtn.innerHTML = 'å·²æäº¤';
                } else {
                    alert('è©•åˆ†å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'æäº¤ç­”æ¡ˆ';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('æäº¤ç­”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'æäº¤ç­”æ¡ˆ';
            }
        });

        // é¡¯ç¤ºåé¥‹ï¼ˆæ”¯æ´ AI è©•åˆ†çµæœï¼‰- æš—è‰²ä¸»é¡Œé¢¨æ ¼
        function showFeedback(data) {
            const { isCorrect, feedback, explanation, score, aiEvaluation, correctAnswer, questionType } = data;
            const feedbackArea = document.getElementById('feedbackArea');
            const explanationArea = document.getElementById('explanationArea');
            const nextBtnArea = document.getElementById('nextBtnArea');

            // åˆ¤æ–·æ˜¯å¦ç‚ºé–‹æ”¾å¼é¡Œå‹
            const isOpenEnded = ['case_study', 'calculation', 'interpretation', 'short_answer', 'open_ended', 'fill_blank'].includes(questionType);
            
            // ä½¿ç”¨ AI è©•åˆ†çš„ feedback æˆ–é è¨­ feedback
            const displayFeedback = (aiEvaluation?.feedback) || feedback;
            
            // æ ¹æ“šåˆ†æ•¸æ±ºå®šé¡è‰²ï¼ˆæš—è‰²ä¸»é¡Œï¼‰
            let iconEmoji, scoreColorClass, progressBarColor, borderColor;
            if (isOpenEnded && score !== null) {
                if (score >= 90) {
                    iconEmoji = 'ğŸ‰';
                    scoreColorClass = 'text-green-400';
                    progressBarColor = 'bg-green-500';
                    borderColor = 'border-green-500/50';
                } else if (score >= 70) {
                    iconEmoji = 'âœ…';
                    scoreColorClass = 'text-blue-400';
                    progressBarColor = 'bg-blue-500';
                    borderColor = 'border-blue-500/50';
                } else if (score >= 50) {
                    iconEmoji = 'ğŸ”¶';
                    scoreColorClass = 'text-yellow-400';
                    progressBarColor = 'bg-yellow-500';
                    borderColor = 'border-yellow-500/50';
                } else {
                    iconEmoji = 'âŒ';
                    scoreColorClass = 'text-red-400';
                    progressBarColor = 'bg-red-500';
                    borderColor = 'border-red-500/50';
                }
            } else {
                iconEmoji = isCorrect ? 'âœ…' : 'âŒ';
                scoreColorClass = isCorrect ? 'text-green-400' : 'text-red-400';
                progressBarColor = isCorrect ? 'bg-green-500' : 'bg-red-500';
                borderColor = isCorrect ? 'border-green-500/50' : 'border-red-500/50';
            }

            // æ§‹å»ºåé¥‹å…§å®¹ï¼ˆæš—è‰²ä¸»é¡Œï¼‰
            let feedbackHTML = `
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">${iconEmoji}</span>
                    <span class="font-semibold text-lg text-slate-100">${displayFeedback}</span>
                </div>
            `;

            // å¦‚æœæœ‰ AI è©•åˆ†ï¼Œé¡¯ç¤ºè©³ç´°è³‡è¨Š
            if (aiEvaluation && isOpenEnded) {
                feedbackHTML += `
                    <div class="glass-dark rounded-xl p-4 mt-4">
                        <!-- åˆ†æ•¸é¡¯ç¤º -->
                        <div class="flex items-center gap-6 mb-4">
                            <div class="text-center">
                                <div class="text-4xl font-bold ${scoreColorClass}">${score}</div>
                                <div class="text-xs text-slate-400 mt-1">Score</div>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between text-xs text-slate-400 mb-1">
                                    <span>0</span>
                                    <span>50</span>
                                    <span>100</span>
                                </div>
                                <div class="h-3 bg-slate-700 rounded-full overflow-hidden">
                                    <div class="h-full ${progressBarColor} transition-all duration-500 ease-out rounded-full" 
                                         style="width: ${score}%"></div>
                                </div>
                                <div class="text-xs text-slate-400 mt-1 text-center">
                                    ${score >= 90 ? 'Excellent!' : score >= 70 ? 'Good job!' : score >= 50 ? 'Keep practicing!' : 'Review needed'}
                                </div>
                            </div>
                        </div>
                `;

                // é¡¯ç¤ºåŒ¹é…çš„é—œéµé»
                if (aiEvaluation.keyPointsMatched && aiEvaluation.keyPointsMatched.length > 0) {
                    feedbackHTML += `
                        <div class="mb-3 p-3 rounded-lg bg-green-500/10 border border-green-500/30">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-green-400">âœ“</span>
                                <span class="text-sm font-semibold text-green-400">Key points you got right:</span>
                            </div>
                            <ul class="space-y-1">
                                ${aiEvaluation.keyPointsMatched.map(p => `
                                    <li class="flex items-start gap-2 text-sm text-green-300">
                                        <span class="text-green-500 mt-0.5">â€¢</span>
                                        <span>${p}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }

                // é¡¯ç¤ºç¼ºå¤±çš„é»
                if (aiEvaluation.missingPoints && aiEvaluation.missingPoints.length > 0) {
                    feedbackHTML += `
                        <div class="p-3 rounded-lg bg-orange-500/10 border border-orange-500/30">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-orange-400">âš </span>
                                <span class="text-sm font-semibold text-orange-400">Points to improve:</span>
                            </div>
                            <ul class="space-y-1">
                                ${aiEvaluation.missingPoints.map(p => `
                                    <li class="flex items-start gap-2 text-sm text-orange-300">
                                        <span class="text-orange-500 mt-0.5">â€¢</span>
                                        <span>${p}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }

                feedbackHTML += `</div>`;
            }

            feedbackArea.className = `mt-6 p-5 rounded-xl glass border-l-4 ${borderColor}`;
            feedbackArea.innerHTML = feedbackHTML;
            feedbackArea.classList.remove('hidden');

            // é¡¯ç¤ºåƒè€ƒç­”æ¡ˆå’Œè§£é‡‹ï¼ˆæš—è‰²ä¸»é¡Œï¼‰
            let explanationHTML = '';
            if (correctAnswer && isOpenEnded) {
                explanationHTML += `
                    <div class="mb-4 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-blue-400">ğŸ“</span>
                            <span class="font-semibold text-blue-400">Reference Answer:</span>
                        </div>
                        <p class="text-slate-200 leading-relaxed">${correctAnswer}</p>
                    </div>
                `;
            }
            explanationHTML += `<div class="text-slate-300 leading-relaxed">${explanation}</div>`;
            
            document.getElementById('explanationText').innerHTML = explanationHTML;
            explanationArea.classList.remove('hidden');

            nextBtnArea.classList.remove('hidden');

            // æ§åˆ¶ Try Again æŒ‰éˆ•é¡¯ç¤º
            const tryAgainBtn = document.getElementById('tryAgainBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            // åˆ¤æ–·æ˜¯å¦å¯ä»¥é‡è©¦ï¼ˆç­”éŒ¯æˆ–é–‹æ”¾å¼é¡Œç›®åˆ†æ•¸ä½æ–¼70ï¼‰
            const canRetry = !isCorrect || (isOpenEnded && score !== null && score < 70);
            
            if (canRetry) {
                tryAgainBtn.classList.remove('hidden');
                nextBtn.classList.remove('flex-1');
                nextBtn.classList.add('flex-1');
            } else {
                tryAgainBtn.classList.add('hidden');
            }

            // æ¨™è¨˜é¸é …ï¼ˆåƒ…é¸æ“‡é¡Œï¼‰
            if (currentQuestion.question_type === 'multiple_choice') {
                document.querySelectorAll('.option-btn').forEach(btn => {
                    const optionText = btn.textContent.substring(3).trim();
                    if (optionText === currentQuestion.correct_answer) {
                        btn.classList.add('correct');
                    } else if (optionText === selectedAnswer && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                    btn.onclick = null;
                });
            }
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats(isCorrect) {
            stats.total++;
            if (isCorrect) {
                stats.correct++;
            } else {
                stats.incorrect++;
            }

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('correctCount').textContent = stats.correct;
            document.getElementById('incorrectCount').textContent = stats.incorrect;
            document.getElementById('accuracy').textContent = Math.round((stats.correct / stats.total) * 100) + '%';
        }

        // ä¸‹ä¸€é¡Œ
        nextBtn.addEventListener('click', () => {
            generateBtn.click();
        });

        // Try Again - é‡æ–°å˜—è©¦åŒä¸€é¡Œ
        document.getElementById('tryAgainBtn').addEventListener('click', () => {
            // éš±è—åé¥‹å€åŸŸ
            document.getElementById('feedbackArea').classList.add('hidden');
            document.getElementById('explanationArea').classList.add('hidden');
            document.getElementById('nextBtnArea').classList.add('hidden');
            
            // é‡æ–°é¡¯ç¤ºé¡Œç›®ï¼ˆä½¿ç”¨ç•¶å‰é¡Œç›®ï¼‰
            displayQuestion(currentQuestion);
        });

        // è·³é
        skipBtn.addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦è·³éé€™é¡Œå—ï¼Ÿ')) {
                generateBtn.click();
            }
        });

        // æç¤º
        hintBtn.addEventListener('click', () => {
            alert('æç¤ºåŠŸèƒ½é–‹ç™¼ä¸­...\n\nå¯ä»¥è€ƒæ…®ï¼š\n1. å›é¡§çŸ¥è­˜åº«å…§å®¹\n2. æ€è€ƒç›¸é—œæ¦‚å¿µ\n3. æª¢æŸ¥è¨ˆç®—æ­¥é©Ÿ');
        });

        // é¡¯ç¤º/éš±è—è¼‰å…¥å‹•ç•«
        function showLoading() {
            loadingArea.classList.remove('hidden');
            questionArea.classList.add('hidden');
        }

        function hideLoading() {
            loadingArea.classList.add('hidden');
        }

        // =============================================
        // è‡ªé©æ‡‰ç·´ç¿’ç³»çµ± (Adaptive Practice System)
        // =============================================

        let adaptiveRecommendation = null;

        // è¼‰å…¥è‡ªé©æ‡‰æ¨è–¦
        async function loadAdaptiveRecommendation() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/practice/adaptive-recommendation?userId=${currentUser.user_id}`);
                const data = await response.json();
                
                if (data.success && data.recommendation) {
                    adaptiveRecommendation = data.recommendation;
                    displayAdaptiveRecommendation(data.recommendation);
                }
            } catch (error) {
                console.error('è¼‰å…¥è‡ªé©æ‡‰æ¨è–¦å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºè‡ªé©æ‡‰æ¨è–¦
        function displayAdaptiveRecommendation(rec) {
            const container = document.getElementById('adaptiveRecommendation');
            const content = document.getElementById('recommendationContent');
            const weakPanel = document.getElementById('weakConceptsPanel');
            const weakList = document.getElementById('weakConceptsList');
            
            if (!container || !content) return;

            // åªåœ¨ AI æ¨¡å¼ä¸‹é¡¯ç¤º
            if (questionSource !== 'ai') {
                container.classList.add('hidden');
                weakPanel?.classList.add('hidden');
                return;
            }
            
            // æ§‹å»ºæ¨è–¦å…§å®¹
            let html = '';
            
            // ä¸»è¦è¨Šæ¯
            html += `<p class="text-slate-200">${rec.message}</p>`;
            
            // æ¨è–¦è©³æƒ…
            if (rec.suggestedConcept) {
                html += `
                    <div class="flex flex-wrap items-center gap-4 mt-2">
                        <div class="flex items-center gap-2">
                            <span class="text-purple-400">ğŸ“š</span>
                            <span class="px-2 py-1 bg-purple-500/20 rounded text-purple-200 text-sm">${rec.suggestedConcept}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-purple-400">ğŸ“Š</span>
                            <span class="px-2 py-1 bg-blue-500/20 rounded text-blue-200 text-sm">
                                ${getDifficultyLabel(rec.suggestedDifficulty)}
                            </span>
                        </div>
                    </div>
                `;
            }
            
            // çµ±è¨ˆä¿¡æ¯
            if (rec.stats) {
                html += `
                    <div class="flex items-center gap-4 mt-3 text-sm text-slate-400">
                        <span>ğŸ“ Total: ${rec.stats.totalAnswers} questions</span>
                        <span>ğŸ“ˆ Recent: ${(rec.stats.recentPerformance * 100).toFixed(0)}% accuracy</span>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            container.classList.remove('hidden');
            
            // é¡¯ç¤ºå¼±é …æ¦‚å¿µ
            if (rec.weakConcepts && rec.weakConcepts.length > 0) {
                weakList.innerHTML = rec.weakConcepts.map(w => `
                    <button class="weak-concept-btn px-3 py-1.5 rounded-lg bg-orange-500/20 
                                   text-orange-200 border border-orange-500/30 hover:bg-orange-500/30 
                                   transition-colors text-sm cursor-pointer"
                            onclick="quickPracticeWeakConcept('${w.concept}')">
                        ${w.concept} 
                        <span class="text-orange-400">(${(w.accuracy * 100).toFixed(0)}%)</span>
                    </button>
                `).join('');
                weakPanel.classList.remove('hidden');
            } else {
                weakPanel.classList.add('hidden');
            }
        }

        // ç²å–é›£åº¦æ¨™ç±¤
        function getDifficultyLabel(level) {
            switch(level) {
                case 1: return 'â­ Basic';
                case 2: return 'â­â­ Medium';
                case 3: return 'â­â­â­ Advanced';
                default: return 'â­ Basic';
            }
        }

        // å¿«é€Ÿç·´ç¿’å¼±é …æ¦‚å¿µ
        async function quickPracticeWeakConcept(concept) {
            conceptSelect.value = concept;
            await generateAdaptiveQuestion(concept);
        }

        // ä½¿ç”¨æ¨è–¦è¨­ç½®ç”Ÿæˆé¡Œç›®
        async function generateAdaptiveQuestion(concept = null) {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch('/api/practice/generate-adaptive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.user_id,
                        concept: concept,
                        questionType: typeSelect?.value || 'multiple_choice'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.question) {
                    currentQuestion = {
                        ...data.question,
                        source: 'ai'
                    };
                    displayQuestion(currentQuestion);
                    startTime = Date.now();
                    
                    // é¡¯ç¤ºè‡ªé©æ‡‰ä¿¡æ¯
                    if (data.adaptive) {
                        showAdaptiveInfo(data.adaptive);
                    }
                } else {
                    throw new Error(data.error || 'ç”Ÿæˆé¡Œç›®å¤±æ•—');
                }
            } catch (error) {
                console.error('è‡ªé©æ‡‰ç”Ÿæˆå¤±æ•—:', error);
                alert('ç”Ÿæˆé¡Œç›®å¤±æ•—: ' + error.message);
                hideLoading();
            }
        }

        // é¡¯ç¤ºè‡ªé©æ‡‰ä¿¡æ¯æç¤º
        function showAdaptiveInfo(adaptive) {
            // æ›´æ–°æ¦‚å¿µé¸æ“‡å™¨ä»¥åæ˜ æ‰€é¸æ¦‚å¿µ
            if (adaptive.selectedConcept) {
                conceptSelect.value = adaptive.selectedConcept;
            }
            
            // æ›´æ–°é›£åº¦é¸æ“‡å™¨
            const difficultyMap = { 1: 'basic', 2: 'medium', 3: 'advanced' };
            if (adaptive.selectedDifficulty) {
                difficultySelect.value = difficultyMap[adaptive.selectedDifficulty] || 'basic';
            }

            console.log(`ğŸ¯ Adaptive: ${adaptive.reason}, Difficulty: ${getDifficultyLabel(adaptive.selectedDifficulty)}`);
        }

        // åˆå§‹åŒ–è‡ªé©æ‡‰åŠŸèƒ½çš„äº‹ä»¶ç›£è½å™¨
        function initAdaptiveListeners() {
            // ä½¿ç”¨æ¨è–¦æŒ‰éˆ•
            document.getElementById('useRecommendationBtn')?.addEventListener('click', () => {
                if (adaptiveRecommendation?.suggestedConcept) {
                    generateAdaptiveQuestion(adaptiveRecommendation.suggestedConcept);
                } else {
                    generateAdaptiveQuestion();
                }
            });
            
            // å¿½ç•¥æ¨è–¦æŒ‰éˆ•
            document.getElementById('ignoreRecommendationBtn')?.addEventListener('click', () => {
                document.getElementById('adaptiveRecommendation')?.classList.add('hidden');
            });

            // åˆ·æ–°æ¨è–¦æŒ‰éˆ•
            document.getElementById('refreshRecommendationBtn')?.addEventListener('click', () => {
                loadAdaptiveRecommendation();
            });
        }

        // åœ¨é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initAdaptiveListeners();
        });
    </script>
</body>
</html>


