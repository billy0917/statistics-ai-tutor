<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡Œåº«ç·´ç¿’ç³»çµ± - PSY2032</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* æš—è‰²ä¸»é¡Œé…è‰²æ–¹æ¡ˆ */
        .glass {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(71, 85, 105, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(51, 65, 85, 0.4);
        }

        /* æš—è‰²æ»¾å‹•æ¢ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 3px;
        }

        .topic-card {
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(51, 65, 85, 0.4);
            border: 2px solid rgba(71, 85, 105, 0.6);
        }

        .topic-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
            background: rgba(71, 85, 105, 0.6);
        }

        .topic-card.selected {
            border: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }

        .option-btn {
            transition: all 0.2s ease;
            background: rgba(51, 65, 85, 0.4);
            border: 2px solid rgba(71, 85, 105, 0.6);
            color: #e2e8f0;
            cursor: pointer;
            position: relative;
        }

        .option-btn:hover:not(.correct):not(.incorrect):not(:disabled):not(.selected) {
            transform: translateX(8px);
            background: rgba(71, 85, 105, 0.6);
            border-color: #60a5fa;
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
        }

        .option-btn:active:not(.correct):not(.incorrect):not(:disabled):not(.selected) {
            transform: translateX(8px) scale(0.98);
            background: rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .option-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .option-btn.correct {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .option-btn.incorrect {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .option-btn.selected {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-color: #1d4ed8;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.6), 0 0 0 3px rgba(59, 130, 246, 0.2);
            transform: translateX(4px);
            font-weight: 600;
        }
        
        .option-btn.selected:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateX(4px) scale(1.01);
        }

        /* é»æ“Šå‹•ç•«æ•ˆæœ - ç°¡æ½”æµæš¢çš„å–®æ¬¡å½ˆæ€§æ•ˆæœ */
        @keyframes btnClick {
            0% { 
                transform: translateX(0) scale(1);
            }
            60% { 
                transform: translateX(5px) scale(0.98);
            }
            100% { 
                transform: translateX(4px) scale(1);
            }
        }

        .option-btn.clicked {
            animation: btnClick 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .difficulty-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .difficulty-1 {
            background-color: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .difficulty-2 {
            background-color: rgba(251, 191, 36, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(251, 191, 36, 0.4);
        }

        .difficulty-3 {
            background-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
        }
    </style>
</head>
<body class="min-h-screen bg-cover bg-center bg-no-repeat p-4 md:p-8" 
      style="background-image: url('https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg');">
    
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="fixed inset-0 bg-black/20 -z-10"></div>
    
    <div class="relative max-w-6xl mx-auto">
        <!-- æ¨™é¡Œå€ -->
        <div class="glass rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-3xl font-bold text-slate-100">ğŸ“š é¡Œåº«ç·´ç¿’ç³»çµ±</h1>
                <div class="flex gap-3">
                    <a href="/practice.html" class="text-blue-400 hover:text-blue-300 transition">
                        AI ç”Ÿæˆç·´ç¿’
                    </a>
                    <span class="text-slate-500">|</span>
                    <a href="/" class="text-blue-400 hover:text-blue-300 transition">
                        è¿”å›èŠå¤©
                    </a>
                </div>
            </div>
            <p class="text-slate-300">å¾ Topic 1-10 é¸æ“‡ä¸»é¡Œï¼Œé–‹å§‹ä½ çš„ç³»çµ±åŒ–ç·´ç¿’ï¼</p>
            
            <!-- ç”¨æˆ¶ä¿¡æ¯ -->
            <div id="userInfoArea" class="mt-4 hidden">
                <div class="flex items-center gap-3 p-3 glass-dark rounded-lg border border-green-500/30">
                    <span class="text-2xl">ğŸ‘¤</span>
                    <div class="flex-1">
                        <div class="font-semibold text-slate-100" id="displayUserName"></div>
                        <div class="text-sm text-slate-400">å­¸ç¿’é€²åº¦å·²è¿½è¹¤</div>
                    </div>
                    <span class="text-sm text-green-400 font-medium">âœ“ å·²ç™»å…¥</span>
                </div>
            </div>
        </div>

        <!-- ä¸»é¡Œé¸æ“‡å€ -->
        <div id="topicSelectionArea" class="mb-6">
            <div class="glass rounded-2xl p-6 fade-in">
                <h2 class="text-2xl font-bold text-slate-100 mb-4">ğŸ“– é¸æ“‡ä¸»é¡Œ</h2>
                <div id="topicGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- ä¸»é¡Œå¡ç‰‡å°‡å‹•æ…‹ç”Ÿæˆ -->
                    <div class="text-center py-12 col-span-full">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mb-4"></div>
                        <p class="text-slate-300">è¼‰å…¥ä¸»é¡Œä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç·´ç¿’æ¨¡å¼é¸æ“‡ -->
        <div id="modeSelectionArea" class="glass rounded-2xl p-6 mb-6 fade-in hidden">
            <h2 class="text-xl font-bold text-slate-100 mb-4">ğŸ¯ ç·´ç¿’æ¨¡å¼</h2>
            <div class="grid md:grid-cols-3 gap-4">
                <!-- é›£åº¦é¸æ“‡ -->
                <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2">é›£åº¦ç´šåˆ¥</label>
                    <select id="difficultySelect" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400">
                        <option value="">å…¨éƒ¨é›£åº¦</option>
                        <option value="1">åŸºç¤ (Basic)</option>
                        <option value="2">ä¸­ç´š (Medium)</option>
                        <option value="3">é€²éš (Advanced)</option>
                    </select>
                </div>

                <!-- é¡Œå‹é¸æ“‡ -->
                <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2">é¡Œå‹</label>
                    <select id="typeSelect" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400">
                        <option value="">å…¨éƒ¨é¡Œå‹</option>
                        <option value="multiple_choice">é¸æ“‡é¡Œ (MC)</option>
                        <option value="calculation">è¨ˆç®—é¡Œ</option>
                        <option value="interpretation">è§£é‡‹é¡Œ</option>
                        <option value="case_study">æ¡ˆä¾‹åˆ†æ</option>
                    </select>
                </div>

                <!-- é¡Œæ•¸é¸æ“‡ -->
                <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2">ç·´ç¿’é¡Œæ•¸</label>
                    <select id="countSelect" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/60 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-400">
                        <option value="5">5 é¡Œ</option>
                        <option value="10" selected>10 é¡Œ</option>
                        <option value="15">15 é¡Œ</option>
                        <option value="20">20 é¡Œ</option>
                        <option value="all">å…¨éƒ¨é¡Œç›®</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button id="startPracticeBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition shadow-lg">
                    ğŸš€ é–‹å§‹ç·´ç¿’
                </button>
                <button id="randomPracticeBtn" class="flex-1 bg-gradient-to-r from-green-500 to-teal-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-teal-700 transition shadow-lg">
                    ğŸ² éš¨æ©Ÿç·´ç¿’
                </button>
                <button id="changeTopicBtn" class="bg-slate-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-slate-500 transition shadow-lg">
                    â† æ›´æ›ä¸»é¡Œ
                </button>
            </div>
        </div>

        <!-- é€²åº¦çµ±è¨ˆå€ -->
        <div id="statsArea" class="glass rounded-2xl p-6 mb-6 fade-in hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-100">ğŸ“Š ç·´ç¿’é€²åº¦</h3>
                <div class="text-sm text-slate-300">
                    <span id="currentQuestionNum">1</span> / <span id="totalQuestionNum">10</span>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="text-center p-4 glass-dark rounded-lg border border-blue-500/30">
                    <div class="text-3xl font-bold text-blue-400" id="totalCount">0</div>
                    <div class="text-sm text-slate-400">å·²å®Œæˆ</div>
                </div>
                <div class="text-center p-4 glass-dark rounded-lg border border-green-500/30">
                    <div class="text-3xl font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-sm text-slate-400">ç­”å°</div>
                </div>
                <div class="text-center p-4 glass-dark rounded-lg border border-red-500/30">
                    <div class="text-3xl font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-sm text-slate-400">ç­”éŒ¯</div>
                </div>
                <div class="text-center p-4 glass-dark rounded-lg border border-purple-500/30">
                    <div class="text-3xl font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-sm text-slate-400">æ­£ç¢ºç‡</div>
                </div>
                <div class="text-center p-4 glass-dark rounded-lg border border-yellow-500/30">
                    <div class="text-3xl font-bold text-yellow-400" id="remainingCount">0</div>
                    <div class="text-sm text-slate-400">å‰©é¤˜</div>
                </div>
            </div>
        </div>

        <!-- é¡Œç›®é¡¯ç¤ºå€ -->
        <div id="questionArea" class="glass rounded-2xl p-8 mb-6 fade-in hidden">
            <!-- é¡Œç›®æ¨™é¡Œ -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3 flex-wrap">
                    <span class="difficulty-badge" id="difficultyBadge">åŸºç¤</span>
                    <span class="text-sm text-slate-300" id="questionType">é¸æ“‡é¡Œ</span>
                    <span class="text-sm font-medium text-blue-400" id="topicName">Topic 1</span>
                    <span class="text-xs text-slate-400" id="questionNumber">Q1-1</span>
                </div>
                <button id="skipBtn" class="text-slate-400 hover:text-slate-300 transition text-sm">
                    è·³é â†’
                </button>
            </div>

            <!-- é¡Œç›®å…§å®¹ -->
            <div class="mb-6">
                <div class="text-lg font-medium text-slate-100 leading-relaxed whitespace-pre-wrap" id="questionText">
                    è¼‰å…¥ä¸­...
                </div>
            </div>

            <!-- é¸æ“‡é¡Œé¸é … -->
            <div id="optionsArea" class="space-y-3 mb-6"></div>

            <!-- é–‹æ”¾å¼ç­”æ¡ˆè¼¸å…¥ -->
            <div id="answerInputArea" class="mb-6 hidden">
                <textarea id="answerInput" class="w-full px-4 py-3 bg-slate-700/50 border-2 border-slate-600/60 rounded-lg text-slate-100 placeholder-slate-400 focus:ring-2 focus:ring-blue-400 focus:border-transparent" rows="5" placeholder="è«‹è¼¸å…¥ä½ çš„ç­”æ¡ˆ..."></textarea>
            </div>

            <!-- æäº¤æŒ‰éˆ• -->
            <div class="flex gap-3">
                <button id="submitBtn" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-lg disabled:bg-slate-600 disabled:cursor-not-allowed">
                    æäº¤ç­”æ¡ˆ
                </button>
            </div>

            <!-- åé¥‹å€ -->
            <div id="feedbackArea" class="mt-6 hidden"></div>

            <!-- è§£é‡‹å€ -->
            <div id="explanationArea" class="mt-6 p-4 glass-dark border-l-4 border-blue-500 rounded hidden">
                <h4 class="font-semibold text-blue-300 mb-2">ğŸ“– è©³ç´°è§£é‡‹</h4>
                <div id="explanationText" class="text-slate-300 whitespace-pre-wrap"></div>
            </div>

            <!-- ä¸‹ä¸€é¡ŒæŒ‰éˆ• -->
            <div id="nextBtnArea" class="mt-6 hidden">
                <button id="nextBtn" class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-blue-700 transition shadow-lg">
                    ä¸‹ä¸€é¡Œ â†’
                </button>
            </div>
        </div>

        <!-- å®Œæˆæ‘˜è¦ -->
        <div id="summaryArea" class="glass rounded-2xl p-8 mb-6 fade-in hidden">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h2 class="text-3xl font-bold text-slate-100 mb-2">ç·´ç¿’å®Œæˆï¼</h2>
                <p class="text-slate-300">æ­å–œä½ å®Œæˆäº†é€™æ¬¡ç·´ç¿’</p>
            </div>

            <div class="grid md:grid-cols-3 gap-6 mb-6">
                <div class="text-center p-6 glass-dark rounded-xl border border-blue-500/30">
                    <div class="text-4xl font-bold text-blue-400" id="summaryTotal">0</div>
                    <div class="text-sm text-slate-400 mt-2">ç¸½é¡Œæ•¸</div>
                </div>
                <div class="text-center p-6 glass-dark rounded-xl border border-green-500/30">
                    <div class="text-4xl font-bold text-green-400" id="summaryCorrect">0</div>
                    <div class="text-sm text-slate-400 mt-2">ç­”å°é¡Œæ•¸</div>
                </div>
                <div class="text-center p-6 glass-dark rounded-xl border border-purple-500/30">
                    <div class="text-4xl font-bold text-purple-400" id="summaryAccuracy">0%</div>
                    <div class="text-sm text-slate-400 mt-2">æ­£ç¢ºç‡</div>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="reviewBtn" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-lg">
                    ğŸ“ è¤‡ç¿’éŒ¯é¡Œ
                </button>
                <button id="continueBtn" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition shadow-lg">
                    ğŸ”„ ç¹¼çºŒç·´ç¿’
                </button>
                <button id="changeTopicBtn2" class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition shadow-lg">
                    ğŸ“š æ›´æ›ä¸»é¡Œ
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let currentUser = null;
        let selectedTopics = [];
        let questionQueue = [];
        let currentQuestionIndex = 0;
        let currentQuestion = null;
        let selectedAnswer = null;
        let startTime = null;
        let stats = {
            total: 0,
            correct: 0,
            incorrect: 0,
            answered: []
        };
        let allTopics = [];

        // DOM å…ƒç´ 
        const topicGrid = document.getElementById('topicGrid');
        const topicSelectionArea = document.getElementById('topicSelectionArea');
        const modeSelectionArea = document.getElementById('modeSelectionArea');
        const questionArea = document.getElementById('questionArea');
        const statsArea = document.getElementById('statsArea');
        const summaryArea = document.getElementById('summaryArea');
        const startPracticeBtn = document.getElementById('startPracticeBtn');
        const randomPracticeBtn = document.getElementById('randomPracticeBtn');
        const submitBtn = document.getElementById('submitBtn');
        const nextBtn = document.getElementById('nextBtn');
        const skipBtn = document.getElementById('skipBtn');
        const changeTopicBtn = document.getElementById('changeTopicBtn');
        const changeTopicBtn2 = document.getElementById('changeTopicBtn2');
        const reviewBtn = document.getElementById('reviewBtn');
        const continueBtn = document.getElementById('continueBtn');

        // åˆå§‹åŒ–
        async function init() {
            // è¼‰å…¥ç”¨æˆ¶ä¿¡æ¯
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('displayUserName').textContent = currentUser.username;
                    document.getElementById('userInfoArea').classList.remove('hidden');
                } catch (error) {
                    console.error('è§£æç”¨æˆ¶ä¿¡æ¯å¤±æ•—:', error);
                }
            }

            // è¼‰å…¥ä¸»é¡Œ
            await loadTopics();
        }

        // è¼‰å…¥ä¸»é¡Œåˆ—è¡¨
        async function loadTopics() {
            try {
                const response = await fetch('/api/question-bank/topics');
                const data = await response.json();

                if (data.success) {
                    allTopics = data.topics;
                    renderTopics(allTopics);
                } else {
                    topicGrid.innerHTML = '<p class="text-red-400 col-span-full text-center">è¼‰å…¥ä¸»é¡Œå¤±æ•—</p>';
                }
            } catch (error) {
                console.error('Error loading topics:', error);
                topicGrid.innerHTML = '<p class="text-red-400 col-span-full text-center">è¼‰å…¥ä¸»é¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤</p>';
            }
        }

        // æ¸²æŸ“ä¸»é¡Œå¡ç‰‡
        function renderTopics(topics) {
            if (topics.length === 0) {
                topicGrid.innerHTML = '<p class="text-slate-300 col-span-full text-center">å°šç„¡å¯ç”¨ä¸»é¡Œ</p>';
                return;
            }

            topicGrid.innerHTML = topics.map(topic => `
                <div class="topic-card p-5 rounded-xl" data-topic="${topic.topic_number}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="text-3xl">${getTopicIcon(topic.topic_number)}</div>
                        <span class="text-xs font-semibold text-blue-300 bg-blue-500/20 border border-blue-500/30 px-2 py-1 rounded">
                            Topic ${topic.topic_number}
                        </span>
                    </div>
                    <h3 class="font-bold text-slate-100 mb-2 text-sm leading-tight">${topic.topic_name}</h3>
                    <div class="flex items-center justify-between text-xs text-slate-400 mb-3">
                        <span>ğŸ“Š ${topic.total_questions} é¡Œ</span>
                        <span>âœ“ ${Object.keys(topic.concepts).length} æ¦‚å¿µ</span>
                    </div>
                    <div class="grid grid-cols-3 gap-1 text-xs">
                        <div class="bg-blue-500/20 text-blue-300 border border-blue-500/30 px-2 py-1 rounded text-center">
                            <div class="font-semibold">${topic.difficulty_breakdown.basic}</div>
                            <div class="text-[10px]">åŸºç¤</div>
                        </div>
                        <div class="bg-yellow-500/20 text-yellow-300 border border-yellow-500/30 px-2 py-1 rounded text-center">
                            <div class="font-semibold">${topic.difficulty_breakdown.medium}</div>
                            <div class="text-[10px]">ä¸­ç´š</div>
                        </div>
                        <div class="bg-red-500/20 text-red-300 border border-red-500/30 px-2 py-1 rounded text-center">
                            <div class="font-semibold">${topic.difficulty_breakdown.advanced}</div>
                            <div class="text-[10px]">é€²éš</div>
                        </div>
                    </div>
                </div>
            `).join('');

            // æ·»åŠ é»æ“Šäº‹ä»¶
            document.querySelectorAll('.topic-card').forEach(card => {
                card.addEventListener('click', () => toggleTopic(card));
            });
        }

        // ä¸»é¡Œåœ–æ¨™
        function getTopicIcon(topicNumber) {
            const icons = {
                1: 'ğŸ“‹', 2: 'ğŸ“Š', 3: 'ğŸ“ˆ', 4: 'ğŸ²', 5: 'ğŸ”¬',
                6: 'ğŸ”€', 7: 'âš–ï¸', 8: 'ğŸ“', 9: 'ğŸ“‰', 10: 'âœ–ï¸'
            };
            return icons[topicNumber] || 'ğŸ“š';
        }

        // åˆ‡æ›ä¸»é¡Œé¸æ“‡
        function toggleTopic(card) {
            const topicNum = parseInt(card.dataset.topic);
            
            if (selectedTopics.includes(topicNum)) {
                selectedTopics = selectedTopics.filter(t => t !== topicNum);
                card.classList.remove('selected');
            } else {
                selectedTopics.push(topicNum);
                card.classList.add('selected');
            }

            // é¡¯ç¤º/éš±è—æ¨¡å¼é¸æ“‡å€
            if (selectedTopics.length > 0) {
                modeSelectionArea.classList.remove('hidden');
            } else {
                modeSelectionArea.classList.add('hidden');
            }
        }

        // é–‹å§‹ç·´ç¿’
        startPracticeBtn.addEventListener('click', async () => {
            if (selectedTopics.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹ä¸»é¡Œï¼');
                return;
            }

            const difficulty = document.getElementById('difficultySelect').value;
            const type = document.getElementById('typeSelect').value;
            const count = document.getElementById('countSelect').value;

            await loadQuestions(selectedTopics, difficulty, type, count);
        });

        // éš¨æ©Ÿç·´ç¿’
        randomPracticeBtn.addEventListener('click', async () => {
            if (selectedTopics.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹ä¸»é¡Œï¼');
                return;
            }

            const count = document.getElementById('countSelect').value;
            await loadQuestions(selectedTopics, '', '', count, true);
        });

        // è¼‰å…¥é¡Œç›®
        async function loadQuestions(topics, difficulty, type, count, random = false) {
            try {
                let url = `/api/question-bank/practice-set?topics=${topics.join(',')}&count=${count === 'all' ? 100 : count}`;
                if (difficulty) url += `&difficulty=${difficulty}`;
                if (type) url += `&questionType=${type}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.questions.length > 0) {
                    questionQueue = data.questions;
                    if (random) {
                        questionQueue = shuffleArray(questionQueue);
                    }
                    currentQuestionIndex = 0;
                    stats = { total: 0, correct: 0, incorrect: 0, answered: [] };
                    
                    // éš±è—é¸æ“‡å€ï¼Œé¡¯ç¤ºé¡Œç›®å€
                    topicSelectionArea.classList.add('hidden');
                    modeSelectionArea.classList.add('hidden');
                    statsArea.classList.remove('hidden');
                    
                    // æ›´æ–°ç¸½é¡Œæ•¸
                    document.getElementById('totalQuestionNum').textContent = questionQueue.length;
                    document.getElementById('remainingCount').textContent = questionQueue.length;
                    
                    loadNextQuestion();
                } else {
                    alert('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ï¼');
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('è¼‰å…¥é¡Œç›®æ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        // è¼‰å…¥ä¸‹ä¸€é¡Œ
        function loadNextQuestion() {
            if (currentQuestionIndex >= questionQueue.length) {
                showSummary();
                return;
            }

            currentQuestion = questionQueue[currentQuestionIndex];
            displayQuestion(currentQuestion);
            startTime = Date.now();
            
            // æ›´æ–°ç•¶å‰é¡Œè™Ÿ
            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('remainingCount').textContent = questionQueue.length - currentQuestionIndex;
        }

        // é¡¯ç¤ºé¡Œç›®
        function displayQuestion(question) {
            questionArea.classList.remove('hidden');
            selectedAnswer = null;

            // é‡ç½®ç‹€æ…‹
            document.getElementById('feedbackArea').classList.add('hidden');
            document.getElementById('explanationArea').classList.add('hidden');
            document.getElementById('nextBtnArea').classList.add('hidden');
            submitBtn.disabled = false;

            // è¨­ç½®é¡Œç›®ä¿¡æ¯
            document.getElementById('questionText').textContent = question.question_text;
            document.getElementById('topicName').textContent = `Topic ${question.topic_number}: ${question.topic_name}`;
            document.getElementById('questionNumber').textContent = question.question_number || '';

            // é›£åº¦æ¨™ç±¤
            const difficultyBadge = document.getElementById('difficultyBadge');
            const difficultyNames = { 1: 'åŸºç¤', 2: 'ä¸­ç´š', 3: 'é€²éš' };
            difficultyBadge.textContent = difficultyNames[question.difficulty_level] || 'åŸºç¤';
            difficultyBadge.className = `difficulty-badge difficulty-${question.difficulty_level}`;

            // é¡Œå‹
            const typeNames = {
                'multiple_choice': 'é¸æ“‡é¡Œ',
                'calculation': 'è¨ˆç®—é¡Œ',
                'interpretation': 'è§£é‡‹é¡Œ',
                'case_study': 'æ¡ˆä¾‹åˆ†æ'
            };
            document.getElementById('questionType').textContent = typeNames[question.question_type] || question.question_type;

            // é¡¯ç¤ºé¸é …æˆ–è¼¸å…¥æ¡†
            const optionsArea = document.getElementById('optionsArea');
            const answerInputArea = document.getElementById('answerInputArea');

            if (question.question_type === 'multiple_choice' && question.options) {
                optionsArea.innerHTML = '';
                optionsArea.classList.remove('hidden');
                answerInputArea.classList.add('hidden');

                const options = Array.isArray(question.options) ? question.options : 
                              (typeof question.options === 'string' ? JSON.parse(question.options) : []);
                
                options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn w-full text-left px-6 py-4 border-2 border-gray-300 rounded-lg transition';
                    const optionLetter = String.fromCharCode(65 + index);
                    btn.innerHTML = `<span class="font-semibold text-blue-600 mr-2">${optionLetter}.</span> ${option}`;
                    btn.onclick = () => selectOption(btn, optionLetter);
                    optionsArea.appendChild(btn);
                });
            } else {
                optionsArea.classList.add('hidden');
                answerInputArea.classList.remove('hidden');
                document.getElementById('answerInput').value = '';
            }

            // æ¸²æŸ“ MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        // é¸æ“‡é¸é …
        function selectOption(btn, answer) {
            // ç§»é™¤å…¶ä»–é¸é …çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected');
            });
            
            // æ¨™è¨˜ç•¶å‰é¸é …ç‚ºé¸ä¸­
            btn.classList.add('selected');
            selectedAnswer = answer;
        }

        // æäº¤ç­”æ¡ˆ
        submitBtn.addEventListener('click', async () => {
            let userAnswer;
            
            if (currentQuestion.question_type === 'multiple_choice') {
                userAnswer = selectedAnswer;
            } else {
                userAnswer = document.getElementById('answerInput').value.trim();
            }

            if (!userAnswer) {
                alert('è«‹å…ˆé¸æ“‡æˆ–è¼¸å…¥ç­”æ¡ˆï¼');
                return;
            }

            const timeTaken = Math.floor((Date.now() - startTime) / 1000);

            try {
                const response = await fetch('/api/question-bank/validate-answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId: currentQuestion.question_id,
                        userAnswer
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showFeedback(data.is_correct, data.correct_answer, data.explanation);
                    updateStats(data.is_correct, userAnswer, data.correct_answer);
                    submitBtn.disabled = true;
                    
                    // ä¿å­˜ç­”é¡Œè¨˜éŒ„ï¼ˆå¦‚æœç”¨æˆ¶å·²ç™»å…¥ï¼‰
                    if (currentUser) {
                        saveAnswer(currentQuestion.question_id, userAnswer, data.is_correct, timeTaken);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('é©—è­‰ç­”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        });

        // ä¿å­˜ç­”é¡Œè¨˜éŒ„
        async function saveAnswer(questionId, userAnswer, isCorrect, timeTaken) {
            try {
                await fetch('/api/practice/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId,
                        userAnswer,
                        isCorrect,
                        timeTaken,
                        userId: currentUser.user_id
                    })
                });
            } catch (error) {
                console.error('ä¿å­˜ç­”é¡Œè¨˜éŒ„å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºåé¥‹
        function showFeedback(isCorrect, correctAnswer, explanation) {
            const feedbackArea = document.getElementById('feedbackArea');
            const explanationArea = document.getElementById('explanationArea');
            const nextBtnArea = document.getElementById('nextBtnArea');

            feedbackArea.className = `mt-6 p-4 rounded-lg ${isCorrect ? 'bg-green-50 border-l-4 border-green-500' : 'bg-red-50 border-l-4 border-red-500'}`;
            feedbackArea.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-2xl">${isCorrect ? 'âœ…' : 'âŒ'}</span>
                    <span class="font-semibold ${isCorrect ? 'text-green-900' : 'text-red-900'}">
                        ${isCorrect ? 'å›ç­”æ­£ç¢ºï¼' : 'å›ç­”éŒ¯èª¤'}
                    </span>
                </div>
                ${!isCorrect ? `<p class="text-sm text-red-700">æ­£ç¢ºç­”æ¡ˆï¼š${correctAnswer}</p>` : ''}
            `;
            feedbackArea.classList.remove('hidden');

            document.getElementById('explanationText').textContent = explanation;
            explanationArea.classList.remove('hidden');

            nextBtnArea.classList.remove('hidden');

            // æ¨™è¨˜é¸é …
            if (currentQuestion.question_type === 'multiple_choice') {
                document.querySelectorAll('.option-btn').forEach(btn => {
                    const optionLetter = btn.querySelector('.font-semibold').textContent.replace('.', '').trim();
                    if (optionLetter === correctAnswer) {
                        btn.classList.add('correct');
                    } else if (optionLetter === selectedAnswer && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                    btn.onclick = null;
                });
            }

            // æ¸²æŸ“ MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats(isCorrect, userAnswer, correctAnswer) {
            stats.total++;
            if (isCorrect) {
                stats.correct++;
            } else {
                stats.incorrect++;
            }
            
            stats.answered.push({
                question: currentQuestion,
                userAnswer,
                correctAnswer,
                isCorrect
            });

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('correctCount').textContent = stats.correct;
            document.getElementById('incorrectCount').textContent = stats.incorrect;
            document.getElementById('accuracy').textContent = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) + '%' : '0%';
        }

        // ä¸‹ä¸€é¡Œ
        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            loadNextQuestion();
        });

        // è·³é
        skipBtn.addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦è·³éé€™é¡Œå—ï¼Ÿé€²åº¦å°‡ä¸æœƒè¢«è¨˜éŒ„ã€‚')) {
                currentQuestionIndex++;
                loadNextQuestion();
            }
        });

        // é¡¯ç¤ºæ‘˜è¦
        function showSummary() {
            questionArea.classList.add('hidden');
            statsArea.classList.add('hidden');
            summaryArea.classList.remove('hidden');

            document.getElementById('summaryTotal').textContent = stats.total;
            document.getElementById('summaryCorrect').textContent = stats.correct;
            document.getElementById('summaryAccuracy').textContent = stats.total > 0 ? 
                Math.round((stats.correct / stats.total) * 100) + '%' : '0%';
        }

        // è¤‡ç¿’éŒ¯é¡Œ
        reviewBtn.addEventListener('click', () => {
            const wrongQuestions = stats.answered.filter(a => !a.isCorrect);
            if (wrongQuestions.length === 0) {
                alert('å¤ªæ£’äº†ï¼æ²’æœ‰ç­”éŒ¯çš„é¡Œç›®ï¼');
                return;
            }
            
            questionQueue = wrongQuestions.map(a => a.question);
            currentQuestionIndex = 0;
            stats = { total: 0, correct: 0, incorrect: 0, answered: [] };
            
            summaryArea.classList.add('hidden');
            statsArea.classList.remove('hidden');
            document.getElementById('totalQuestionNum').textContent = questionQueue.length;
            document.getElementById('remainingCount').textContent = questionQueue.length;
            
            loadNextQuestion();
        });

        // ç¹¼çºŒç·´ç¿’
        continueBtn.addEventListener('click', () => {
            summaryArea.classList.add('hidden');
            modeSelectionArea.classList.remove('hidden');
            topicSelectionArea.classList.remove('hidden');
        });

        // æ›´æ›ä¸»é¡Œ
        changeTopicBtn.addEventListener('click', () => {
            selectedTopics = [];
            document.querySelectorAll('.topic-card').forEach(card => {
                card.classList.remove('selected');
            });
            modeSelectionArea.classList.add('hidden');
            topicSelectionArea.classList.remove('hidden');
            questionArea.classList.add('hidden');
            statsArea.classList.add('hidden');
        });

        changeTopicBtn2.addEventListener('click', () => {
            selectedTopics = [];
            document.querySelectorAll('.topic-card').forEach(card => {
                card.classList.remove('selected');
            });
            summaryArea.classList.add('hidden');
            topicSelectionArea.classList.remove('hidden');
        });

        // å·¥å…·å‡½æ•¸ï¼šæ´—ç‰Œ
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        init();
    </script>
</body>
</html>

